<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è‹±æ–‡æœ—è¯» + ä¸­è‹±åŒæ­¥ï¼ˆOpenAI / APIMart / æµè§ˆå™¨ï¼‰</title>
  <style>
    :root{
      --c:#2563eb;
      --b:#0ea5e9;
      --bg:#f8fafc;
      --txt:#0f172a;
      --muted:#64748b;
      --card:#ffffff;
      --border:#e5e7eb;
      --shadow:0 2px 6px rgba(15,23,42,.08);
      --chip-bg:#eff6ff;
      --chip-txt:#1d4ed8;
      --chip-bd:#bfdbfe;
      --danger:#b91c1c;
    }
    body.dark{
      --bg:#020617;
      --txt:#e5e7eb;
      --muted:#9ca3af;
      --card:#020617;
      --border:#1f2937;
      --shadow:0 2px 16px rgba(0,0,0,.45);
      --chip-bg:#0b1120;
      --chip-txt:#93c5fd;
      --chip-bd:#1d4ed8;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--txt);
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:20px 16px 40px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:16px;
    }
    h1{
      font-size:20px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    h1 span.icon{
      font-size:22px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--chip-bd);
      background:var(--chip-bg);
      color:var(--chip-txt);
      font-size:11px;
    }
    .btn{
      border-radius:999px;
      border:1px solid var(--border);
      padding:6px 10px;
      font-size:13px;
      background:var(--card);
      color:var(--txt);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .btn.primary{
      background:var(--c);
      color:#fff;
      border-color:var(--c);
    }
    .btn.danger{
      border-color:var(--danger);
      color:var(--danger);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }
    .btn.sm{
      padding:4px 8px;
      font-size:12px;
    }
    .card{
      background:var(--card);
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:14px 16px;
      margin-bottom:14px;
    }
    label{
      font-size:13px;
      font-weight:600;
    }
    input[type="text"],
    input[type="password"],
    textarea,
    select{
      width:100%;
      border-radius:10px;
      border:1px solid var(--border);
      padding:8px 10px;
      margin-top:6px;
      font-size:13px;
      background:transparent;
      color:var(--txt);
    }
    textarea{min-height:140px;resize:vertical}
    .subtext{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .row > *{flex:1 1 0}
    .row-tight{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .timer-card{
      padding:10px 14px;
    }
    .timer-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
    }
    .timer-title{
      font-size:13px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .timer-main{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .timer-kpi{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--chip-bd);
      background:var(--chip-bg);
      color:var(--chip-txt);
      font-size:11px;
      display:inline-flex;
      align-items:baseline;
      gap:6px;
    }
    .timer-kpi .num{font-weight:800}
    .timer-detail{
      margin-top:8px;
      display:none;
      font-size:12px;
    }
    .timer-detail.open{display:block}
    .timer-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:8px;
    }
    .timer-box{
      border-radius:12px;
      border:1px solid var(--border);
      padding:6px 8px;
    }
    .timer-label{
      font-size:11px;
      color:var(--muted);
      margin-bottom:2px;
    }
    .switch{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .switch input{accent-color:var(--c)}
    .range-row{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:13px;
      margin-top:6px;
    }
    input[type="range"]{flex:1}
    .badge{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
    }
    .controls-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }
    .controls-row .btn{flex:0 0 auto}
    .status{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
    }
    .status.error{color:var(--danger)}
    .two-cols{
      display:grid;
      grid-template-columns:2fr 2fr;
      gap:0;
      border-radius:18px;
      overflow:hidden;
      border:1px solid var(--border);
      margin-top:4px;
    }
    .col-left,.col-right{
      max-height:360px;
      overflow:auto;
    }
    .sentence-row{
      display:flex;
      flex-direction:column;
      padding:8px 10px;
      border-bottom:1px solid var(--border);
      cursor:pointer;
      transition:background .15s;
      font-size:14px;
    }
    .sentence-row:last-child{border-bottom:none}
    .sentence-row:hover{
      background:rgba(37,99,235,.04);
    }
    body.dark .sentence-row:hover{
      background:rgba(148,163,184,.15);
    }
    .sentence-row.active{
      background:rgba(37,99,235,.12);
    }
    .sentence-row.zh.active{
      background:rgba(16,185,129,.14);
    }
    .ipa{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .zh-text{
      font-size:14px;
    }
    .small-note{
      font-size:11px;
      color:var(--muted);
      margin-top:2px;
    }
    .top-badges{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .provider-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
      align-items:center;
    }
    .provider-row select{
      width:auto;
      min-width:150px;
    }
    @media(max-width:720px){
      .two-cols{grid-template-columns:1fr}
      .col-left,.col-right{max-height:unset}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>
          <span class="icon">ğŸ§</span>
          <span>è‹±æ–‡æœ—è¯» + ä¸­è‹±åŒæ­¥ï¼ˆOpenAI / APIMart / æµè§ˆå™¨ï¼‰</span>
        </h1>
        <div class="top-badges">
          <span class="pill">æ”¯æŒå¥å¯¹é½æœ—è¯»ã€æ‡’åŠ è½½ç¿»è¯‘å’ŒéŸ³æ ‡ï¼Œå°½é‡èŠ‚çœ API é¢åº¦ã€‚</span>
        </div>
      </div>
      <div class="row-tight">
        <button id="themeBtn" class="btn sm" title="åˆ‡æ¢æµ…è‰² / æ·±è‰²">ğŸŒ™ æ·±è‰²</button>
      </div>
    </header>

    <!-- å­¦ä¹ æ—¶é•¿ -->
    <div class="card timer-card">
      <div class="timer-top">
        <div class="timer-title">
          â± å­¦ä¹ æ—¶é•¿
        </div>
        <div class="row-tight">
          <button id="timerToggle" class="btn sm primary">æš‚åœ</button>
          <button id="timerDetailBtn" class="btn sm">è¯¦æƒ…</button>
        </div>
      </div>
      <div class="timer-main">
        <div class="timer-kpi">
          <span>æœ¬æ¬¡</span>
          <span id="kSession" class="num">00:00:00</span>
        </div>
        <div class="timer-kpi">
          <span>æ€»è®¡</span>
          <span id="kTotal" class="num">0å°æ—¶0åˆ†é’Ÿ</span>
        </div>
        <span id="timerHint" class="small-note">
          ä»…åœ¨é¡µé¢å‰å°ä¸”è®¡æ—¶ä¸ºâ€œå¼€å§‹â€æ—¶ç´¯ç§¯ï¼›æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨ localStorageã€‚
        </span>
      </div>
      <div id="timerDetail" class="timer-detail">
        <div class="timer-grid" style="margin-top:6px">
          <div class="timer-box">
            <div class="timer-label">ä»Šå¤©</div>
            <div id="kDay">0åˆ†é’Ÿ</div>
          </div>
          <div class="timer-box">
            <div class="timer-label">æœ¬å‘¨ï¼ˆå‘¨ä¸€-å‘¨æ—¥ï¼‰</div>
            <div id="kWeek">0åˆ†é’Ÿ</div>
          </div>
          <div class="timer-box">
            <div class="timer-label">æœ¬æœˆ</div>
            <div id="kMonth">0åˆ†é’Ÿ</div>
          </div>
          <div class="timer-box">
            <div class="timer-label">ä»Šå¹´</div>
            <div id="kYear">0åˆ†é’Ÿ</div>
          </div>
        </div>
      </div>
    </div>

    <!-- API Key & æœåŠ¡å•† -->
    <div class="card">
      <label for="apiKey">API Keyï¼ˆç”¨äºç¿»è¯‘ / éŸ³æ ‡ / OpenAI & APIMart TTSï¼‰</label>
      <input id="apiKey" type="password" placeholder="sk-...ï¼ˆä»…æœ¬åœ°ä¿å­˜ï¼Œå¯å¡« OpenAI æˆ– APIMart çš„ Keyï¼‰" />
      <div class="subtext">
        è¯´æ˜ï¼šåªåœ¨éœ€è¦ç¿»è¯‘ã€éŸ³æ ‡æˆ–ä½¿ç”¨ OpenAI / APIMart è¯­éŸ³ TTS æ—¶æ‰ä¼šç”¨åˆ°ã€‚
      </div>
      <div class="provider-row">
        <span class="badge">æœåŠ¡å•†ï¼š</span>
        <select id="provider">
          <option value="apimart">APIMart ä»£ç†ï¼ˆæ¨èçœé’±ï¼‰</option>
          <option value="openai">OpenAI å®˜æ–¹</option>
        </select>
        <button id="saveApi" class="btn sm">ä¿å­˜åˆ°æœ¬åœ°</button>
      </div>
      <div id="saveHint" class="subtext" style="display:none;margin-top:4px">å·²ä¿å­˜åˆ° localStorage âœ“</div>
    </div>

    <!-- è¾“å…¥ -->
    <div class="card">
      <label for="inputEn">è‹±æ–‡å†…å®¹ï¼ˆç²˜è´´æˆ–ä¸Šä¼  .docxï¼‰</label>
      <textarea id="inputEn" placeholder="Paste your English text here, or upload a .docx fileâ€¦"></textarea>
      <div class="row" style="margin-top:8px;align-items:center">
        <div class="row-tight">
          <input type="file" id="docx" accept=".docx" />
          <span id="charCount" class="badge">0 chars</span>
        </div>
        <div class="row-tight">
          <label class="switch">
            <input id="autoTranslate" type="checkbox" checked />
            <span>è‡ªåŠ¨ç¿»è¯‘ä¸­æ–‡ï¼ˆæ‡’åŠ è½½ï¼Œæ¯å¥åªç¿»ä¸€æ¬¡ï¼‰</span>
          </label>
          <label class="switch">
            <input id="autoIpa" type="checkbox" checked />
            <span>æ˜¾ç¤ºç¾å¼éŸ³æ ‡ï¼ˆæ‡’åŠ è½½ï¼Œæ¯å¥åªç”Ÿæˆä¸€æ¬¡ï¼‰</span>
          </label>
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <div class="row-tight">
          <span>æœ—è¯»å¼•æ“ï¼š</span>
          <select id="engine" style="width:auto;min-width:210px">
            <option value="api">OpenAI / APIMart TTSï¼ˆé€å¥æ‡’åŠ è½½ + ç¼“å­˜ï¼Œçœé’±ï¼‰</option>
            <option value="browser">æµè§ˆå™¨ TTSï¼ˆå…è´¹ï¼Œä¸å é¢åº¦ï¼‰</option>
          </select>
          <span>å£°éŸ³ï¼š</span>
          <select id="voiceGender" style="width:auto;min-width:120px">
            <option value="female">å¥³å£°</option>
            <option value="male">ç”·å£°</option>
          </select>
          <label class="switch">
            <input id="loopCurrent" type="checkbox" />
            <span>å¾ªç¯å½“å‰å¥</span>
          </label>
        </div>
        <div class="range-row">
          <span>é€Ÿåº¦ï¼š</span>
          <span id="rateVal">1.00x</span>
          <input id="rate" type="range" min="0.7" max="1.3" step="0.05" value="1.0" />
        </div>
      </div>

      <div class="controls-row">
        <button id="splitBtn" class="btn primary">æ‹†å¥ï¼ˆä¸ç«‹å³ç¿»è¯‘ï¼‰</button>
        <button id="playFromCurrent" class="btn">ä»å½“å‰å¥å¼€å§‹æœ—è¯»</button>
        <button id="playBrowserWhole" class="btn">ç›´æ¥æœ—è¯»æ•´æ®µï¼ˆæµè§ˆå™¨ï¼‰</button>
        <button id="testHello" class="btn">æµ‹è¯•æœ—è¯»ï¼ˆHelloï¼‰</button>
        <button id="stopBtn" class="btn">åœæ­¢æœ—è¯»</button>
      </div>
      <div class="controls-row">
        <span class="small-note">æç¤ºï¼šå¥å­è¶ŠçŸ­ï¼Œå¯¹é½å’Œ TTS æ•ˆæœè¶Šå¥½ï¼Œå»ºè®®ä¸€è¡Œä¸€å¥ã€‚</span>
      </div>
      <div id="status" class="status"></div>
    </div>

    <!-- æ˜¾ç¤ºåŒº -->
    <div class="card">
      <div class="two-cols">
        <div id="enCol" class="col-left"></div>
        <div id="zhCol" class="col-right"></div>
      </div>
      <div id="diag" class="status" style="margin-top:6px"></div>
    </div>
  </div>

  <audio id="player"></audio>
  <script src="https://unpkg.com/mammoth@1.7.0/mammoth.browser.min.js"></script>
  <script>
    "use strict";
    const $ = id => document.getElementById(id);

    // ==== ä¸»é¢˜ ====
    const THEME_KEY = "reader:theme";
    function applyTheme(theme){
      document.body.classList.toggle("dark", theme === "dark");
      $("themeBtn").textContent = theme === "dark" ? "â˜€ï¸ æµ…è‰²" : "ğŸŒ™ æ·±è‰²";
      try{ localStorage.setItem(THEME_KEY, theme); }catch(e){}
    }
    (function initTheme(){
      let saved;
      try{ saved = localStorage.getItem(THEME_KEY); }catch(e){}
      const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      applyTheme(saved || (prefersDark ? "dark" : "light"));
    })();
    $("themeBtn").addEventListener("click",()=>{
      const now = document.body.classList.contains("dark") ? "dark" : "light";
      applyTheme(now === "dark" ? "light" : "dark");
    });

    // ==== å­¦ä¹ è®¡æ—¶ ====
    const TIME_KEY = "reader:secsByDay";
    let daily = {};
    try{
      const raw = localStorage.getItem(TIME_KEY);
      daily = raw ? JSON.parse(raw) : {};
    }catch(e){ daily = {}; }

    let sessionSeconds = 0;
    let running = true;
    let visible = document.visibilityState === "visible";

    function todayStr(d=new Date()){
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    }
    function cloneDate(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
    function startOfWeek(d){
      const x=cloneDate(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); return x;
    }
    function endOfWeek(d){ const x=startOfWeek(d); x.setDate(x.getDate()+6); return x; }
    function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
    function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
    function startOfYear(d){ return new Date(d.getFullYear(),0,1); }
    function endOfYear(d){ return new Date(d.getFullYear(),11,31); }

    function sumRange(start,end){
      const s=cloneDate(start), e=cloneDate(end);
      let cur = new Date(s), total = 0;
      while(cur <= e){
        const key = todayStr(cur);
        total += daily[key] || 0;
        cur.setDate(cur.getDate()+1);
      }
      return total;
    }
    function totalAll(){
      return Object.values(daily).reduce((a,b)=>a + (b||0),0);
    }
    function fmtHMS(sec){
      sec = Math.max(0, Math.floor(sec));
      const h=Math.floor(sec/3600);
      const m=Math.floor((sec%3600)/60);
      const s=sec%60;
      return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }
    function fmtHM(sec){
      sec = Math.max(0, Math.floor(sec));
      const h=Math.floor(sec/3600);
      const m=Math.floor((sec%3600)/60);
      return `${h}å°æ—¶${m}åˆ†é’Ÿ`;
    }
    function minutesStr(sec){
      const m=Math.round(sec/60);
      return `${m}åˆ†é’Ÿ`;
    }
    function renderTimer(){
      const now = new Date();
      $("kSession").textContent = fmtHMS(sessionSeconds);
      $("kTotal").textContent = fmtHM(totalAll());
      $("kDay").textContent = minutesStr(daily[todayStr(now)] || 0);
      $("kWeek").textContent = minutesStr(sumRange(startOfWeek(now), endOfWeek(now)));
      $("kMonth").textContent = minutesStr(sumRange(startOfMonth(now), endOfMonth(now)));
      $("kYear").textContent = minutesStr(sumRange(startOfYear(now), endOfYear(now)));
      $("timerToggle").textContent = running ? "æš‚åœ" : "å¼€å§‹";
      $("timerHint").textContent = running
        ? "è®¡æ—¶è¿›è¡Œä¸­ï¼šä»…åœ¨é¡µé¢å‰å°æ—¶ç´¯ç§¯ï¼›æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨ localStorageã€‚"
        : "è®¡æ—¶å·²æš‚åœï¼šç‚¹å‡»â€œå¼€å§‹â€æ¢å¤è®¡æ—¶ã€‚";
    }
    function tick(){
      if(!running || !visible) return;
      sessionSeconds += 1;
      const key = todayStr(new Date());
      daily[key] = (daily[key] || 0) + 1;
      if(sessionSeconds % 5 === 0){
        try{ localStorage.setItem(TIME_KEY, JSON.stringify(daily)); }catch(e){}
      }
      renderTimer();
    }
    setInterval(tick,1000);
    renderTimer();

    $("timerToggle").addEventListener("click",()=>{
      running = !running;
      renderTimer();
    });
    $("timerDetailBtn").addEventListener("click",()=>{
      const box = $("timerDetail");
      const open = !box.classList.contains("open");
      box.classList.toggle("open", open);
      $("timerDetailBtn").textContent = open ? "æ”¶èµ·" : "è¯¦æƒ…";
    });
    document.addEventListener("visibilitychange",()=>{
      visible = document.visibilityState === "visible";
    });

    // ==== API Key & Provider ====
    const API_KEY_STORAGE = "reader:apiKey";
    const PROVIDER_STORAGE = "reader:provider";

    const apiKeyInput = $("apiKey");
    const providerSelect = $("provider");
    (function loadApi(){
      try{
        const k = localStorage.getItem(API_KEY_STORAGE);
        if(k) apiKeyInput.value = k;
        const p = localStorage.getItem(PROVIDER_STORAGE);
        if(p) providerSelect.value = p;
      }catch(e){}
    })();
    $("saveApi").addEventListener("click",()=>{
      try{
        const key = apiKeyInput.value.trim().replace(/^["']|["']$/g,"");
        localStorage.setItem(API_KEY_STORAGE,key);
        localStorage.setItem(PROVIDER_STORAGE, providerSelect.value);
        apiKeyInput.value = key;
        const hint = $("saveHint");
        hint.style.display = "block";
        hint.textContent = "å·²ä¿å­˜åˆ° localStorage âœ“";
        setTimeout(()=>{hint.style.display="none";},1600);
      }catch(e){
        alert("æ— æ³•ä¿å­˜åˆ° localStorageï¼Œå¯èƒ½æµè§ˆå™¨å¤„äºæ— ç—•æˆ–ç¦ç”¨å­˜å‚¨æ¨¡å¼ã€‚");
      }
    });

    // ==== å·¥å…· ====
    const inputEn = $("inputEn");
    const charCount = $("charCount");
    function updateCharCount(){
      charCount.textContent = (inputEn.value || "").length + " chars";
    }
    ["input","change","keyup","paste"].forEach(ev=>inputEn.addEventListener(ev,updateCharCount));
    updateCharCount();

    $("rate").addEventListener("input",()=>{
      $("rateVal").textContent = Number($("rate").value).toFixed(2) + "x";
    });

    function setStatus(msg,isError=false){
      const el = $("status");
      el.textContent = msg || "";
      el.classList.toggle("error", !!isError);
    }
    function setDiag(msg,isError=false){
      const el = $("diag");
      el.textContent = msg || "";
      el.classList.toggle("error", !!isError);
    }

    const providerBase = ()=> providerSelect.value === "apimart"
      ? "https://api.apimart.net"
      : "https://api.openai.com";

    function getApiKeyOrWarn(){
      const key = apiKeyInput.value.trim();
      if(!key){
        alert("è¯·å…ˆå¡«å†™ API Keyï¼ˆå¯ç”¨ OpenAI æˆ– APIMart çš„ Keyï¼‰ï¼Œå†é‡è¯•ã€‚");
        return null;
      }
      return key;
    }

    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

    // ==== æ‹†å¥ ====
    let EN = [];
    let meta = []; // æ¯å¥çš„ {zh, ipa, loading, error}
    let currentIndex = 0;

    const enCol = $("enCol");
    const zhCol = $("zhCol");

    function splitLines(txt){
      const raw = (txt || "").replace(/\r\n/g,"\n");
      return raw.split("\n").map(s=>s.trim()).filter(Boolean);
    }

    function renderSentences(){
      enCol.innerHTML = "";
      zhCol.innerHTML = "";
      EN.forEach((s,i)=>{
        const d = document.createElement("div");
        d.className = "sentence-row en";
        if(i === currentIndex) d.classList.add("active");
        d.dataset.idx = i;
        d.innerHTML = `
          <div>${s}</div>
          <div class="ipa">${meta[i].ipa || ""}</div>
        `;
        d.addEventListener("click",()=>onSentenceClick(i));
        enCol.appendChild(d);

        const z = document.createElement("div");
        z.className = "sentence-row zh";
        if(i === currentIndex) z.classList.add("active");
        z.dataset.idx = i;
        z.innerHTML = `<div class="zh-text">${meta[i].zh || ""}</div>`;
        z.addEventListener("click",()=>onSentenceClick(i));
        zhCol.appendChild(z);
      });
    }

    function highlight(i){
      currentIndex = i;
      [...enCol.children].forEach((el,idx)=>el.classList.toggle("active",idx===i));
      [...zhCol.children].forEach((el,idx)=>el.classList.toggle("active",idx===i));
      const left = enCol.children[i];
      const right = zhCol.children[i];
      left && left.scrollIntoView({behavior:"smooth",block:"center"});
      right && right.scrollIntoView({behavior:"smooth",block:"center"});
    }

    // ==== æ‡’åŠ è½½ç¿»è¯‘ + éŸ³æ ‡ ====
    async function ensureSentenceData(i){
      const needZh = $("autoTranslate").checked && !meta[i].zh && !meta[i].loading;
      const needIpa = $("autoIpa").checked && !meta[i].ipa && !meta[i].loading;
      if(!needZh && !needIpa) return;
      const key = getApiKeyOrWarn();
      if(!key) return;
      meta[i].loading = true;
      setStatus("æ­£åœ¨ç”Ÿæˆè¯¥å¥çš„ç¿»è¯‘ä¸éŸ³æ ‡ï¼ˆåªä¼šç”Ÿæˆä¸€æ¬¡ï¼‰â€¦");
      try{
        const base = providerBase();
        const res = await fetch(base + "/v1/chat/completions",{
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":"Bearer "+key
          },
          body:JSON.stringify({
            model:"gpt-4o-mini",
            messages:[
              {role:"system",content:"You are an assistant that converts English sentences into Simplified Chinese and American English IPA. Respond ONLY with pure JSON like {\"zh\":\"â€¦â€¦\",\"ipa\":\"â€¦â€¦\"}."},
              {role:"user",content:EN[i]}
            ],
            temperature:0.2
          })
        });
        if(!res.ok){
          const t = await res.text();
          throw new Error("HTTP "+res.status+" "+t);
        }
        const data = await res.json();
        let text = data.choices?.[0]?.message?.content || "";
        let jsonStr;
        const s = text.indexOf("{");
        const e = text.lastIndexOf("}");
        if(s !== -1 && e !== -1 && e>s){
          jsonStr = text.slice(s,e+1);
        }else{
          jsonStr = text;
        }
        let obj = {};
        try{ obj = JSON.parse(jsonStr); }catch(e2){
          // å…œåº•ï¼šå°è¯•ç®€å•åˆ†è¡Œ
          const lines = text.split("\n").map(x=>x.trim()).filter(Boolean);
          obj.zh = lines[0] || "";
          obj.ipa = lines[1] || "";
        }
        if(obj.zh && $("autoTranslate").checked) meta[i].zh = String(obj.zh);
        if(obj.ipa && $("autoIpa").checked) meta[i].ipa = String(obj.ipa);
      }catch(err){
        console.error(err);
        meta[i].error = true;
        setDiag("ç¿»è¯‘ / éŸ³æ ‡ç”Ÿæˆå¤±è´¥ï¼š"+err.message,true);
      }finally{
        meta[i].loading = false;
        setStatus("");
        renderSentences();
      }
    }

    // ==== TTS ====
    const player = $("player");
    let isSpeaking = false;
    let seqMode = false;
    const ttsCache = new Map(); // key: provider|voice|text -> objectURL

    function getVoiceId(){
      const gender = $("voiceGender").value;
      // ç®€å•æ˜ å°„ï¼šç”·å£° -> alloyï¼Œ å¥³å£° -> verse
      return gender === "male" ? "alloy" : "verse";
    }

    function stopAllAudio(){
      isSpeaking = false;
      seqMode = false;
      try{ speechSynthesis.cancel(); }catch(e){}
      try{ player.pause(); }catch(e){}
    }

    async function speakBrowser(text){
      if(!window.speechSynthesis){
        alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæµè§ˆå™¨æœ—è¯»ï¼ˆspeechSynthesisï¼‰ã€‚");
        return;
      }
      stopAllAudio();
      isSpeaking = true;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-US";
      u.rate = Number($("rate").value) || 1.0;
      u.onend = ()=>{ isSpeaking = false; };
      u.onerror = ()=>{ isSpeaking = false; };
      speechSynthesis.speak(u);
      return new Promise(res=>{
        u.onend = ()=>{ isSpeaking=false; res(); };
        u.onerror = ()=>{ isSpeaking=false; res(); };
      });
    }

    async function speakApi(text){
      const key = getApiKeyOrWarn();
      if(!key) return;
      const base = providerBase();
      const voice = getVoiceId();
      const cacheKey = providerSelect.value + "|" + voice + "|" + text;
      let url = ttsCache.get(cacheKey);
      if(!url){
        setStatus("æ­£åœ¨ç”Ÿæˆè¯­éŸ³ï¼ˆåªä¼šä¸ºè¯¥å¥ç”Ÿæˆä¸€æ¬¡ï¼‰â€¦");
        try{
          const res = await fetch(base + "/v1/audio/speech",{
            method:"POST",
            headers:{
              "Content-Type":"application/json",
              "Authorization":"Bearer "+key
            },
            body:JSON.stringify({
              model:"gpt-4o-mini-tts",
              voice,
              input:text,
              format:"mp3"
            })
          });
          if(!res.ok){
            const t = await res.text();
            throw new Error("HTTP "+res.status+" "+t);
          }
          const buf = await res.arrayBuffer();
          url = URL.createObjectURL(new Blob([buf],{type:"audio/mpeg"}));
          ttsCache.set(cacheKey,url);
        }catch(err){
          console.error(err);
          setStatus("TTS å‡ºé”™ï¼š"+err.message,true);
          return;
        }finally{
          setStatus("");
        }
      }
      return new Promise((resolve)=>{
        isSpeaking = true;
        player.src = url;
        player.playbackRate = Number($("rate").value) || 1.0;
        player.onended = ()=>{ resolve(); };
        player.onerror = ()=>{ resolve(); };
        player.play().catch(e=>{
          console.error(e);
          resolve();
        });
      });
    }

    async function speakSentenceOnce(i){
      if(!EN[i]) return;
      highlight(i);
      await ensureSentenceData(i);
      const engine = $("engine").value;
      if(engine === "browser"){
        await speakBrowser(EN[i]);
      }else{
        await speakApi(EN[i]);
      }
    }

    // å•å¥ç‚¹å‡»
    async function onSentenceClick(i){
      highlight(i);
      const loop = $("loopCurrent").checked;
      if(loop){
        stopAllAudio();
        isSpeaking = true;
        while(isSpeaking && $("loopCurrent").checked && currentIndex === i){
          await speakSentenceOnce(i);
          if(!isSpeaking) break;
          await sleep(350);
        }
      }else{
        stopAllAudio();
        await speakSentenceOnce(i);
      }
    }

    // ä»å½“å‰å¥å¼€å§‹æœ—è¯»åˆ°æœ«å°¾
    async function speakFromCurrent(){
      if(!EN.length){
        alert("è¯·å…ˆç²˜è´´è‹±æ–‡å†…å®¹å¹¶ç‚¹å‡»â€œæ‹†å¥â€ã€‚");
        return;
      }
      stopAllAudio();
      isSpeaking = true;
      seqMode = true;
      for(let i=currentIndex;i<EN.length && isSpeaking;i++){
        await speakSentenceOnce(i);
        if(!isSpeaking) break;
        currentIndex = i+1;
        await sleep(450); // å¥é—´åœé¡¿
      }
      isSpeaking = false;
      seqMode = false;
    }

    // ==== äº‹ä»¶ ====
    $("splitBtn").addEventListener("click",()=>{
      const txt = inputEn.value.trim();
      if(!txt){
        alert("è¯·å…ˆç²˜è´´è‹±æ–‡å†…å®¹ã€‚");
        return;
      }
      EN = splitLines(txt);
      if(!EN.length){
        alert("æ²¡æœ‰æ‹†å‡ºæœ‰æ•ˆå¥å­ï¼Œè¯·æ£€æŸ¥æ–‡æœ¬ã€‚");
        return;
      }
      meta = EN.map(()=>({zh:"",ipa:"",loading:false,error:false}));
      currentIndex = 0;
      renderSentences();
      highlight(0);
      setDiag("å·²æ‹†å¥æˆåŠŸï¼šç¿»è¯‘å’ŒéŸ³æ ‡å°†æŒ‰éœ€æ‡’åŠ è½½ã€‚",false);
    });

    $("playFromCurrent").addEventListener("click",()=>{ speakFromCurrent(); });

    $("playBrowserWhole").addEventListener("click",()=>{
      const txt = inputEn.value.trim();
      if(!txt){
        alert("è¯·å…ˆç²˜è´´è‹±æ–‡å†…å®¹ã€‚");
        return;
      }
      speakBrowser(txt);
    });

    $("testHello").addEventListener("click",()=>{
      speakBrowser("Hello! This is a test from your browser.");
    });

    $("stopBtn").addEventListener("click",()=>{
      stopAllAudio();
    });

    // docx ä¸Šä¼ 
    $("docx").addEventListener("change",async e=>{
      const f=e.target.files?.[0];
      if(!f) return;
      try{
        const buf = await f.arrayBuffer();
        const {value} = await window.mammoth.extractRawText({arrayBuffer:buf});
        inputEn.value = value.trim();
        updateCharCount();
        setDiag("å·²ä» docx è¯»å–æ–‡æœ¬ï¼Œè¯·ç‚¹å‡»â€œæ‹†å¥â€ç»§ç»­ã€‚");
      }catch(err){
        console.error(err);
        alert("è¯»å– docx å¤±è´¥ï¼š"+err.message);
      }
    });

    // åˆå§‹æç¤º
    setDiag("æ­¥éª¤å»ºè®®ï¼š1ï¼‰ç²˜è´´æˆ–ä¸Šä¼ è‹±æ–‡ â†’ 2ï¼‰ç‚¹å‡»â€œæ‹†å¥â€ â†’ 3ï¼‰å•å¥ç‚¹å‡»æœ—è¯»æˆ–â€œä»å½“å‰å¥å¼€å§‹æœ—è¯»â€ã€‚");
  </script>
</body>
</html>
