<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è‹±æ–‡æœ—è¯» + ä¸­è‹±åŒæ­¥ï¼ˆOpenAI / APIMart / æµè§ˆå™¨ï¼‰</title>
  <style>
    :root{
      --c:#2563eb;--c-soft:#eff6ff;
      --bg:#f8fafc;--bg-soft:#ffffff;
      --txt:#0f172a;--muted:#64748b;
      --border:#e5e7eb;--shadow:0 2px 6px rgba(15,23,42,.05);
      --row-hover:#eff6ff;
      --row-active:#dbeafe;
      --zh-bg:#ecfdf5;
    }
    .dark{
      --bg:#020617;--bg-soft:#020617;
      --txt:#e5e7eb;--muted:#9ca3af;
      --border:#1f2937;--shadow:0 2px 10px rgba(0,0,0,.45);
      --row-hover:#0b1120;
      --row-active:#1d4ed8;
      --zh-bg:#022c22;
    }
    *{box-sizing:border-box;}
    html,body{height:100%;margin:0;padding:0;}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
      background:var(--bg);
      color:var(--txt);
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:16px 12px 40px;
    }
    h1{
      margin:0 0 8px;
      font-size:20px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    h1 span.icon{font-size:22px;}
    .card{
      background:var(--bg-soft);
      border-radius:16px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:14px 16px;
      margin-top:12px;
    }
    label{font-size:13px;font-weight:600;display:block;margin-bottom:6px;}
    input[type="text"],input[type="password"],textarea,select{
      width:100%;
      border-radius:10px;
      border:1px solid var(--border);
      padding:8px 10px;
      font-size:13px;
      background:transparent;
      color:inherit;
    }
    textarea{min-height:150px;resize:vertical;}
    small{color:var(--muted);font-size:12px;}
    .flex{display:flex;align-items:center;}
    .between{justify-content:space-between;}
    .gap8{gap:8px;}
    .gap6{gap:6px;}
    .gap12{gap:12px;}
    .btn{
      border-radius:999px;
      border:none;
      padding:6px 14px;
      font-size:13px;
      cursor:pointer;
      background:var(--c);
      color:#fff;
      white-space:nowrap;
    }
    .btn.secondary{
      background:transparent;
      border:1px solid var(--border);
      color:var(--txt);
    }
    .btn.sm{padding:4px 10px;font-size:12px;}
    .btn:disabled{opacity:.6;cursor:not-allowed;}
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:4px;
    }
    .toggle-theme{
      border-radius:999px;
      border:1px solid var(--border);
      background:transparent;
      font-size:12px;
      padding:4px 10px;
      cursor:pointer;
    }
    .timer-summary{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:var(--bg-soft);
      border:1px solid var(--border);
    }
    .timer-summary strong{font-weight:700;}
    .timer-summary button{
      border-radius:999px;
      border:1px solid var(--border);
      background:transparent;
      font-size:12px;
      padding:2px 8px;
      cursor:pointer;
    }
    .timer-grid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
      margin-top:8px;
    }
    .timer-box{
      border-radius:12px;
      border:1px solid var(--border);
      padding:8px 10px;
      font-size:12px;
    }
    .timer-box .label{color:var(--muted);font-size:11px;margin-bottom:4px;}
    .timer-box .value{font-size:13px;font-weight:600;}
    .timer-detail-toggle{
      font-size:12px;
      color:var(--c);
      cursor:pointer;
    }
    .row{display:flex;gap:8px;flex-wrap:wrap;}
    .row>div{flex:1 1 0;}
    .slider{
      width:220px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      background:var(--c-soft);
      color:#1d4ed8;
    }
    .mt8{margin-top:8px;}
    .mt4{margin-top:4px;}
    .mt12{margin-top:12px;}
    .mb4{margin-bottom:4px;}
    .sent-container{
      max-height:360px;
      overflow:auto;
      border-radius:14px;
      border:1px solid var(--border);
      margin-top:10px;
    }
    .sent-row{
      display:grid;
      grid-template-columns:minmax(0,45%) minmax(0,35%) minmax(0,20%);
      padding:8px 10px;
      font-size:13px;
      border-bottom:1px solid var(--border);
      cursor:pointer;
      background:transparent;
      transition:background .15s;
    }
    .sent-row:last-child{border-bottom:none;}
    .sent-row:hover{background:var(--row-hover);}
    .sent-row.active{background:var(--row-active);color:#111827;}
    .sent-row .zh{background:var(--zh-bg);border-radius:8px;padding:2px 6px;display:inline-block;}
    .sent-row .ipa{font-size:11px;color:var(--muted);margin-top:2px;}
    .diag{
      font-size:12px;
      color:#b91c1c;
      margin-top:6px;
      white-space:pre-wrap;
    }
    .ok{color:#059669;}
    .checkbox-inline{
      display:flex;
      align-items:center;
      gap:4px;
      font-size:12px;
      white-space:nowrap;
    }
    @media (max-width:800px){
      .sent-row{
        grid-template-columns:1fr;
        row-gap:4px;
      }
      .slider{width:150px;}
      .timer-grid{grid-template-columns:repeat(2,1fr);}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <h1><span class="icon">ğŸ§</span>è‹±æ–‡æœ—è¯» + ä¸­è‹±åŒæ­¥ï¼ˆOpenAI / APIMart / æµè§ˆå™¨ï¼‰</h1>
      <div style="font-size:12px;color:var(--muted);">æ”¯æŒæŒ‰è¡Œç²¾å‡†æ‹†å¥ã€æ‡’åŠ è½½ç¿»è¯‘å’ŒéŸ³æ ‡ï¼Œå°½é‡èŠ‚çœ API é¢åº¦ã€‚</div>
    </div>
    <div class="flex gap8">
      <button id="themeBtn" class="toggle-theme">ğŸŒ™ æ·±è‰²</button>
    </div>
  </div>

  <!-- å­¦ä¹ æ—¶é•¿ -->
  <div class="card" id="timerCard">
    <div class="flex between">
      <div class="timer-summary">
        <span>æœ¬æ¬¡ï¼š<strong id="sessionTime">00:00:00</strong></span>
        <span>æ€»è®¡ï¼š<strong id="totalTime">0å°æ—¶0åˆ†é’Ÿ</strong></span>
        <button id="timerToggle">å¼€å§‹</button>
        <button id="timerDetailBtn">è¯¦æƒ…</button>
      </div>
      <div style="font-size:11px;color:var(--muted);text-align:right;">
        è¯´æ˜ï¼šä»…åœ¨é¡µé¢å‰å°ä¸”è®¡æ—¶çŠ¶æ€ä¸ºã€Œå¼€å§‹ã€æ—¶ç´¯è®¡ï¼›æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨ localStorageã€‚
      </div>
    </div>
    <div id="timerDetail" class="mt8" style="display:none;">
      <div class="timer-grid">
        <div class="timer-box">
          <div class="label">ä»Šå¤©</div>
          <div class="value" id="tDay">0åˆ†é’Ÿ</div>
        </div>
        <div class="timer-box">
          <div class="label">æœ¬å‘¨</div>
          <div class="value" id="tWeek">0åˆ†é’Ÿ</div>
        </div>
        <div class="timer-box">
          <div class="label">æœ¬æœˆ</div>
          <div class="value" id="tMonth">0åˆ†é’Ÿ</div>
        </div>
        <div class="timer-box">
          <div class="label">ä»Šå¹´</div>
          <div class="value" id="tYear">0åˆ†é’Ÿ</div>
        </div>
      </div>
    </div>
  </div>

  <!-- API Key & æœåŠ¡å•† -->
  <div class="card">
    <label for="apiKey">API Keyï¼ˆç”¨äºç¿»è¯‘ / éŸ³æ ‡ / OpenAI TTSï¼‰</label>
    <input id="apiKey" type="password" placeholder="sk-...ï¼ˆOpenAI å®˜æ–¹ Key æˆ– APIMart çš„ä»£ç† Keyï¼‰" />
    <div class="mt4 flex between">
      <small>è¯´æ˜ï¼šåªåœ¨éœ€è¦ç¿»è¯‘ã€éŸ³æ ‡æˆ– OpenAI / APIMart TTS æ—¶æ‰ä¼šç”¨åˆ°ï¼Œæµè§ˆå™¨æœ—è¯»å®Œå…¨å…è´¹ã€‚</small>
      <button id="saveKeyBtn" class="btn secondary sm">ä¿å­˜åˆ°æœ¬åœ°</button>
    </div>
    <div class="mt8 row">
      <div>
        <label>æœåŠ¡å•†ï¼š</label>
        <select id="providerSelect">
          <option value="apimart">APIMart ä»£ç†ï¼ˆæ¨èçœé’±ï¼‰</option>
          <option value="openai">OpenAI å®˜æ–¹</option>
        </select>
      </div>
      <div>
        <label>Key å­˜å‚¨ï¼š</label>
        <select id="keyStoreSelect">
          <option value="local">ä¿å­˜åˆ°æœ¬åœ°</option>
          <option value="none">ä»…å½“å‰é¡µé¢</option>
        </select>
      </div>
    </div>
    <div id="saveHint" class="mt4" style="display:none;font-size:12px;color:#16a34a;">å·²ä¿å­˜åˆ° localStorage âœ“</div>
  </div>

  <!-- æ–‡æœ¬è¾“å…¥ -->
  <div class="card">
    <label>è‹±æ–‡å†…å®¹ï¼ˆç²˜è´´æˆ–ä¸Šä¼  .docxï¼Œä¸€è¡Œä¸€å¥ï¼‰</label>
    <textarea id="inputEn" placeholder="å»ºè®®ä¸€è¡Œä¸€å¥ï¼Œä¾‹å¦‚ï¼š&#10;I want a cup of coffee.&#10;I want some coffee."></textarea>
    <div class="mt4 flex between">
      <div class="flex gap8">
        <input type="file" id="docxInput" accept=".docx" />
        <span class="pill"><span id="charCount">0</span> chars</span>
      </div>
      <div class="flex gap12">
        <label class="checkbox-inline">
          <input id="autoTransChk" type="checkbox" checked />
          <span>è‡ªåŠ¨ç¿»è¯‘ä¸­æ–‡ï¼ˆæ‡’åŠ è½½ï¼Œæ¯å¥åªç¿»è¯‘ä¸€æ¬¡ï¼‰</span>
        </label>
        <label class="checkbox-inline">
          <input id="autoIpaChk" type="checkbox" checked />
          <span>æ˜¾ç¤ºç¾å¼éŸ³æ ‡ï¼ˆæ‡’åŠ è½½ï¼Œæ¯å¥åªç”Ÿæˆä¸€æ¬¡ï¼‰</span>
        </label>
      </div>
    </div>
  </div>

  <!-- æ§åˆ¶åŒº -->
  <div class="card">
    <div class="row">
      <div>
        <label>æœ—è¯»å¼•æ“ï¼š</label>
        <select id="engineSelect">
          <option value="api">OpenAI / APIMart TTSï¼ˆé€å¥æ‡’åŠ è½½+ç¼“å­˜ï¼Œçœé’±ï¼‰</option>
          <option value="browser">æµè§ˆå™¨æœ—è¯»ï¼ˆå…è´¹ï¼‰</option>
        </select>
      </div>
      <div>
        <label>å£°éŸ³ï¼š</label>
        <select id="voiceGender">
          <option value="male">ç”·å£°</option>
          <option value="female" selected>å¥³å£°</option>
        </select>
      </div>
    </div>
    <div class="mt8 flex between">
      <div class="flex gap8">
        <label>é€Ÿåº¦ï¼š<span id="rateLabel">1.00x</span></label>
        <input id="rateRange" class="slider" type="range" min="0.6" max="1.4" step="0.05" value="1.0" />
      </div>
      <div class="flex gap8">
        <button id="splitBtn" class="btn">æ‹†å¥ï¼ˆä¸ç«‹å³ç¿»è¯‘ï¼‰</button>
        <button id="playFromCurrentBtn" class="btn secondary">ä»å½“å‰å¥å¼€å§‹æœ—è¯»</button>
        <button id="quickBrowserBtn" class="btn secondary">ç›´æ¥ç”¨æµè§ˆå™¨æ•´æ®µæœ—è¯»</button>
        <button id="testBtn" class="btn secondary">æµ‹è¯•æœ—è¯»ï¼ˆHelloï¼‰</button>
        <button id="stopBtn" class="btn secondary">åœæ­¢æœ—è¯»</button>
      </div>
    </div>
    <div id="diag" class="diag"></div>
  </div>

  <!-- å¥å­åˆ—è¡¨ -->
  <div class="card">
    <div class="sent-container" id="sentContainer"></div>
  </div>
</div>

<audio id="audioPlayer"></audio>

<script src="https://unpkg.com/mammoth@1.7.0/mammoth.browser.min.js"></script>
<script>
(function(){
  const $ = id => document.getElementById(id);

  const apiKeyInput      = $("apiKey");
  const providerSelect   = $("providerSelect");
  const keyStoreSelect   = $("keyStoreSelect");
  const saveKeyBtn       = $("saveKeyBtn");
  const saveHint         = $("saveHint");

  const inputEn          = $("inputEn");
  const docxInput        = $("docxInput");
  const charCount        = $("charCount");

  const autoTransChk     = $("autoTransChk");
  const autoIpaChk       = $("autoIpaChk");

  const engineSelect     = $("engineSelect");
  const voiceGender      = $("voiceGender");
  const rateRange        = $("rateRange");
  const rateLabel        = $("rateLabel");

  const splitBtn         = $("splitBtn");
  const playFromCurrentBtn = $("playFromCurrentBtn");
  const quickBrowserBtn  = $("quickBrowserBtn");
  const testBtn          = $("testBtn");
  const stopBtn          = $("stopBtn");

  const sentContainer    = $("sentContainer");
  const diag             = $("diag");
  const audioPlayer      = $("audioPlayer");

  const themeBtn         = $("themeBtn");

  const sessionTimeEl    = $("sessionTime");
  const totalTimeEl      = $("totalTime");
  const timerToggle      = $("timerToggle");
  const timerDetailBtn   = $("timerDetailBtn");
  const timerDetailBox   = $("timerDetail");
  const tDayEl           = $("tDay");
  const tWeekEl          = $("tWeek");
  const tMonthEl         = $("tMonth");
  const tYearEl          = $("tYear");

  // ---- çŠ¶æ€ ----
  let EN = [];
  let ZH = [];
  let IPA = [];
  let currentIndex = 0;

  let isPlayingSequence = false;
  const pauseBetweenSentences = 400; // ms

  const transCache = new Map(); // key: en text
  const ipaCache   = new Map(); // key: en text
  const ttsCache   = new Map(); // key: provider|engine|voice|text => blobUrl

  // ----- å·¥å…·å‡½æ•° -----
  function showDiag(msg, ok=false){
    if(!msg){diag.textContent="";diag.style.display="none";return;}
    diag.textContent = msg;
    diag.style.display = "block";
    diag.className = "diag"+(ok?" ok":"");
  }

  function updateCharCount(){
    charCount.textContent = (inputEn.value||"").length;
  }

  function splitLines(raw){
    return raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  }

  function saveSettings(){
    try{
      if(keyStoreSelect.value === "local"){
        localStorage.setItem("ttsReader:apiKey", apiKeyInput.value.trim());
      }else{
        localStorage.removeItem("ttsReader:apiKey");
      }
      localStorage.setItem("ttsReader:provider", providerSelect.value);
      localStorage.setItem("ttsReader:keyStore", keyStoreSelect.value);
      localStorage.setItem("ttsReader:engine", engineSelect.value);
      localStorage.setItem("ttsReader:voiceGender", voiceGender.value);
      saveHint.style.display = "block";
      saveHint.textContent = "å·²ä¿å­˜åˆ°æœ¬åœ° âœ“";
      setTimeout(()=>{saveHint.style.display="none";},1500);
    }catch(e){
      console.warn("ä¿å­˜å¤±è´¥",e);
    }
  }

  function loadSettings(){
    try{
      const kStore = localStorage.getItem("ttsReader:keyStore");
      if(kStore) keyStoreSelect.value = kStore;
      const k = localStorage.getItem("ttsReader:apiKey");
      if(k && keyStoreSelect.value==="local") apiKeyInput.value = k;
      const provider = localStorage.getItem("ttsReader:provider");
      if(provider) providerSelect.value = provider;
      const eng = localStorage.getItem("ttsReader:engine");
      if(eng) engineSelect.value = eng;
      const vg = localStorage.getItem("ttsReader:voiceGender");
      if(vg) voiceGender.value = vg;
    }catch(e){}
  }

  // ---- ä¸»é¢˜ ----
  function applyTheme(theme){
    document.body.classList.toggle("dark", theme==="dark");
    themeBtn.textContent = theme==="dark" ? "â˜€ï¸ æµ…è‰²" : "ğŸŒ™ æ·±è‰²";
    localStorage.setItem("ttsReader:theme", theme);
  }
  (function initTheme(){
    const saved = localStorage.getItem("ttsReader:theme");
    const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    applyTheme(saved || (prefersDark ? "dark" : "light"));
  })();
  themeBtn.addEventListener("click", ()=>{
    const now = document.body.classList.contains("dark") ? "dark" : "light";
    applyTheme(now==="dark" ? "light" : "dark");
  });

  // ---- æ–‡æœ¬ & docx ----
  docxInput.addEventListener("change", async e=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      const buf = await file.arrayBuffer();
      const result = await window.mammoth.extractRawText({arrayBuffer:buf});
      inputEn.value = (result.value||"").trim();
      updateCharCount();
    }catch(err){
      alert("è¯»å– docx å¤±è´¥ï¼š" + err.message);
    }
  });
  ["input","change","keyup","paste"].forEach(ev=>{
    inputEn.addEventListener(ev, updateCharCount);
  });
  updateCharCount();

  // ---- æœ—è¯»ç›¸å…³ ----
  function ensureVoicesLoaded(timeout=2000){
    return new Promise(resolve=>{
      const voices = window.speechSynthesis?.getVoices?.() || [];
      if(voices.length>0) return resolve(voices);
      const id = setInterval(()=>{
        const vs = window.speechSynthesis.getVoices();
        if(vs.length>0){clearInterval(id);resolve(vs);}
      },100);
      setTimeout(()=>{
        clearInterval(id);
        resolve(window.speechSynthesis.getVoices()||[]);
      }, timeout);
    });
  }

  async function getBrowserVoice(){
    const voices = await ensureVoicesLoaded();
    const enVoices = voices.filter(v=>/^en[-_]/i.test(v.lang||"") || /English/i.test(v.name));
    if(enVoices.length===0) return null;
    const gender = voiceGender.value;
    const keyword = gender==="female" ? /female|woman|girl/i : /male|man|boy/i;
    const found = enVoices.find(v=>keyword.test(v.name)||keyword.test(v.voiceURI));
    return found || enVoices[0];
  }

  function getApiConfig(){
    const key = apiKeyInput.value.trim();
    if(!key) throw new Error("è¯·å…ˆå¡«å†™ API Key");
    const provider = providerSelect.value; // apimart | openai
    const base = provider === "apimart" ? "https://api.apimart.ai/v1" : "https://api.openai.com/v1";
    return {key, provider, base};
  }

  async function callChatApi(messages){
    const {key, base} = getApiConfig();
    const body = {
      model:"gpt-4o-mini",
      messages,
      temperature:0
    };
    const res = await fetch(base + "/chat/completions",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer " + key
      },
      body:JSON.stringify(body)
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error("æ¥å£è¿”å›é”™è¯¯ï¼š" + txt);
    }
    const data = await res.json();
    const content = data.choices?.[0]?.message?.content || "";
    return content.trim();
  }

  async function translateSentence(index){
    const en = EN[index];
    if(!en) return "";
    if(transCache.has(en)) return transCache.get(en);

    const sys = {role:"system",content:"ä½ æ˜¯ä¸€ä¸ªä¼˜ç§€çš„ä¸­è‹±ç¿»è¯‘åŠ©æ‰‹ã€‚è¯·æŠŠç»™å®šçš„è‹±æ–‡å¥å­ç¿»è¯‘æˆç®€ä½“ä¸­æ–‡ï¼Œåªè¾“å‡ºç¿»è¯‘ç»“æœæœ¬èº«ã€‚"};
    const usr = {role:"user",content:en};
    const out = await callChatApi([sys,usr]);
    transCache.set(en,out);
    return out;
  }

  async function ipaSentence(index){
    const en = EN[index];
    if(!en) return "";
    if(ipaCache.has(en)) return ipaCache.get(en);
    const sys = {role:"system",content:"You are an assistant that outputs American English IPA. For the given English sentence, output ONLY the IPA transcription without slashes and without explanation."};
    const usr = {role:"user",content:en};
    const out = await callChatApi([sys,usr]);
    ipaCache.set(en,out);
    return out;
  }

  async function ensureData(index){
    try{
      if(autoTransChk.checked && !ZH[index]){
        const zh = await translateSentence(index);
        ZH[index] = zh;
        renderRow(index);
      }
      if(autoIpaChk.checked && !IPA[index]){
        const ipa = await ipaSentence(index);
        IPA[index] = ipa;
        renderRow(index);
      }
    }catch(e){
      console.error(e);
      showDiag("ç¿»è¯‘ / éŸ³æ ‡ç”Ÿæˆå¤±è´¥ï¼š" + e.message);
    }
  }

  function getTtsKey(text){
    const cfg = providerSelect.value + "|" + engineSelect.value + "|" + voiceGender.value;
    return cfg + "|" + text;
  }

  async function getApiTtsUrl(text){
    const key = getTtsKey(text);
    if(ttsCache.has(key)) return ttsCache.get(key);

    const {key:apiKey, base} = getApiConfig();
    const gender = voiceGender.value;
    // è¿™é‡Œçš„ voice åç§°å¯ä»¥æ ¹æ®ä½ åœ¨ APIMart / OpenAI é‚£è¾¹å®é™…å¼€é€šçš„å£°éŸ³åšè°ƒæ•´
    const voice = gender==="female" ? "alloy" : "alloy"; // å¦‚æœä½ çš„ä»£ç†æ”¯æŒå…¶å®ƒ voiceï¼Œå¯ä»¥æ”¹æˆä¸åŒçš„
    const body = {
      model:"gpt-4o-mini-tts",
      voice,
      input:text,
      format:"mp3"
    };
    const res = await fetch(base + "/audio/speech",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer " + apiKey
      },
      body:JSON.stringify(body)
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error("TTS è¾“å‡ºé”™è¯¯ï¼š" + txt);
    }
    const buf = await res.arrayBuffer();
    const blob = new Blob([buf],{type:"audio/mpeg"});
    const url = URL.createObjectURL(blob);
    ttsCache.set(key,url);
    return url;
  }

  async function playApiTts(text){
    const url = await getApiTtsUrl(text);
    return new Promise((resolve,reject)=>{
      audioPlayer.src = url;
      audioPlayer.playbackRate = parseFloat(rateRange.value)||1.0;
      audioPlayer.onended = ()=>resolve();
      audioPlayer.onerror = (e)=>reject(e);
      audioPlayer.play().catch(reject);
    });
  }

  async function playBrowserTts(text){
    const voice = await getBrowserVoice();
    if(!voice){
      alert("æœªæ‰¾åˆ°è‹±è¯­è¯­éŸ³ï¼Œå°†ä½¿ç”¨æµè§ˆå™¨é»˜è®¤è¯­éŸ³ã€‚");
    }
    return new Promise((resolve)=>{
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = voice?.lang || "en-US";
      if(voice) u.voice = voice;
      u.rate = parseFloat(rateRange.value)||1.0;
      u.onend = ()=>resolve();
      u.onerror = ()=>resolve();
      window.speechSynthesis.speak(u);
    });
  }

  async function speakSentence(index){
    const text = EN[index];
    if(!text) return;
    await ensureData(index);
    highlightRow(index);
    const engine = engineSelect.value;
    if(engine === "browser"){
      await playBrowserTts(text);
    }else{
      await playApiTts(text);
    }
  }

  async function speakSingle(index){
    isPlayingSequence = false;
    await speakSentence(index);
  }

  async function speakFromIndex(start){
    if(start<0 || start>=EN.length) return;
    isPlayingSequence = true;
    showDiag("");
    for(let i=start;i<EN.length;i++){
      if(!isPlayingSequence) break;
      await speakSentence(i);
      await new Promise(r=>setTimeout(r,pauseBetweenSentences));
    }
    isPlayingSequence = false;
  }

  function stopAll(){
    isPlayingSequence = false;
    try{ window.speechSynthesis?.cancel?.(); }catch(e){}
    try{ audioPlayer.pause(); }catch(e){}
  }

  // ---- æ¸²æŸ“å¥å­åˆ—è¡¨ ----
  function renderAll(){
    sentContainer.innerHTML = "";
    const n = EN.length;
    for(let i=0;i<n;i++){
      const row = document.createElement("div");
      row.className = "sent-row";
      row.dataset.index = i;

      const enSpan = document.createElement("div");
      enSpan.textContent = EN[i];

      const zhSpan = document.createElement("div");
      const zh = ZH[i] || "";
      if(zh){
        const wrap = document.createElement("span");
        wrap.className = "zh";
        wrap.textContent = zh;
        zhSpan.appendChild(wrap);
      }

      const ipaSpan = document.createElement("div");
      const ipa = IPA[i] || "";
      if(ipa){
        const wrap = document.createElement("div");
        wrap.className = "ipa";
        wrap.textContent = "/" + ipa + "/";
        ipaSpan.appendChild(wrap);
      }

      row.appendChild(enSpan);
      row.appendChild(zhSpan);
      row.appendChild(ipaSpan);

      row.addEventListener("click", async ()=>{
        currentIndex = i;
        await speakSingle(i);
      });

      sentContainer.appendChild(row);
    }
    highlightRow(currentIndex);
  }

  function renderRow(i){
    const row = sentContainer.querySelector(`.sent-row[data-index="${i}"]`);
    if(!row) return;
    row.innerHTML = "";
    const enSpan = document.createElement("div");
    enSpan.textContent = EN[i];
    const zhSpan = document.createElement("div");
    const zh = ZH[i] || "";
    if(zh){
      const wrap = document.createElement("span");
      wrap.className = "zh";
      wrap.textContent = zh;
      zhSpan.appendChild(wrap);
    }
    const ipaSpan = document.createElement("div");
    const ipa = IPA[i] || "";
    if(ipa){
      const wrap = document.createElement("div");
      wrap.className = "ipa";
      wrap.textContent = "/" + ipa + "/";
      ipaSpan.appendChild(wrap);
    }
    row.appendChild(enSpan);
    row.appendChild(zhSpan);
    row.appendChild(ipaSpan);
  }

  function highlightRow(idx){
    currentIndex = idx;
    const rows = sentContainer.querySelectorAll(".sent-row");
    rows.forEach(r=>{
      const i = Number(r.dataset.index||0);
      if(i===idx) r.classList.add("active");
      else r.classList.remove("active");
    });
    const active = sentContainer.querySelector(".sent-row.active");
    if(active){
      const rect = active.getBoundingClientRect();
      const parentRect = sentContainer.getBoundingClientRect();
      if(rect.top < parentRect.top || rect.bottom > parentRect.bottom){
        active.scrollIntoView({behavior:"smooth",block:"center"});
      }
    }
  }

  // ---- æŒ‰é’®äº‹ä»¶ ----
  splitBtn.addEventListener("click", ()=>{
    const raw = inputEn.value.trim();
    if(!raw){
      alert("è¯·å…ˆç²˜è´´è‹±æ–‡å†…å®¹ï¼ˆå»ºè®®ä¸€è¡Œä¸€å¥ï¼‰");
      return;
    }
    EN = splitLines(raw);
    ZH = new Array(EN.length).fill("");
    IPA = new Array(EN.length).fill("");
    showDiag("å·²æ‹†å¥å®Œæˆï¼Œå…± " + EN.length + " å¥ï¼ˆç¿»è¯‘å’ŒéŸ³æ ‡ä¼šåœ¨éœ€è¦æ—¶æ‡’åŠ è½½ï¼‰", true);
    currentIndex = 0;
    renderAll();
  });

  playFromCurrentBtn.addEventListener("click", ()=>{
    if(!EN.length){
      alert("è¯·å…ˆâ€œæ‹†å¥â€");
      return;
    }
    speakFromIndex(currentIndex);
  });

  quickBrowserBtn.addEventListener("click", async ()=>{
    const text = inputEn.value.trim();
    if(!text){alert("è¯·å…ˆè¾“å…¥è‹±æ–‡å†…å®¹");return;}
    stopAll();
    engineSelect.value = "browser";
    await playBrowserTts(text);
  });

  testBtn.addEventListener("click", async ()=>{
    stopAll();
    showDiag("");
    const engine = engineSelect.value;
    try{
      if(engine==="browser"){
        await playBrowserTts("Hello, this is a browser speech test.");
      }else{
        await playApiTts("Hello, this is a test from OpenAI or APIMart.");
      }
    }catch(e){
      console.error(e);
      showDiag("æµ‹è¯•æœ—è¯»å¤±è´¥ï¼š" + e.message);
    }
  });

  stopBtn.addEventListener("click", stopAll);

  rateRange.addEventListener("input", ()=>{
    rateLabel.textContent = Number(rateRange.value).toFixed(2) + "x";
  });

  saveKeyBtn.addEventListener("click", saveSettings);
  providerSelect.addEventListener("change", saveSettings);
  keyStoreSelect.addEventListener("change", saveSettings);
  engineSelect.addEventListener("change", saveSettings);
  voiceGender.addEventListener("change", saveSettings);

  // ---- è®¡æ—¶å™¨ ----
  const LS_TIMER_KEY = "ttsReader:timerDaily";
  let dailyMap = {};
  let sessionSeconds = 0;
  let timerRunning = false;
  let lastTick = Date.now();
  let timerHandle = null;

  function loadTimer(){
    try{
      const raw = localStorage.getItem(LS_TIMER_KEY);
      if(raw) dailyMap = JSON.parse(raw)||{};
    }catch(e){}
  }
  function saveTimer(){
    try{
      localStorage.setItem(LS_TIMER_KEY, JSON.stringify(dailyMap));
    }catch(e){}
  }
  function todayStr(d=new Date()){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const d2=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${d2}`;
  }
  function fmtHMS(sec){
    sec = Math.max(0,Math.floor(sec));
    const h=Math.floor(sec/3600);
    const m=Math.floor((sec%3600)/60);
    const s=sec%60;
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }
  function fmtHM(sec){
    sec = Math.max(0,Math.floor(sec));
    const h=Math.floor(sec/3600);
    const m=Math.floor((sec%3600)/60);
    return `${h}å°æ—¶${m}åˆ†é’Ÿ`;
  }
  function minutesStr(sec){
    const m=Math.round(sec/60);
    return `${m}åˆ†é’Ÿ`;
  }
  function sumRange(start,end){
    const s = new Date(start.getFullYear(),start.getMonth(),start.getDate());
    const e = new Date(end.getFullYear(),end.getMonth(),end.getDate());
    let cur = new Date(s);
    let total = 0;
    while(cur<=e){
      const key = todayStr(cur);
      total += dailyMap[key]||0;
      cur.setDate(cur.getDate()+1);
    }
    return total;
  }
  function startOfWeek(d){
    const x = new Date(d);
    const day = (x.getDay()+6)%7; // å‘¨ä¸€=0
    x.setDate(x.getDate()-day);
    x.setHours(0,0,0,0);
    return x;
  }
  function endOfWeek(d){
    const s = startOfWeek(d);
    const e = new Date(s);
    e.setDate(s.getDate()+6);
    e.setHours(23,59,59,999);
    return e;
  }
  function startOfMonth(d){return new Date(d.getFullYear(),d.getMonth(),1);}
  function endOfMonth(d){return new Date(d.getFullYear(),d.getMonth()+1,0);}
  function startOfYear(d){return new Date(d.getFullYear(),0,1);}
  function endOfYear(d){return new Date(d.getFullYear(),11,31);}

  function renderTimer(){
    sessionTimeEl.textContent = fmtHMS(sessionSeconds);
    const now = new Date();
    const today = todayStr(now);
    const totalSec = Object.values(dailyMap).reduce((a,b)=>a+(b||0),0);
    totalTimeEl.textContent = fmtHM(totalSec);

    tDayEl.textContent   = minutesStr(dailyMap[today]||0);
    tWeekEl.textContent  = minutesStr(sumRange(startOfWeek(now), endOfWeek(now)));
    tMonthEl.textContent = minutesStr(sumRange(startOfMonth(now), endOfMonth(now)));
    tYearEl.textContent  = minutesStr(sumRange(startOfYear(now), endOfYear(now)));
    timerToggle.textContent = timerRunning ? "æš‚åœ" : "å¼€å§‹";
  }

  function tickTimer(){
    if(!timerRunning) return;
    const now = Date.now();
    const diff = Math.floor((now - lastTick)/1000);
    if(diff<=0){requestAnimationFrame(tickTimer);return;}
    lastTick = now;
    sessionSeconds += diff;
    const today = todayStr(new Date());
    dailyMap[today] = (dailyMap[today]||0) + diff;
    renderTimer();
    saveTimer();
    requestAnimationFrame(tickTimer);
  }

  timerToggle.addEventListener("click", ()=>{
    timerRunning = !timerRunning;
    lastTick = Date.now();
    if(timerRunning && !timerHandle){
      requestAnimationFrame(tickTimer);
    }
    renderTimer();
  });
  timerDetailBtn.addEventListener("click", ()=>{
    const s = timerDetailBox.style.display==="none";
    timerDetailBox.style.display = s ? "block" : "none";
  });
  document.addEventListener("visibilitychange",()=>{
    if(document.visibilityState==="hidden"){
      // ä¿å®ˆï¼šæš‚åœè®¡æ—¶ï¼Œé¿å…åå°è¯¯è®¡
      timerRunning = false;
      renderTimer();
    }
  });

  // ---- åˆå§‹åŒ– ----
  loadSettings();
  loadTimer();
  renderTimer();
  // å¦‚æœç”¨æˆ·ä¹‹å‰æœ‰ keyï¼Œé»˜è®¤å¸®ä»–å¼€è®¡æ—¶
  if(apiKeyInput.value.trim()){
    timerRunning = true;
    lastTick = Date.now();
    requestAnimationFrame(tickTimer);
    renderTimer();
  }

})();
</script>
</body>
</html>
