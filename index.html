<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI è‹±æ–‡æœ—è¯» + è‡ªåŠ¨ç¿»è¯‘</title>
  <style>
    body { font-family: "Segoe UI", sans-serif; background:#f8fafc; color:#1e293b; margin:0; padding:2rem; max-width:900px; margin-inline:auto; }
    h1 { color:#2563eb; }
    textarea, input, select { width:100%; font-size:1rem; padding:.5rem; margin:.5rem 0; border-radius:8px; border:1px solid #cbd5e1; }
    button { background:#2563eb; color:#fff; border:none; padding:.6rem 1.2rem; border-radius:8px; cursor:pointer; font-size:1rem; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .section { background:#fff; border-radius:16px; padding:1.5rem; margin-bottom:1.5rem; box-shadow:0 2px 4px rgba(0,0,0,.08); }
    audio { width:100%; margin-top:1rem; }
    label { font-weight:600; }
    .row { display:flex; gap:12px; align-items:center; }
  </style>
</head>
<body>
  <h1>ğŸ§ AI è‹±æ–‡æœ—è¯» + è‡ªåŠ¨ç¿»è¯‘</h1>

  <div class="section">
    <label>1ï¸âƒ£ è¾“å…¥ä½ çš„ OpenAI API Keyï¼ˆä¸æƒ³ç”¨é¢åº¦å¯è·³è¿‡å¹¶å¼€å¯â€œå…è´¹æœ—è¯»â€ï¼‰ï¼š</label>
    <input type="password" id="apiKey" placeholder="sk-xxxxxxxxxxxxxxxx" />
    <small>ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼›æ— éœ€åˆ™ç•™ç©ºï¼Œæ”¹ç”¨å…è´¹æœ—è¯»ã€‚</small>
  </div>

  <div class="section">
    <label>2ï¸âƒ£ ç²˜è´´è‹±æ–‡æˆ–ä¸Šä¼  .docx æ–‡ä»¶ï¼š</label>
    <textarea id="textInput" rows="8" placeholder="ç²˜è´´ä½ çš„è‹±æ–‡å†…å®¹..."></textarea>
    <input type="file" id="fileInput" accept=".docx" />
  </div>

  <div class="section">
    <div class="row">
      <label style="min-width:120px;">3ï¸âƒ£ é€‰æ‹©å£°éŸ³ï¼š</label>
      <select id="voiceSelect">
        <option value="alloy">Alloyï¼ˆæ¸©æš–è‡ªç„¶ï¼‰</option>
        <option value="luna">Lunaï¼ˆæŸ”å’Œå¥³å£°ï¼‰</option>
        <option value="verse">Verseï¼ˆèŠ‚å¥é²œæ˜ï¼‰</option>
        <option value="shimmer">Shimmerï¼ˆè½»å¿«å¹´è½»ï¼‰</option>
        <option value="coral">Coralï¼ˆä½æ²‰ç¨³é‡ï¼‰</option>
      </select>
    </div>

    <div class="row">
      <label><input type="checkbox" id="translate" checked /> è‡ªåŠ¨ç¿»è¯‘æˆä¸­æ–‡</label>
    </div>

    <div class="row">
      <label><input type="checkbox" id="useFree" /> ä½¿ç”¨æµè§ˆå™¨å…è´¹æœ—è¯»ï¼ˆä¸æ¶ˆè€—é¢åº¦ï¼‰</label>
    </div>

    <br />
    <button id="generateBtn">ç”Ÿæˆè¯­éŸ³ / å¼€å§‹æœ—è¯»</button>
  </div>

  <div class="section">
    <h3>ğŸ—£ï¸ è‹±æ–‡è¯­éŸ³æœ—è¯»ï¼š</h3>
    <audio id="audioPlayer" controls></audio>
    <div id="status"></div>
  </div>

  <div class="section">
    <h3>ğŸŒ ä¸­æ–‡ç¿»è¯‘ï¼š</h3>
    <textarea id="translationOutput" rows="8" readonly></textarea>
  </div>

  <script src="https://unpkg.com/mammoth@1.7.0/mammoth.browser.min.js"></script>
  <script>
    // å…ƒç´ 
    const apiKeyInput = document.getElementById("apiKey");
    const textInput = document.getElementById("textInput");
    const fileInput = document.getElementById("fileInput");
    const voiceSelect = document.getElementById("voiceSelect");
    const translateCheck = document.getElementById("translate");
    const useFreeCheck = document.getElementById("useFree");
    const generateBtn = document.getElementById("generateBtn");
    const audioPlayer = document.getElementById("audioPlayer");
    const translationOutput = document.getElementById("translationOutput");
    const statusDiv = document.getElementById("status");

    // è®°ä½ API Keyï¼ˆæœ¬åœ°ï¼‰
    const saved = localStorage.getItem("openai_api_key");
    if (saved) apiKeyInput.value = saved;
    apiKeyInput.addEventListener("input", () => {
      if (apiKeyInput.value.trim()) {
        localStorage.setItem("openai_api_key", apiKeyInput.value.trim());
      }
    });

    // è¯»å– docx
    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const arrayBuffer = await file.arrayBuffer();
      const { value } = await window.mammoth.extractRawText({ arrayBuffer });
      textInput.value = value.trim();
    });

    // å…è´¹æœ—è¯»
    function freeSpeak(text) {
      if (!("speechSynthesis" in window)) {
        alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå†…ç½®æœ—è¯»ã€‚å»ºè®®ä½¿ç”¨ Chrome/Edge/Safariã€‚");
        return;
      }
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "en-US";
      u.rate = 1.0;
      u.pitch = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }

    // OpenAI ç¿»è¯‘
    async function translateToChinese(text, apiKey) {
      const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
          model: "gpt-4o-mini",
          messages: [
            { role: "system", content: "Translate the user's English text into natural Simplified Chinese." },
            { role: "user", content: text }
          ],
          temperature: 0.2
        }),
      });
      const data = await res.json();
      return data.choices?.[0]?.message?.content?.trim?.() ?? "";
    }

    // OpenAI è¯­éŸ³
    async function tts(text, apiKey, voice="alloy") {
      const res = await fetch("https://api.openai.com/v1/audio/speech", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
          model: "gpt-4o-mini-tts",
          voice,
          input: text,
          format: "mp3"
        }),
      });
      if (!res.ok) {
        const t = await res.text();
        try {
          const j = JSON.parse(t);
          if (j?.error?.code === "insufficient_quota" || j?.error?.type === "insufficient_quota") {
            throw new Error("é¢åº¦ä¸è¶³ï¼ˆinsufficient_quotaï¼‰ã€‚å¯åˆ‡æ¢â€œä½¿ç”¨æµè§ˆå™¨å…è´¹æœ—è¯»â€ï¼Œæˆ–åœ¨ Billing é‡Œå……å€¼/æé«˜ Monthly budgetã€‚");
          }
          throw new Error(j?.error?.message || t);
        } catch {
          throw new Error(t);
        }
      }
      const buf = await res.arrayBuffer();
      return new Blob([buf], { type: "audio/mpeg" });
    }

    // ä¸»æŒ‰é’®
    generateBtn.addEventListener("click", async () => {
      const apiKey = apiKeyInput.value.trim();
      const text = textInput.value.trim();
      if (!text) return alert("è¯·è¾“å…¥æˆ–ä¸Šä¼ è‹±æ–‡å†…å®¹ï¼");

      // ç¿»è¯‘ï¼ˆå¯é€‰ï¼‰
      try {
        if (translateCheck.checked && apiKey && !useFreeCheck.checked) {
          statusDiv.textContent = "æ­£åœ¨ç¿»è¯‘ä¸ºä¸­æ–‡â€¦";
          const zh = await translateToChinese(text, apiKey);
          translationOutput.value = zh;
        } else if (!translateCheck.checked) {
          translationOutput.value = "";
        }
      } catch (e) {
        translationOutput.value = "ç¿»è¯‘å¤±è´¥ï¼š" + (e?.message || e);
      }

      // å…è´¹æœ—è¯»æ¨¡å¼
      if (useFreeCheck.checked) {
        statusDiv.textContent = "ä½¿ç”¨æµè§ˆå™¨å†…ç½®æœ—è¯»ï¼ˆä¸æ¶ˆè€—é¢åº¦ï¼‰â€¦";
        freeSpeak(text);
        return;
      }

      // OpenAI TTS æ¨¡å¼
      if (!apiKey) return alert("è¯·å…ˆå¡«å…¥ OpenAI API Keyï¼Œæˆ–å‹¾é€‰â€œä½¿ç”¨æµè§ˆå™¨å…è´¹æœ—è¯»â€ã€‚");

      try {
        statusDiv.textContent = "æ­£åœ¨ç”Ÿæˆæœ—è¯»è¯­éŸ³â€¦";
        const blob = await tts(text, apiKey, voiceSelect.value);
        const url = URL.createObjectURL(blob);
        audioPlayer.src = url;
        statusDiv.textContent = "âœ… ç”Ÿæˆå®Œæˆï¼Œå¯ä»¥æ’­æ”¾è¯­éŸ³å•¦ï¼";
      } catch (err) {
        alert("å‡ºé”™äº†ï¼š" + (err?.message || err));
        statusDiv.textContent = "âŒ ç”Ÿæˆå¤±è´¥ã€‚ä½ å¯ä»¥å¼€å¯â€œä½¿ç”¨æµè§ˆå™¨å…è´¹æœ—è¯»â€å…ˆå¬é¢„è§ˆã€‚";
      }
    });
  </script>
</body>
</html>
