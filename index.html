<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è‹±æ–‡æœ—è¯» + ä¸­è‹±åŒæ­¥ï¼ˆOpenAI / APIMart / æµè§ˆå™¨ï¼‰</title>
  <style>
    :root{
      --c:#2563eb;--b:#0ea5e9;--g:#10b981;
      --bg:#f8fafc;--txt:#0f172a;--muted:#64748b;
      --card:#ffffff;--border:#e5e7eb;--shadow:0 2px 8px rgba(15,23,42,.05);
      --chip-bg:#eff6ff;--chip-txt:#1d4ed8;--chip-bd:#bfdbfe;
      --accent-soft:#eef2ff;--accent-bd:#a5b4fc;--accent-txt:#4338ca;
      --green-soft:#ecfdf5;--green-bd:#a7f3d0;--green-txt:#065f46;
    }
    .dark{
      --bg:#020617;--txt:#e5e7eb;--muted:#9ca3af;
      --card:#020617;--border:#1f2937;--shadow:0 2px 16px rgba(0,0,0,.6);
      --chip-bg:#0b1120;--chip-txt:#93c5fd;--chip-bd:#1d4ed8;
      --accent-soft:#0b1220;--accent-bd:#4f46e5;--accent-txt:#a5b4fc;
      --green-soft:#022c22;--green-bd:#0f766e;--green-txt:#bbf7d0;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--txt);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:20px 16px 40px}
    h1{
      font-size:22px;margin:0 0 10px;
      display:flex;align-items:center;gap:8px;
      color:var(--c);
    }
    h1 span.icon{font-size:24px}
    small{color:var(--muted)}
    .topbar{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:10px;gap:10px;flex-wrap:wrap;
    }
    .btn{
      border:none;border-radius:999px;
      background:var(--c);color:#fff;
      padding:6px 12px;font-size:13px;cursor:pointer;
      display:inline-flex;align-items:center;gap:4px;
    }
    .btn.outline{
      background:transparent;color:var(--txt);
      border:1px solid var(--border);
    }
    .btn.sm{padding:4px 10px;font-size:12px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:14px 16px;
      margin-top:10px;
      box-shadow:var(--shadow);
    }
    .grid-4{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:10px;
    }
    @media(max-width:800px){
      .grid-4{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    .stat-card{
      border-radius:14px;
      border:1px solid var(--border);
      padding:8px 10px;
      font-size:12px;
      background:var(--card);
    }
    .stat-label{color:var(--muted);margin-bottom:4px}
    .stat-value{font-weight:700;font-size:14px}
    .stat-main{
      display:flex;align-items:center;justify-content:space-between;gap:8px;
      margin-top:6px;
    }
    input,textarea,select{
      width:100%;font-size:14px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      background:transparent;
      color:inherit;
    }
    textarea{min-height:140px;resize:vertical}
    label{font-size:13px;font-weight:600;margin-bottom:4px;display:inline-block}
    .row{display:grid;gap:10px}
    .row-2{grid-template-columns:1.2fr .8fr}
    @media(max-width:900px){.row-2{grid-template-columns:1fr}}
    .flex{display:flex;align-items:center;gap:8px}
    .flex-between{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .pill{
      display:inline-flex;align-items:center;gap:4px;
      padding:3px 9px;border-radius:999px;
      border:1px solid var(--chip-bd);
      background:var(--chip-bg);color:var(--chip-txt);
      font-size:11px;
    }
    .slider{width:220px}
    .cols-wrap{
      display:grid;grid-template-columns:1fr 1fr;gap:12px;
      max-height:60vh;overflow:auto;
    }
    @media(max-width:900px){
      .cols-wrap{grid-template-columns:1fr}
    }
    .sent-row{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid transparent;
      cursor:pointer;
      transition:.15s;
    }
    .sent-row:hover{
      border-color:#cbd5e1;
      background:rgba(148,163,184,0.05);
    }
    .sent-row.active-en{
      background:var(--accent-soft);
      border-color:var(--accent-bd);
      color:var(--accent-txt);
    }
    .sent-row.active-zh{
      background:var(--green-soft);
      border-color:var(--green-bd);
      color:var(--green-txt);
    }
    .ipa{font-size:12px;color:var(--muted);margin-top:3px}
    .status{font-size:12px;color:#0f172a;margin-top:6px}
    .status.error{color:#b91c1c}
    .progress{height:6px;border-radius:999px;background:#e5e7eb;overflow:hidden;margin-top:6px}
    .bar{height:100%;width:0;background:var(--b);transition:width .15s}
    .note{font-size:12px;color:var(--muted);margin-top:4px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="flex" style="gap:6px">
      <span class="icon">ğŸ§</span>
      <h1 style="margin:0">è‹±æ–‡æœ—è¯» + ä¸­è‹±åŒæ­¥ï¼ˆOpenAI / APIMart / æµè§ˆå™¨ï¼‰</h1>
    </div>
    <div class="flex">
      <button id="themeBtn" class="btn outline sm">ğŸŒ™ æ·±è‰²</button>
    </div>
  </div>

  <!-- å­¦ä¹ æ—¶é•¿ç»Ÿè®¡ -->
  <div class="card">
    <div class="flex-between">
      <div class="flex" style="gap:6px">
        <strong>å­¦ä¹ æ—¶é•¿</strong>
        <span class="pill">
          æœ¬æ¬¡ <span id="statThis" style="font-weight:700">00:00:00</span>
        </span>
        <span class="pill">
          æ€»è®¡ <span id="statTotal" style="font-weight:700">0å°æ—¶0åˆ†é’Ÿ</span>
        </span>
      </div>
      <div class="flex" style="gap:6px">
        <button id="timerToggle" class="btn outline sm">æš‚åœ</button>
        <button id="statDetailBtn" class="btn outline sm">è¯¦æƒ…</button>
      </div>
    </div>
    <div id="statDetail" style="margin-top:10px;display:none">
      <div class="grid-4">
        <div class="stat-card">
          <div class="stat-label">ä»Šå¤©</div>
          <div class="stat-value" id="statDay">0åˆ†é’Ÿ</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æœ¬å‘¨</div>
          <div class="stat-value" id="statWeek">0åˆ†é’Ÿ</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æœ¬æœˆ</div>
          <div class="stat-value" id="statMonth">0åˆ†é’Ÿ</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ä»Šå¹´</div>
          <div class="stat-value" id="statYear">0åˆ†é’Ÿ</div>
        </div>
      </div>
      <div class="note" style="margin-top:6px">
        ä»…åœ¨é¡µé¢å‰å°ä¸”è®¡æ—¶çŠ¶æ€ä¸ºã€Œå¼€å§‹ã€æ—¶ç´¯ç§¯æ—¶é•¿ï¼›æŒ‰è‡ªç„¶æ—¥ / å‘¨ / æœˆ / å¹´ç»Ÿè®¡ï¼Œæ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨ localStorageã€‚
      </div>
    </div>
  </div>

  <!-- API Key & æœåŠ¡å•† -->
  <div class="card">
    <div class="row" style="grid-template-columns:2fr 1fr">
      <div>
        <label>API Keyï¼ˆç”¨äºç¿»è¯‘ / éŸ³æ ‡ / OpenAI TTSï¼‰</label>
        <input id="apiKey" type="password" placeholder="sk-...ï¼ˆOpenAI æˆ– APIMart çš„ Keyï¼Œä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼‰" />
      </div>
      <div>
        <label>æœåŠ¡å•†</label>
        <select id="provider">
          <option value="apimart">APIMart ä»£ç†ï¼ˆæ¨èçœé’±ï¼‰</option>
          <option value="openai">OpenAI å®˜æ–¹</option>
        </select>
      </div>
    </div>
    <div class="flex-between" style="margin-top:8px">
      <small>è¯´æ˜ï¼šåªåœ¨éœ€è¦ç¿»è¯‘ã€éŸ³æ ‡æˆ–ä½¿ç”¨ OpenAI / APIMart è¯­éŸ³æ—¶æ‰ä¼šç”¨åˆ° Keyï¼Œæµè§ˆå™¨æœ—è¯»å®Œå…¨å…è´¹ã€‚</small>
      <button id="saveKeyBtn" class="btn outline sm">ä¿å­˜åˆ°æœ¬åœ°</button>
    </div>
  </div>

  <!-- æ–‡æœ¬è¾“å…¥ -->
  <div class="card">
    <label>è‹±æ–‡å†…å®¹ï¼ˆç²˜è´´æˆ–ä¸Šä¼  .docxï¼‰</label>
    <textarea id="inputEn" placeholder="Paste your English text here..."></textarea>
    <div class="flex-between" style="margin-top:6px;flex-wrap:wrap">
      <div class="flex">
        <input id="docx" type="file" accept=".docx" />
        <span id="charCount" class="pill" style="margin-left:6px">0 chars</span>
      </div>
      <div class="flex" style="gap:14px">
        <label class="flex" style="gap:4px;font-weight:400">
          <input id="autoZh" type="checkbox" /> è‡ªåŠ¨ç¿»è¯‘ä¸­æ–‡ï¼ˆæ‡’åŠ è½½ï¼Œæ¯å¥åªç¿»ä¸€æ¬¡ï¼‰
        </label>
        <label class="flex" style="gap:4px;font-weight:400">
          <input id="autoIpa" type="checkbox" /> æ˜¾ç¤ºç¾å¼éŸ³æ ‡ï¼ˆæ‡’åŠ è½½ï¼Œæ¯å¥åªç”Ÿæˆä¸€æ¬¡ï¼‰
        </label>
      </div>
    </div>
  </div>

  <!-- æ’­æ”¾æ§åˆ¶ -->
  <div class="card">
    <div class="flex-between">
      <div class="flex" style="gap:10px;flex-wrap:wrap">
        <div class="flex">
          <label style="margin-right:6px">æœ—è¯»å¼•æ“ï¼š</label>
          <select id="engine" style="width:auto">
            <option value="browser">æµè§ˆå™¨ï¼ˆå…è´¹ï¼‰</option>
            <option value="api">OpenAI / APIMart TTSï¼ˆé€å¥æ‡’åŠ è½½ + ç¼“å­˜ï¼Œçœé’±ï¼‰</option>
          </select>
        </div>
        <div class="flex">
          <label style="margin-right:6px">é€Ÿåº¦ï¼š<span id="rateVal">1.00x</span></label>
          <input id="rate" class="slider" type="range" min="0.6" max="1.4" step="0.05" value="1.0" />
        </div>
      </div>
    </div>
    <div class="flex" style="margin-top:10px;flex-wrap:wrap;gap:8px">
      <button id="splitBtn" class="btn">æ‹†å¥ï¼ˆä¸ç«‹å³ç¿»è¯‘ï¼‰</button>
      <button id="playFromCurrent" class="btn">ä»å½“å‰å¥å¼€å§‹æœ—è¯»</button>
      <button id="quickBrowser" class="btn outline">ç›´æ¥æœ—è¯»æ•´æ®µï¼ˆæµè§ˆå™¨ï¼‰</button>
      <button id="testHello" class="btn outline">æµ‹è¯•æœ—è¯»ï¼ˆHelloï¼‰</button>
      <button id="stopBtn" class="btn outline">åœæ­¢æœ—è¯»</button>
    </div>
    <div id="status" class="status"></div>
    <div class="progress" id="progress" style="display:none">
      <div class="bar" id="bar"></div>
    </div>
  </div>

  <!-- ä¸­è‹±å¯¹ç…§ -->
  <div class="card">
    <div class="cols-wrap">
      <div id="enCol"></div>
      <div id="zhCol"></div>
    </div>
  </div>
</div>

<audio id="player"></audio>
<script src="https://unpkg.com/mammoth@1.7.0/mammoth.browser.min.js"></script>
<script>
  const $ = id => document.getElementById(id);

  const apiKeyEl = $("apiKey");
  const providerEl = $("provider");
  const saveKeyBtn = $("saveKeyBtn");

  const inputEn = $("inputEn");
  const docx = $("docx");
  const charCount = $("charCount");

  const autoZh = $("autoZh");
  const autoIpa = $("autoIpa");

  const engine = $("engine");
  const rate = $("rate");
  const rateVal = $("rateVal");

  const splitBtn = $("splitBtn");
  const playFromCurrent = $("playFromCurrent");
  const quickBrowser = $("quickBrowser");
  const testHello = $("testHello");
  const stopBtn = $("stopBtn");

  const statusEl = $("status");
  const progress = $("progress");
  const bar = $("bar");
  const player = $("player");

  const enCol = $("enCol");
  const zhCol = $("zhCol");

  const themeBtn = $("themeBtn");

  // ---- å­¦ä¹ æ—¶é•¿å…ƒç´  ----
  const statThis = $("statThis");
  const statTotal = $("statTotal");
  const statDay = $("statDay");
  const statWeek = $("statWeek");
  const statMonth = $("statMonth");
  const statYear = $("statYear");
  const statDetailBtn = $("statDetailBtn");
  const statDetail = $("statDetail");
  const timerToggle = $("timerToggle");

  const LS_KEYS = {
    KEY: "tts-app:key",
    PROVIDER: "tts-app:provider",
    THEME: "tts-app:theme",
    DAILY: "tts-app:dailySeconds"
  };

  // ==== ä¸»é¢˜ ====
  function applyTheme(theme){
    document.body.classList.toggle("dark", theme==="dark");
    themeBtn.textContent = theme==="dark" ? "â˜€ï¸ æµ…è‰²" : "ğŸŒ™ æ·±è‰²";
    localStorage.setItem(LS_KEYS.THEME, theme);
  }
  (function initTheme(){
    const saved = localStorage.getItem(LS_KEYS.THEME);
    const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    applyTheme(saved || (prefersDark ? "dark" : "light"));
  })();
  themeBtn.onclick = () => {
    const cur = document.body.classList.contains("dark") ? "dark" : "light";
    applyTheme(cur==="dark" ? "light" : "dark");
  };

  // ==== API Key / provider ====
  (function initKey(){
    try{
      apiKeyEl.value = localStorage.getItem(LS_KEYS.KEY) || "";
      providerEl.value = localStorage.getItem(LS_KEYS.PROVIDER) || "apimart";
    }catch(e){}
  })();

  saveKeyBtn.onclick = () => {
    try{
      const k = apiKeyEl.value.trim().replace(/^["']|["']$/g,"");
      const p = providerEl.value;
      localStorage.setItem(LS_KEYS.KEY, k);
      localStorage.setItem(LS_KEYS.PROVIDER, p);
      apiKeyEl.value = k;
      status("å·²ä¿å­˜ API Key & æœåŠ¡å•†åˆ°æœ¬åœ° âœ“");
    }catch(e){
      status("ä¿å­˜å¤±è´¥ï¼ˆæµè§ˆå™¨ç¦æ­¢æœ¬åœ°å­˜å‚¨ï¼‰", true);
    }
  };

  function getBaseUrl(){
    return providerEl.value === "apimart"
      ? "https://api.apimart.cn"
      : "https://api.openai.com";
  }
  function getHeaders(){
    const key = apiKeyEl.value.trim();
    if(!key) throw new Error("è¯·å…ˆå¡«å†™ API Key");
    return {
      "Content-Type":"application/json",
      "Authorization":"Bearer " + key
    };
  }

  // ==== è®¡æ—¶å™¨ & ç»Ÿè®¡ ====
  function todayStr(d=new Date()){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }
  function getMonday(d){
    const x=new Date(d);
    const day=(x.getDay()+6)%7;
    x.setHours(0,0,0,0);
    x.setDate(x.getDate()-day);
    return x;
  }
  function endOfWeek(d){
    const s=getMonday(d);
    const e=new Date(s);
    e.setDate(s.getDate()+6);
    return e;
  }
  function startOfMonth(d){return new Date(d.getFullYear(),d.getMonth(),1);}
  function endOfMonth(d){return new Date(d.getFullYear(),d.getMonth()+1,0);}
  function startOfYear(d){return new Date(d.getFullYear(),0,1);}
  function endOfYear(d){return new Date(d.getFullYear(),11,31);}
  function loadDaily(){
    try{
      const raw = localStorage.getItem(LS_KEYS.DAILY);
      if(!raw) return {};
      const obj = JSON.parse(raw);
      return obj && typeof obj==="object" ? obj : {};
    }catch(_){return {};}
  }
  function saveDaily(map){
    try{
      localStorage.setItem(LS_KEYS.DAILY, JSON.stringify(map));
    }catch(_){}
  }
  function sumRange(map,start,end){
    const s = new Date(start.getFullYear(),start.getMonth(),start.getDate());
    const e = new Date(end.getFullYear(),end.getMonth(),end.getDate());
    let cur = new Date(s);
    let total = 0;
    while(cur<=e){
      total += map[todayStr(cur)] || 0;
      cur.setDate(cur.getDate()+1);
    }
    return total;
  }
  function fmtHMS(sec){
    sec = Math.max(0,Math.floor(sec));
    const h=(sec/3600)|0;
    const m=((sec%3600)/60)|0;
    const s=sec%60;
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }
  function fmtHM(sec){
    sec = Math.max(0,Math.floor(sec));
    const h=(sec/3600)|0;
    const m=((sec%3600)/60)|0;
    return `${h}å°æ—¶${m}åˆ†é’Ÿ`;
  }
  function minutesStr(sec){
    return `${Math.round(sec/60)}åˆ†é’Ÿ`;
  }

  let daily = loadDaily();
  let sessionSeconds = 0;
  let tickTimer = null;
  let visible = document.visibilityState === "visible";
  let running = true; // æ˜¯å¦åœ¨è®¡æ—¶

  function renderStats(){
    const now = new Date();
    statThis.textContent = fmtHMS(sessionSeconds);
    const total = Object.values(daily).reduce((a,b)=>a+(+b||0),0);
    statTotal.textContent = fmtHM(total);
    statDay.textContent = minutesStr(daily[todayStr(now)]||0);
    statWeek.textContent = minutesStr(sumRange(daily,getMonday(now),endOfWeek(now)));
    statMonth.textContent = minutesStr(sumRange(daily,startOfMonth(now),endOfMonth(now)));
    statYear.textContent = minutesStr(sumRange(daily,startOfYear(now),endOfYear(now)));
  }

  function tick(){
    if(!visible || !running) return;
    sessionSeconds += 1;
    const k = todayStr(new Date());
    daily[k] = (daily[k]||0) + 1;
    if(sessionSeconds % 2 === 0) renderStats();
    if(sessionSeconds % 10 === 0) saveDaily(daily);
  }

  function startTimerLoop(){
    if(tickTimer) clearInterval(tickTimer);
    tickTimer = setInterval(tick,1000);
  }

  function setRunning(on){
    running = on;
    timerToggle.textContent = on ? "æš‚åœ" : "å¼€å§‹";
  }

  // åˆå§‹åŒ–è®¡æ—¶å™¨ï¼šé»˜è®¤å¼€å§‹
  setRunning(true);
  renderStats();
  startTimerLoop();

  document.addEventListener("visibilitychange",()=>{visible = document.visibilityState === "visible";});
  window.addEventListener("focus",()=>{visible=true;});
  window.addEventListener("blur",()=>{visible=false;});
  window.addEventListener("beforeunload",()=>saveDaily(daily));

  timerToggle.onclick = () => {
    setRunning(!running);
  };
  statDetailBtn.onclick = () => {
    const on = statDetail.style.display !== "none";
    statDetail.style.display = on ? "none" : "block";
    statDetailBtn.textContent = on ? "è¯¦æƒ…" : "æ”¶èµ·";
  };

  // ==== æ–‡æœ¬ / æ‹†å¥ ====
  function updateCharCount(){
    charCount.textContent = (inputEn.value || "").length + " chars";
  }
  ["input","change","keyup","paste"].forEach(ev=>{
    inputEn.addEventListener(ev,updateCharCount);
  });
  updateCharCount();

  docx.addEventListener("change",async e=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const buf = await f.arrayBuffer();
    const {value} = await window.mammoth.extractRawText({arrayBuffer:buf});
    inputEn.value = value.trim();
    updateCharCount();
  });

  rate.addEventListener("input",()=>{
    rateVal.textContent = Number(rate.value).toFixed(2)+"x";
  });

  // æ‹†å¥
  function splitSentences(txt){
    const cleaned = (txt||"").replace(/\s+/g," ").trim();
    if(!cleaned) return [];
    return cleaned.split(/(?<=[.!?])\s+/).filter(Boolean);
  }

  let EN = [];
  let currentIndex = 0;
  let zhCache = {};   // index -> zh
  let ipaCache = {};  // index -> ipa
  let ttsCache = {};  // index -> objectURL
  let speaking = false;

  function renderCols(){
    enCol.innerHTML = "";
    zhCol.innerHTML = "";
    EN.forEach((s,i)=>{
      const enRow = document.createElement("div");
      enRow.className = "sent-row" + (i===currentIndex ? " active-en" : "");
      enRow.dataset.idx = i;
      enRow.innerHTML = `<div>${s}</div>` + (ipaCache[i] ? `<div class="ipa">/${ipaCache[i]}/</div>`:"");
      enRow.onclick = ()=>{setActiveIndex(i);};
      enCol.appendChild(enRow);

      const zhRow = document.createElement("div");
      zhRow.className = "sent-row" + (i===currentIndex ? " active-zh" : "");
      zhRow.dataset.idx = i;
      zhRow.textContent = zhCache[i] || "";
      zhRow.onclick = ()=>{setActiveIndex(i);};
      zhCol.appendChild(zhRow);
    });
  }

  function setActiveIndex(i){
    currentIndex = i;
    [...enCol.children].forEach((el,idx)=>el.classList.toggle("active-en",idx===i));
    [...zhCol.children].forEach((el,idx)=>el.classList.toggle("active-zh",idx===i));
    const targetEn = enCol.children[i];
    const targetZh = zhCol.children[i];
    if(targetEn) targetEn.scrollIntoView({behavior:"smooth",block:"center"});
    if(targetZh) targetZh.scrollIntoView({behavior:"smooth",block:"center"});
  }

  splitBtn.onclick = ()=>{
    const txt = inputEn.value.trim();
    if(!txt){
      alert("è¯·å…ˆç²˜è´´è‹±æ–‡å†…å®¹");
      return;
    }
    EN = splitSentences(txt);
    if(!EN.length){
      alert("æ²¡æœ‰æ£€æµ‹åˆ°å®Œæ•´å¥å­ï¼ˆè¯·æ£€æŸ¥ . ? !ï¼‰");
      return;
    }
    zhCache = {};
    ipaCache = {};
    ttsCache = {};
    currentIndex = 0;
    renderCols();
    setActiveIndex(0);
    status("å·²æ‹†å¥ã€‚ç¿»è¯‘ / éŸ³æ ‡å°†åœ¨ç¬¬ä¸€æ¬¡ç‚¹å‡»æˆ–æœ—è¯»è¯¥å¥æ—¶ç”Ÿæˆã€‚");
  };

  // ==== è¯·æ±‚å°è£…ï¼ˆæ‡’åŠ è½½ç¿»è¯‘ / éŸ³æ ‡ / TTSï¼‰====
  async function callChat(model, systemPrompt, userContent){
    const body = {
      model,
      messages:[
        {role:"system",content:systemPrompt},
        {role:"user",content:userContent}
      ],
      temperature:0
    };
    const url = getBaseUrl() + "/v1/chat/completions";
    const headers = getHeaders();
    const res = await fetch(url,{
      method:"POST",
      headers,
      body:JSON.stringify(body)
    });
    if(!res.ok){
      throw new Error(await res.text());
    }
    const data = await res.json();
    return (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || "";
  }

  async function ensureZh(i){
    if(zhCache[i] || !autoZh.checked) return;
    const s = EN[i];
    if(!s) return;
    const out = await callChat(
      "gpt-4o-mini",
      "Translate this English sentence into Simplified Chinese. Output Chinese only.",
      s
    );
    zhCache[i] = out.trim();
    renderCols();
  }

  async function ensureIpa(i){
    if(ipaCache[i] || !autoIpa.checked) return;
    const s = EN[i];
    if(!s) return;
    const out = await callChat(
      "gpt-4o-mini",
      "You are a phonetics assistant. Output American English IPA transcription of the given sentence. Use pure IPA symbols without slashes, brackets or extra text.",
      s
    );
    ipaCache[i] = out.trim().replace(/^\/|\/$/g,"");
    renderCols();
  }

  async function ensureTtsUrl(i){
    if(ttsCache[i]) return ttsCache[i];
    const s = EN[i];
    if(!s) return null;
    const key = apiKeyEl.value.trim();
    if(!key){
      alert("ä½¿ç”¨ OpenAI / APIMart TTS å‰ï¼Œè¯·å…ˆå¡«å†™ API Key");
      throw new Error("no key");
    }
    const url = getBaseUrl() + "/v1/audio/speech";
    const headers = getHeaders();
    const body = {
      model:"gpt-4o-mini-tts",
      voice:"alloy",
      input:s,
      format:"mp3"
    };
    const res = await fetch(url,{
      method:"POST",
      headers,
      body:JSON.stringify(body)
    });
    if(!res.ok){
      throw new Error(await res.text());
    }
    const buf = await res.arrayBuffer();
    const blobUrl = URL.createObjectURL(new Blob([buf],{type:"audio/mpeg"}));
    ttsCache[i] = blobUrl;
    return blobUrl;
  }

  // çŠ¶æ€æ¡
  function status(msg,isError=false){
    statusEl.textContent = msg || "";
    statusEl.className = "status"+(isError?" error":"");
  }
  function setProgress(p){
    bar.style.width = p+"%";
  }
  function showProgress(v){
    progress.style.display = v ? "block" : "none";
    if(!v) setProgress(0);
  }

  // ==== æœ—è¯»é€»è¾‘ ====
  function clamp(v,min,max){return Math.min(max,Math.max(min,v));}
  function ensureVoicesLoaded(timeout=2000){
    return new Promise(resolve=>{
      const have = ()=> speechSynthesis.getVoices().length>0;
      if(have()) return resolve(true);
      const id = setInterval(()=>{
        if(have()){clearInterval(id);resolve(true);}
      },150);
      setTimeout(()=>{clearInterval(id);resolve(true);},timeout);
    });
  }

  async function speakBrowserFrom(start){
    await ensureVoicesLoaded();
    speechSynthesis.cancel();
    for(let i=start;i<EN.length;i++){
      if(!speaking) break;
      setActiveIndex(i);
      const u = new SpeechSynthesisUtterance(EN[i]);
      u.lang = "en-US";
      u.rate = clamp(parseFloat(rate.value)||1,0.6,1.4);
      await new Promise(res=>{
        u.onend = res;
        u.onerror = res;
        speechSynthesis.speak(u);
      });
    }
  }

  async function speakApiFrom(start){
    for(let i=start;i<EN.length;i++){
      if(!speaking) break;
      setActiveIndex(i);
      try{
        await Promise.all([ensureZh(i),ensureIpa(i)]);
      }catch(e){
        console.error(e);
      }
      try{
        const url = await ensureTtsUrl(i);
        if(!url) continue;
        await new Promise((resolve,reject)=>{
          player.src = url;
          player.playbackRate = clamp(parseFloat(rate.value)||1,0.6,1.4);
          player.onended = resolve;
          player.onerror = reject;
          player.play().catch(reject);
        });
      }catch(err){
        console.error(err);
        status("TTS å‡ºé”™ï¼š"+(err.message||err),true);
        break;
      }
      setProgress(((i-start+1)/(EN.length-start))*100);
    }
  }

  playFromCurrent.onclick = async ()=>{
    if(!EN.length){
      alert("è¯·å…ˆç‚¹å‡»â€œæ‹†å¥ï¼ˆä¸ç«‹å³ç¿»è¯‘ï¼‰â€");
      return;
    }
    speaking = true;
    showProgress(engine.value==="api");
    try{
      if(engine.value==="browser"){
        await speakBrowserFrom(currentIndex);
      }else{
        await speakApiFrom(currentIndex);
      }
    }finally{
      speaking = false;
      showProgress(false);
      setProgress(0);
    }
  };

  quickBrowser.onclick = async ()=>{
    const txt = inputEn.value.trim();
    if(!txt){
      alert("è¯·å…ˆç²˜è´´è‹±æ–‡å†…å®¹");
      return;
    }
    await ensureVoicesLoaded();
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(txt);
    u.lang="en-US";
    u.rate=clamp(parseFloat(rate.value)||1,0.6,1.4);
    speechSynthesis.speak(u);
  };

  testHello.onclick = async ()=>{
    await ensureVoicesLoaded();
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance("Hello, this is a test.");
    u.lang="en-US";
    u.rate=clamp(parseFloat(rate.value)||1,0.6,1.4);
    speechSynthesis.speak(u);
  };

  stopBtn.onclick = ()=>{
    speaking = false;
    speechSynthesis.cancel();
    player.pause();
    showProgress(false);
    setProgress(0);
  };

  // ç‚¹å‡»å¥å­æ—¶æ‡’åŠ è½½ç¿»è¯‘ / éŸ³æ ‡
  enCol.addEventListener("click",async e=>{
    const el = e.target.closest(".sent-row");
    if(!el) return;
    const idx = +el.dataset.idx;
    if(Number.isNaN(idx)) return;
    setActiveIndex(idx);
    try{
      await Promise.all([ensureZh(idx),ensureIpa(idx)]);
    }catch(err){
      console.error(err);
      status("ç”Ÿæˆç¿»è¯‘ / éŸ³æ ‡å‡ºé”™ï¼š"+(err.message||err),true);
    }
  });
  zhCol.addEventListener("click",async e=>{
    const el = e.target.closest(".sent-row");
    if(!el) return;
    const idx = +el.dataset.idx;
    if(Number.isNaN(idx)) return;
    setActiveIndex(idx);
    try{
      await Promise.all([ensureZh(idx),ensureIpa(idx)]);
    }catch(err){
      console.error(err);
      status("ç”Ÿæˆç¿»è¯‘ / éŸ³æ ‡å‡ºé”™ï¼š"+(err.message||err),true);
    }
  });
</script>
</body>
</html>
