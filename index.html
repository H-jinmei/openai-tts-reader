<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è‹±æ–‡æœ—è¯» + ä¸­è‹±åŒæ­¥ï¼ˆä¸‰å¼•æ“ + ç¾å¼éŸ³æ ‡ï¼‰</title>
  <style>
    :root{--c:#2563eb;--g:#10b981;--b:#0ea5e9;--bg:#f8fafc;--txt:#0f172a}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--txt);margin:0}
    .wrap{max-width:1100px;margin:auto;padding:24px}
    h1{display:flex;align-items:center;gap:10px;font-size:22px;color:var(--c)}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .row{display:grid;gap:12px}
    @media(min-width:800px){.grid-2{grid-template-columns:1fr 1fr}}
    label{font-weight:600}
    input,textarea,select{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px}
    textarea{min-height:140px}
    small{color:#64748b}
    .btn{background:var(--c);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.outline{background:#fff;color:#0f172a;border:1px solid #cbd5e1}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .flex{display:flex;align-items:center;gap:10px}
    .between{justify-content:space-between}
    .pill{display:inline-block;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;border-radius:999px;padding:3px 10px;font-size:12px}
    .cols{display:grid;gap:10px}
    @media(min-width:900px){.cols{grid-template-columns:1fr 1fr}}
    .sent{padding:10px;border:1px solid transparent;border-radius:10px;cursor:pointer}
    .sent:hover{background:#f8fafc;border-color:#e2e8f0}
    .sent.active{background:#eef2ff;border-color:#a5b4fc;font-weight:600;color:#4338ca}
    .sent-zh.active{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .ipa{font-size:12px;color:#475569;margin-top:4px}
    .progress{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .bar{height:100%;background:var(--b);width:0}
    .slider{width:220px}
    .note{font-size:12px;color:#0f766e}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ§ è‹±æ–‡æœ—è¯» + ä¸­è‹±åŒæ­¥ï¼ˆOpenAI / ElevenLabs / æµè§ˆå™¨ï¼‰</h1>

    <!-- Keys -->
    <div class="card">
      <label>OpenAI API Keyï¼ˆç”¨äºç¿»è¯‘ & ç”Ÿæˆç¾å¼éŸ³æ ‡ï¼›ä¹Ÿå¯ç”¨äº OpenAI TTSï¼‰</label>
      <div class="row">
        <input id="openaiKey" type="password" placeholder="sk-...ï¼ˆä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼‰" />
        <div class="flex between">
          <small>ä¸å¼€å¯ç¿»è¯‘/éŸ³æ ‡æˆ– OpenAI TTS æ—¶ï¼Œå¯ä»¥ä¸å¡«ã€‚æµè§ˆå™¨æœ—è¯»ä¸æ¶ˆè€—é¢åº¦ã€‚</small>
          <button id="saveKeys" class="btn outline">ä¿å­˜è®¾ç½®</button>
        </div>
        <div id="saveHint" style="display:none;color:#16a34a;font-size:12px">å·²ä¿å­˜åˆ°æœ¬åœ° âœ“</div>
      </div>
    </div>

    <div class="card">
      <div class="row grid-2">
        <div>
          <label>ElevenLabs API Keyï¼ˆå¯ç”¨ ElevenLabs æ¨¡å¼æ—¶å¿…å¡«ï¼‰</label>
          <input id="xiKey" type="password" placeholder="xi-...ï¼ˆä»…æœ¬åœ°ä¿å­˜ï¼‰" />
        </div>
        <div>
          <label>ElevenLabs Voice IDï¼ˆç¤ºä¾‹ï¼šRachel â†’ 21m00Tcm4TlvDq8ikWAMï¼‰</label>
          <input id="xiVoice" placeholder="21m00Tcm4TlvDq8ikWAM" value="21m00Tcm4TlvDq8ikWAM" />
        </div>
      </div>
      <div class="flex between">
        <small>æç¤ºï¼šè¯·ç¡®ä¿ Key ä»¥ xi- å¼€å¤´ï¼ŒVoice ID ä¸è¦åŠ å¼•å·ã€‚</small>
        <button id="clearKeys" class="btn outline">æ¸…é™¤æœ¬åœ°å¯†é’¥</button>
      </div>
    </div>

    <!-- Input & engine -->
    <div class="card">
      <label>è‹±æ–‡å†…å®¹ï¼ˆç²˜è´´æˆ–ä¸Šä¼  .docxï¼‰</label>
      <textarea id="inputEn" placeholder="Paste your English text here..."></textarea>
      <div class="flex between">
        <div class="flex">
          <input type="file" id="docx" accept=".docx" />
          <span id="charCount" class="pill">0 chars</span>
        </div>
        <div class="flex" style="gap:16px">
          <label class="flex" style="gap:6px;align-items:center">
            <span>è‡ªåŠ¨ç¿»è¯‘ä¸­æ–‡</span>
            <input id="translateChk" type="checkbox" checked />
          </label>
          <label class="flex" style="gap:6px;align-items:center">
            <span>æ˜¾ç¤ºç¾å¼éŸ³æ ‡</span>
            <input id="ipaChk" type="checkbox" />
          </label>
        </div>
      </div>
      <div class="flex between" style="margin-top:10px">
        <div class="flex">
          <label>æœ—è¯»å¼•æ“ï¼š</label>
          <select id="engine">
            <option value="browser">æµè§ˆå™¨ï¼ˆå…è´¹ï¼‰</option>
            <option value="openai">OpenAI TTS</option>
            <option value="eleven">ElevenLabs</option>
          </select>
        </div>
        <div class="flex">
          <label>é€Ÿåº¦ï¼š<span id="rateVal">1.00x</span></label>
          <input id="rate" class="slider" type="range" min="0.6" max="1.4" step="0.05" value="1.0" />
        </div>
      </div>
      <div class="flex" style="margin-top:10px;flex-wrap:wrap;gap:10px">
        <button id="prep" class="btn">æ‹†å¥ & ç¿»è¯‘/éŸ³æ ‡</button>
        <button id="playFromCurrent" class="btn">ä»å½“å‰å¥å¼€å§‹æœ—è¯»</button>
        <button id="quickSpeak" class="btn outline">ç›´æ¥æœ—è¯»æ•´æ®µï¼ˆæµè§ˆå™¨ï¼‰</button>
        <button id="testSpeak" class="btn outline">æµ‹è¯•æœ—è¯»ï¼ˆHelloï¼‰</button>
        <button id="stop" class="btn outline">åœæ­¢</button>
      </div>
      <div id="status" style="margin-top:8px;color:#334155"></div>
      <div class="progress" style="margin-top:8px;display:none"><div class="bar" id="bar"></div></div>
      <div id="diag" class="note" style="display:none;margin-top:8px"></div>
    </div>

    <!-- Parallel view -->
    <div class="card">
      <div class="cols" style="max-height:60vh;overflow:auto">
        <div id="enCol"></div>
        <div id="zhCol"></div>
      </div>
    </div>
  </div>

  <audio id="player"></audio>

  <script src="https://unpkg.com/mammoth@1.7.0/mammoth.browser.min.js"></script>
  <script>
    // --------- DOM ---------
    const $ = (id)=>document.getElementById(id);
    const openaiKeyEl=$('openaiKey');
    const xiKeyEl=$('xiKey');
    const xiVoiceEl=$('xiVoice');
    const inputEn=$('inputEn');
    const docx=$('docx');
    const translateChk=$('translateChk');
    const ipaChk=$('ipaChk');
    const engine=$('engine');
    const rate=$('rate');
    const rateVal=$('rateVal');
    const prep=$('prep');
    const playFromCurrent=$('playFromCurrent');
    const quickSpeak=$('quickSpeak');
    const testSpeak=$('testSpeak');
    const stopBtn=$('stop');
    const statusEl=$('status');
    const enCol=$('enCol');
    const zhCol=$('zhCol');
    const player=$('player');
    const bar=$('bar');
    const progressWrap=document.querySelector('.progress');
    const charCount=$('charCount');
    const diag=$('diag');

    // --------- localStorage ---------
    try{
      openaiKeyEl.value=localStorage.getItem('openaiKey')||'';
      xiKeyEl.value=localStorage.getItem('xiKey')||'';
      xiVoiceEl.value=localStorage.getItem('xiVoice')||xiVoiceEl.value;
    }catch(e){console.warn('localStorage ä¸å¯ç”¨ï¼š',e)}

    $('saveKeys').addEventListener('click',()=>{
      try{
        const ok=openaiKeyEl.value.trim().replace(/^["']|["']$/g,'');
        const xk=xiKeyEl.value.trim().replace(/^["']|["']$/g,'');
        const xv=xiVoiceEl.value.trim().replace(/^["']|["']$/g,'');
        localStorage.setItem('openaiKey',ok);
        localStorage.setItem('xiKey',xk);
        localStorage.setItem('xiVoice',xv);
        openaiKeyEl.value=ok; xiKeyEl.value=xk; xiVoiceEl.value=xv;
        const hint=$('saveHint'); hint.style.display='block'; setTimeout(()=>hint.style.display='none',1600);
      }catch(e){ alert('æ— æ³•ä¿å­˜ï¼šæµè§ˆå™¨ç¦æ­¢äº†æœ¬åœ°å­˜å‚¨æˆ–å¤„äºéšç§æ¨¡å¼'); }
    });
    $('clearKeys').addEventListener('click',()=>{
      try{ localStorage.removeItem('openaiKey'); localStorage.removeItem('xiKey'); localStorage.removeItem('xiVoice');
        openaiKeyEl.value=''; xiKeyEl.value='';
        const hint=$('saveHint'); hint.textContent='å·²æ¸…é™¤æœ¬åœ°å¯†é’¥'; hint.style.display='block'; setTimeout(()=>{hint.textContent='å·²ä¿å­˜åˆ°æœ¬åœ° âœ“'; hint.style.display='none'},1600);
      }catch(e){ alert('æ¸…é™¤å¤±è´¥ï¼š'+e) }
    });

    // --------- helpers ---------
    const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
    function updateCount(){ charCount.textContent=(inputEn.value||'').length+" chars"; }
    ['input','change','keyup','paste'].forEach(ev=> inputEn.addEventListener(ev,updateCount));
    updateCount();
    rate.addEventListener('input',()=>{rateVal.textContent=Number(rate.value).toFixed(2)+'x'});

    function showDiag(msg){ diag.textContent=msg; diag.style.display='block'; }
    function hideDiag(){ diag.style.display='none'; diag.textContent=''; }

    function ensureVoicesLoaded(timeout=2000){
      return new Promise((resolve)=>{
        const have=()=> speechSynthesis.getVoices().length>0;
        if(have()) return resolve(true);
        const id=setInterval(()=>{ if(have()){clearInterval(id); resolve(true);} }, 150);
        setTimeout(()=>{clearInterval(id); resolve(true);}, timeout);
      });
    }

    // --------- split & render ---------
    let EN=[], ZH=[], PH=[], currentIndex=0, isSpeaking=false;

    function splitSentences(txt){
      const cleaned=(txt||'').replace(/\s+/g,' ').trim();
      if(!cleaned) return [];
      return cleaned.split(/(?<=[.!?])\s+/).filter(Boolean);
    }

    function renderCols(){
      enCol.innerHTML=''; zhCol.innerHTML='';
      EN.forEach((s,i)=>{
        const d=document.createElement('div'); d.className='sent'+(i===currentIndex?' active':'');
        const ipa = PH[i] ? `<div class="ipa">/${PH[i]}/</div>` : '';
        d.innerHTML = `<div>${s}</div>${ipa}`; d.dataset.idx=i; d.onclick=()=>{highlight(i); speakFrom(i)}; enCol.appendChild(d);
        const z=document.createElement('div'); z.className='sent sent-zh'+(i===currentIndex?' active':''); z.textContent=ZH[i]||''; zhCol.appendChild(z);
      });
    }
    function highlight(i){
      currentIndex=i;
      [...enCol.children].forEach((el,idx)=> el.classList.toggle('active',idx===i));
      [...zhCol.children].forEach((el,idx)=> el.classList.toggle('active',idx===i));
      enCol.children[i]?.scrollIntoView({behavior:'smooth',block:'center'});
      zhCol.children[i]?.scrollIntoView({behavior:'smooth',block:'center'});
    }

    // upload
    docx.addEventListener('change',async(e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      const buf=await f.arrayBuffer(); const {value}=await window.mammoth.extractRawText({arrayBuffer:buf});
      inputEn.value=value.trim(); updateCount();
    });

    // translate by sentence
    async function translateBySentence(arr){
      if(!translateChk.checked) return new Array(arr.length).fill('');
      const key=openaiKeyEl.value.trim();
      if(!key){ alert('å¼€å¯äº†è‡ªåŠ¨ç¿»è¯‘ï¼Œè¯·å…ˆå¡«å†™ OpenAI Keyï¼Œæˆ–å…ˆå…³æ‰è‡ªåŠ¨ç¿»è¯‘'); return new Array(arr.length).fill(''); }
      statusEl.textContent='æ­£åœ¨é€å¥ç¿»è¯‘â€¦'; hideDiag();
      const prompt='Translate each English sentence into Simplified Chinese. Return ONLY a JSON array of strings, same length and order as input. No commentary.';
      const content=arr.map((s,i)=>`${i+1}. ${s}`).join('\n');
      const res=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${key}`},body:JSON.stringify({model:'gpt-4o-mini',messages:[{role:'system',content:prompt},{role:'user',content}],temperature:0.2})});
      if(!res.ok){ statusEl.textContent='ç¿»è¯‘å¤±è´¥'; showDiag('ç¿»è¯‘é”™è¯¯ï¼š'+await res.text()); return new Array(arr.length).fill(''); }
      const data=await res.json();
      const out=data.choices?.[0]?.message?.content||'';
      try{ const s=out.indexOf('['), e=out.lastIndexOf(']'); return JSON.parse(out.slice(s,e+1)).map(String); }
      catch{ return out.split(/\n+/).map(x=>x.trim()); }
      finally{ statusEl.textContent=''; }
    }

    // IPA by sentence (American)
    async function ipaBySentence(arr){
      if(!ipaChk.checked) return new Array(arr.length).fill('');
      const key=openaiKeyEl.value.trim();
      if(!key){ alert('æ˜¾ç¤ºç¾å¼éŸ³æ ‡éœ€è¦ OpenAI Keyï¼ˆæˆ–å…ˆå…³é—­â€œæ˜¾ç¤ºç¾å¼éŸ³æ ‡â€ï¼‰'); return new Array(arr.length).fill(''); }
      statusEl.textContent='æ­£åœ¨ç”Ÿæˆç¾å¼éŸ³æ ‡â€¦'; hideDiag();
      const prompt='You are a phonetics assistant. For each English sentence, output its American IPA transcription. Return ONLY a JSON array of strings (no numbering, no extra text). Use IPA symbols; do NOT include surrounding slashes.';
      const content=arr.join('\n');
      const res=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${key}`},body:JSON.stringify({model:'gpt-4o-mini',messages:[{role:'system',content:prompt},{role:'user',content}],temperature:0})});
      if(!res.ok){ statusEl.textContent='éŸ³æ ‡ç”Ÿæˆå¤±è´¥'; showDiag('éŸ³æ ‡é”™è¯¯ï¼š'+await res.text()); return new Array(arr.length).fill(''); }
      const data=await res.json(); const out=data.choices?.[0]?.message?.content||'';
      try{ const s=out.indexOf('['), e=out.lastIndexOf(']'); return JSON.parse(out.slice(s,e+1)).map(String); }
      catch{ return new Array(arr.length).fill(''); }
      finally{ statusEl.textContent=''; }
    }

    // prepare
    prep.addEventListener('click',async()=>{
      const txt=inputEn.value.trim();
      if(!txt){ alert('è¯·å…ˆç²˜è´´è‹±æ–‡å†…å®¹'); return; }
      EN=splitSentences(txt);
      if(EN.length===0){ alert('æ²¡æœ‰æ£€æµ‹åˆ°å®Œæ•´å¥å­ï¼ˆè¯·æ£€æŸ¥è‹±æ–‡å¥å°¾æ˜¯å¦æœ‰ . ? !ï¼‰'); return; }
      ZH=new Array(EN.length).fill(''); PH=new Array(EN.length).fill('');
      currentIndex=0; renderCols(); highlight(0);
      try{ ZH=await translateBySentence(EN); PH=await ipaBySentence(EN); renderCols(); highlight(0);}catch(e){console.error(e)}
    });

    // --------- engines (unchanged) ---------
    async function speakFrom(start){
      const eng=engine.value;
      if(eng==='browser' && EN.length===0){
        const text=inputEn.value.trim(); if(!text){ alert('è¯·å…ˆç²˜è´´è‹±æ–‡å†…å®¹'); return; }
        await ensureVoicesLoaded(); speechSynthesis.cancel();
        const u=new SpeechSynthesisUtterance(text); u.lang='en-US'; u.rate=clamp(parseFloat(rate.value),0.6,1.4);
        u.onerror=(e)=>console.warn('æµè§ˆå™¨æœ—è¯»é”™è¯¯',e); speechSynthesis.speak(u); return;
      }
      if(!EN.length){ alert('è¿˜æ²¡æœ‰å¥å­å¯è¯»ï¼Œè¯·å…ˆâ€œæ‹†å¥ & ç¿»è¯‘/éŸ³æ ‡â€'); return; }
      if(eng!=='browser'){
        if(eng==='openai' && !openaiKeyEl.value.trim()) return alert('OpenAI æ¨¡å¼éœ€è¦ OpenAI Key');
        if(eng==='eleven' && !xiKeyEl.value.trim()) return alert('ElevenLabs æ¨¡å¼éœ€è¦ ElevenLabs Key');
      }
      isSpeaking=true; showProgress(eng!=='browser');
      try{
        if(eng==='browser') await speakBrowserFrom(start);
        else if(eng==='openai') await speakOpenAIFrom(start);
        else await speakElevenFrom(start);
      }catch(err){ alert('æœ—è¯»å‡ºé”™ï¼š'+(err?.message||err)); }
      finally{ isSpeaking=false; showProgress(false); }
    }

    async function speakBrowserFrom(start){
      await ensureVoicesLoaded(); speechSynthesis.cancel();
      for(let i=start;i<EN.length;i++){
        highlight(i);
        const u=new SpeechSynthesisUtterance(EN[i]); u.lang='en-US'; u.rate=clamp(parseFloat(rate.value),0.6,1.4);
        await new Promise(res=>{ u.onend=res; u.onerror=res; speechSynthesis.speak(u); });
        if(!isSpeaking) break;
      }
    }

    async function speakOpenAIFrom(start){
      const key=openaiKeyEl.value.trim();
      for(let i=start;i<EN.length;i++){
        highlight(i); const url=await openaiTts(EN[i],key); await play(url); setBar(((i-start+1)/(EN.length-start))*100);
        if(!isSpeaking) break;
      }
    }
    async function openaiTts(text,key){
      const res=await fetch('https://api.openai.com/v1/audio/speech',{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${key}`},body:JSON.stringify({model:'gpt-4o-mini-tts',voice:'alloy',input:text,format:'mp3'})});
      if(!res.ok) throw new Error(await res.text());
      const buf=await res.arrayBuffer(); return URL.createObjectURL(new Blob([buf],{type:'audio/mpeg'}));
    }

    async function speakElevenFrom(start){
      const key=xiKeyEl.value.trim(); const vid=xiVoiceEl.value.trim();
      for(let i=start;i<EN.length;i++){
        highlight(i); const url=await elevenTts(EN[i],key,vid); await play(url); setBar(((i-start+1)/(EN.length-start))*100);
        if(!isSpeaking) break;
      }
    }
    async function elevenTts(text,key,voiceId){
      const url=`https://api.elevenlabs.io/v1/text-to-speech/${encodeURIComponent(voiceId)}`;
      const res=await fetch(url,{method:'POST',headers:{'xi-api-key':key,'Content-Type':'application/json','accept':'audio/mpeg'},body:JSON.stringify({text,model_id:'eleven_turbo_v2',voice_settings:{stability:0.5,similarity_boost:0.8}})});
      if(!res.ok) throw new Error(await res.text());
      const buf=await res.arrayBuffer(); return URL.createObjectURL(new Blob([buf],{type:'audio/mpeg'}));
    }

    function play(url){
      return new Promise((resolve,reject)=>{
        player.src=url; player.playbackRate=clamp(parseFloat(rate.value),0.6,1.4);
        player.onended=()=>resolve(); player.onerror=(e)=>reject(e); player.play().catch(reject);
      });
    }

    // stop & progress
    stopBtn.addEventListener('click',()=>{ isSpeaking=false; speechSynthesis?.cancel?.(); player.pause(); });
    function showProgress(v){ progressWrap.style.display=v?'block':'none'; if(!v) setBar(0); }
    function setBar(p){ bar.style.width=p+'%'; }

    // quick actions
    playFromCurrent.addEventListener('click',()=> speakFrom(currentIndex));
    quickSpeak.addEventListener('click',()=>{ engine.value='browser'; speakFrom(0); });
    testSpeak.addEventListener('click', async ()=>{
      try{ await ensureVoicesLoaded(); speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance("Hello from your browser! Testing testing."); u.lang='en-US'; u.rate=clamp(parseFloat(rate.value),0.6,1.4); speechSynthesis.speak(u);}catch(e){ alert('æµ‹è¯•æœ—è¯»å¤±è´¥ï¼š'+(e?.message||e)); }
    });
  </script>
</body>
</html>
