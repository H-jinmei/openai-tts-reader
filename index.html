<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è‹±æ–‡æœ—è¯» + ä¸­è‹±åŒæ­¥ï¼ˆä¸‰å¼•æ“ï¼‰</title>
  <style>
    :root{--c:#2563eb;--g:#10b981;--b:#0ea5e9;--bg:#f8fafc;--txt:#0f172a}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--txt); margin:0;}
    .wrap{max-width:1100px;margin:auto;padding:24px}
    h1{display:flex;align-items:center;gap:10px;font-size:22px;color:var(--c)}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .row{display:grid;gap:12px}
    @media(min-width:800px){.grid-2{grid-template-columns:1fr 1fr}}
    label{font-weight:600}
    input,textarea,select{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px}
    textarea{min-height:140px}
    small{color:#64748b}
    .btn{background:var(--c);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.outline{background:#fff;color:var(--txt);border:1px solid #cbd5e1}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .flex{display:flex;align-items:center;gap:10px}
    .between{justify-content:space-between}
    .pill{display:inline-block;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;border-radius:999px;padding:3px 10px;font-size:12px}
    .cols{display:grid;gap:10px}
    @media(min-width:900px){.cols{grid-template-columns:1fr 1fr}}
    .sent{padding:10px;border:1px solid transparent;border-radius:10px;cursor:pointer}
    .sent:hover{background:#f8fafc;border-color:#e2e8f0}
    .sent.active{background:#eef2ff;border-color:#a5b4fc;font-weight:600;color:#4338ca}
    .sent-zh.active{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .progress{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .bar{height:100%;background:var(--b);width:0}
    .slider{width:220px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ§ è‹±æ–‡æœ—è¯» + ä¸­è‹±åŒæ­¥ï¼ˆOpenAI / ElevenLabs / æµè§ˆå™¨ï¼‰</h1>

    <div class=\"card\">
      <label>OpenAI API Keyï¼ˆç”¨äºç¿»è¯‘ï¼›ä¹Ÿå¯ç”¨äº OpenAI TTSï¼Œå¯ç•™ç©ºï¼‰</label>
      <div class=\"row\">
        <input id=\"openaiKey\" type=\"password\" placeholder=\"sk-...ï¼ˆä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼‰\" />
        <div class=\"flex between\">
          <small>ä¸å¼€å¯ç¿»è¯‘æˆ– OpenAI TTS æ—¶ï¼Œå¯ä»¥ä¸å¡«ã€‚æµè§ˆå™¨æœ—è¯»ä¸æ¶ˆè€—é¢åº¦ã€‚</small>
          <button id=\"saveKeys\" class=\"btn outline\">ä¿å­˜è®¾ç½®</button>
        </div>
        <div id=\"saveHint\" style=\"display:none;color:#16a34a;font-size:12px\">å·²ä¿å­˜åˆ°æœ¬åœ° âœ“</div>
      </div>
    </div>

    <div class="card">
      <div class=\"row grid-2\">
        <div>
          <label>ElevenLabs API Keyï¼ˆå¯ç”¨ ElevenLabs æ¨¡å¼æ—¶å¿…å¡«ï¼‰</label>
          <input id=\"xiKey\" type=\"password\" placeholder=\"xi-...ï¼ˆä»…æœ¬åœ°ä¿å­˜ï¼‰\" />
        </div>
        <div>
          <label>ElevenLabs Voice IDï¼ˆç¤ºä¾‹ï¼šRachel â†’ 21m00Tcm4TlvDq8ikWAMï¼‰</label>
          <input id=\"xiVoice\" placeholder=\"21m00Tcm4TlvDq8ikWAM\" value=\"21m00Tcm4TlvDq8ikWAM\" />
        </div>
      </div>
      <div class=\"flex between\">
        <small>æç¤ºï¼šElevenLabs æœ‰æ¯æœˆ 10,000 å­—ç¬¦å…è´¹é¢åº¦ï¼ˆè§†å®˜æ–¹æ”¿ç­–è€Œå®šï¼‰ï¼Œæ›´é€‚åˆé•¿æ–‡ã€‚</small>
        <button id=\"clearKeys\" class=\"btn outline\">æ¸…é™¤æœ¬åœ°å¯†é’¥</button>
      </div>
    </div>

    <div class="card">
      <label>è‹±æ–‡å†…å®¹ï¼ˆç²˜è´´æˆ–ä¸Šä¼  .docxï¼‰</label>
      <textarea id="inputEn" placeholder="Paste your English text here..."></textarea>
      <div class="flex between">
        <div class="flex">
          <input type="file" id="docx" accept=".docx" />
          <span id="charCount" class="pill">0 chars</span>
        </div>
        <div class="flex">
          <label for="translateChk">è‡ªåŠ¨ç¿»è¯‘ä¸­æ–‡</label>
          <input id="translateChk" type="checkbox" checked />
        </div>
      </div>
      <div style="margin-top:10px" class="flex between">
        <div class="flex">
          <label>æœ—è¯»å¼•æ“ï¼š</label>
          <select id="engine">
            <option value="browser">æµè§ˆå™¨ï¼ˆå…è´¹ï¼‰</option>
            <option value="openai">OpenAI TTS</option>
            <option value="eleven">ElevenLabs</option>
          </select>
        </div>
        <div class="flex">
          <label>é€Ÿåº¦ï¼š<span id="rateVal">1.00x</span></label>
          <input id="rate" class="slider" type="range" min="0.6" max="1.4" step="0.05" value="1.0" />
        </div>
      </div>
      <div class=\"flex\" style=\"margin-top:10px\">
        <button id=\"prep\" class=\"btn\">æ‹†å¥ & ç¿»è¯‘</button>
        <button id=\"playFromCurrent\" class=\"btn\">ä»å½“å‰å¥å¼€å§‹æœ—è¯»</button>
        <button id=\"testSpeak\" class=\"btn outline\">æµ‹è¯•æœ—è¯»ï¼ˆHelloï¼‰</button>
        <button id=\"stop\" class=\"btn outline\">åœæ­¢</button>
      </div>
      <div id="status" style="margin-top:8px;color:#334155"></div>
      <div class="progress" style="margin-top:8px;display:none"><div class="bar" id="bar"></div></div>
    </div>

    <div class="card">
      <div class="cols" style="max-height:60vh;overflow:auto">
        <div id="enCol"></div>
        <div id="zhCol"></div>
      </div>
    </div>
  </div>

  <audio id="player"></audio>

  <script src="https://unpkg.com/mammoth@1.7.0/mammoth.browser.min.js"></script>
  <script>
    // â€”â€” DOM refs â€”â€”
    const $ = (id)=>document.getElementById(id);
    const openaiKeyEl=$('openaiKey');
    const xiKeyEl=$('xiKey');
    const xiVoiceEl=$('xiVoice');
    const inputEn=$('inputEn');
    const docx=$('docx');
    const translateChk=$('translateChk');
    const engine=$('engine');
    const rate=$('rate');
    const rateVal=$('rateVal');
    const prep=$('prep');
    const playFromCurrent=$('playFromCurrent');
    const stopBtn=$('stop');
    const statusEl=$('status');
    const enCol=$('enCol');
    const zhCol=$('zhCol');
    const player=$('player');
    const bar=$('bar');
    const progressWrap=document.querySelector('.progress');
    const charCount=$('charCount');

    // â€”â€” LocalStorage â€”â€”
    try{
      openaiKeyEl.value=localStorage.getItem('openaiKey')||'';
      xiKeyEl.value=localStorage.getItem('xiKey')||'';
      xiVoiceEl.value=localStorage.getItem('xiVoice')||xiVoiceEl.value;
    }catch(e){console.warn('localStorage ä¸å¯ç”¨ï¼š',e)}

    $('saveKeys').addEventListener('click',()=>{
      try{
        localStorage.setItem('openaiKey',openaiKeyEl.value.trim());
        localStorage.setItem('xiKey',xiKeyEl.value.trim());
        localStorage.setItem('xiVoice',xiVoiceEl.value.trim());
        const hint=$('saveHint'); hint.style.display='block'; setTimeout(()=>hint.style.display='none',1600);
      }catch(e){ alert('æ— æ³•ä¿å­˜ï¼šæµè§ˆå™¨ç¦æ­¢äº†æœ¬åœ°å­˜å‚¨æˆ–å¤„äºéšç§æ¨¡å¼'); }
    });
    $('clearKeys').addEventListener('click',()=>{
      try{ localStorage.removeItem('openaiKey'); localStorage.removeItem('xiKey'); localStorage.removeItem('xiVoice');
        openaiKeyEl.value=''; xiKeyEl.value='';
        const hint=$('saveHint'); hint.textContent='å·²æ¸…é™¤æœ¬åœ°å¯†é’¥'; hint.style.display='block'; setTimeout(()=>{hint.textContent='å·²ä¿å­˜åˆ°æœ¬åœ° âœ“'; hint.style.display='none'},1600);
      }catch(e){ alert('æ¸…é™¤å¤±è´¥ï¼š'+e) }
    });

    // â€”â€” Helpers â€”â€”
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
    rate.addEventListener('input',()=>{rateVal.textContent=Number(rate.value).toFixed(2)+'x'});
    inputEn.addEventListener('input',()=>{charCount.textContent=(inputEn.value||'').length+" chars"});

    // ç­‰å¾…æµè§ˆå™¨è¯­éŸ³åŠ è½½ï¼ˆChrome éœ€è¦ï¼‰
    function ensureVoicesLoaded(timeout=1500){
      return new Promise((resolve)=>{
        const have=()=> speechSynthesis.getVoices().length>0;
        if(have()) return resolve(true);
        const id=setInterval(()=>{ if(have()){clearInterval(id); resolve(true);} }, 150);
        setTimeout(()=>{clearInterval(id); resolve(true);}, timeout);
      });
    }

    // â€”â€” Split into sentences â€”â€”
    function splitSentences(txt){
      const cleaned=(txt||'').replace(/\s+/g,' ').trim();
      if(!cleaned) return [];
      return cleaned.split(/(?<=[.!?])\s+/).filter(Boolean);
    }

    // â€”â€” Render sentence columns â€”â€”
    let EN=[], ZH=[], currentIndex=0, isSpeaking=false;
    function renderCols(){
      enCol.innerHTML=''; zhCol.innerHTML='';
      EN.forEach((s,i)=>{
        const d=document.createElement('div');
        d.className='sent'+(i===currentIndex?' active':'');
        d.textContent=s; d.onclick=()=>jumpTo(i);
        d.dataset.idx=i; enCol.appendChild(d);
        const z=document.createElement('div');
        z.className='sent sent-zh'+(i===currentIndex?' active':'');
        z.textContent=ZH[i]||''; zhCol.appendChild(z);
      });
    }
    function highlight(i){
      currentIndex=i;
      [...enCol.children].forEach((el,idx)=>{
        el.classList.toggle('active',idx===i);
      });
      [...zhCol.children].forEach((el,idx)=>{
        el.classList.toggle('active',idx===i);
      });
      enCol.children[i]?.scrollIntoView({behavior:'smooth',block:'center'});
      zhCol.children[i]?.scrollIntoView({behavior:'smooth',block:'center'});
    }

    // â€”â€” File upload â€”â€”
    docx.addEventListener('change',async(e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      const buf=await f.arrayBuffer();
      const {value}=await window.mammoth.extractRawText({arrayBuffer:buf});
      inputEn.value=value.trim();
      charCount.textContent=inputEn.value.length+" chars";
    });

    // â€”â€” Translate by sentence â€”â€”
    async function translateBySentence(arr){
      if(!translateChk.checked) return new Array(arr.length).fill('');
      const key=openaiKeyEl.value.trim();
      if(!key){ alert('å¼€å¯äº†è‡ªåŠ¨ç¿»è¯‘ï¼Œè¯·å…ˆå¡«å†™ OpenAI Key'); return new Array(arr.length).fill(''); }
      statusEl.textContent='æ­£åœ¨é€å¥ç¿»è¯‘â€¦';
      const prompt='Translate each English sentence into Simplified Chinese. Return ONLY a JSON array of strings, same length and order as input. No commentary.';
      const content=arr.map((s,i)=>`${i+1}. ${s}`).join('\n');
      const res=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${key}`},body:JSON.stringify({model:'gpt-4o-mini',messages:[{role:'system',content:prompt},{role:'user',content}],temperature:0.2})});
      if(!res.ok){ statusEl.textContent='ç¿»è¯‘å¤±è´¥'; throw new Error(await res.text()); }
      const data=await res.json();
      const out=data.choices?.[0]?.message?.content||'';
      try{ const s=out.indexOf('['), e=out.lastIndexOf(']'); return JSON.parse(out.slice(s,e+1)).map(String); }
      catch{ return out.split(/\n+/).map(x=>x.trim()); }
      finally{ statusEl.textContent=''; }
    }

    // â€”â€” Prepare (split & translate) â€”â€”
    prep.addEventListener('click',async()=>{
      if(!inputEn.value.trim()){ alert('è¯·å…ˆç²˜è´´è‹±æ–‡å†…å®¹'); return; }
      EN=splitSentences(inputEn.value);
      if(EN.length===0){ alert('æ²¡æœ‰æ£€æµ‹åˆ°å®Œæ•´å¥å­ï¼ˆè¯·æ£€æŸ¥è‹±æ–‡å¥å°¾æ˜¯å¦æœ‰ . ? !ï¼‰'); return; }
      ZH=new Array(EN.length).fill('');
      currentIndex=0; renderCols(); highlight(0);
      try{ ZH=await translateBySentence(EN); renderCols(); highlight(0);}catch(e){console.error(e)}
    });
      ZH=new Array(EN.length).fill('');
      currentIndex=0; renderCols(); highlight(0);
      try{ ZH=await translateBySentence(EN); renderCols(); highlight(0);}catch(e){console.error(e)}
    });

    // â€”â€” Jump â€”â€”
    function jumpTo(i){ highlight(i); speakFrom(i); }

    // â€”â€” Engines â€”â€”
    async function speakFrom(start){
      if(!EN.length){ alert('è¿˜æ²¡æœ‰å¥å­å¯è¯»ï¼Œè¯·å…ˆâ€œæ‹†å¥ & ç¿»è¯‘â€'); return; }
      if(engine.value!=='browser'){
        // éæµè§ˆå™¨å¼•æ“è¦æ±‚å¿…é¡»æ‰‹åŠ¨ç‚¹å‡»ä¿å­˜è¿‡ Keyï¼Œé¿å…è¾“å…¥æ¡†ä¸¢å¤±
        if(engine.value==='openai' && !openaiKeyEl.value.trim()) return alert('OpenAI æ¨¡å¼éœ€è¦ OpenAI Key');
        if(engine.value==='eleven' && !xiKeyEl.value.trim()) return alert('ElevenLabs æ¨¡å¼éœ€è¦ ElevenLabs Key');
      }
      isSpeaking=true; showProgress(engine.value!=='browser');
      try{
      if(!EN.length) return;
      const eng=engine.value; isSpeaking=true; showProgress(eng!=='browser');
      try{
        if(eng==='browser'){
          await speakBrowserFrom(start);
        }else if(eng==='openai'){
          await speakOpenAIFrom(start);
        }else{
          await speakElevenFrom(start);
        }
      }catch(err){ alert('æœ—è¯»å‡ºé”™ï¼š'+(err?.message||err)); }
      finally{ isSpeaking=false; showProgress(false); }
    }

    // â€”â€” Browser speech â€”â€”
    async function speakBrowserFrom(start){
      if(!('speechSynthesis' in window)) throw new Error('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå†…ç½®æœ—è¯»');
      await ensureVoicesLoaded(); // ç¡®ä¿è¯­éŸ³å·²åŠ è½½
      speechSynthesis.cancel();
      for(let i=start;i<EN.length;i++){
        highlight(i);
        const u=new SpeechSynthesisUtterance(EN[i]);
        u.lang='en-US';
        u.rate=clamp(parseFloat(rate.value),0.6,1.4);
        u.onerror=(e)=>console.warn('speech error',e);
        await new Promise(res=>{ u.onend=res; u.onerror=res; speechSynthesis.speak(u); });
        if(!isSpeaking) break;
      }
    });
        if(!isSpeaking) break;
      }
    }

    // â€”â€” OpenAI sentence TTS â€”â€”
    async function speakOpenAIFrom(start){
      const key=openaiKeyEl.value.trim(); if(!key) throw new Error('è¯·å¡«å†™ OpenAI Key');
      for(let i=start;i<EN.length;i++){
        highlight(i); const url=await openaiTts(EN[i],key); await play(url);
        setBar(((i-start+1)/(EN.length-start))*100);
        if(!isSpeaking) break;
      }
    }
    async function openaiTts(text,key){
      const res=await fetch('https://api.openai.com/v1/audio/speech',{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${key}`},body:JSON.stringify({model:'gpt-4o-mini-tts',voice:'alloy',input:text,format:'mp3'})});
      if(!res.ok) throw new Error(await res.text());
      const buf=await res.arrayBuffer(); const blob=new Blob([buf],{type:'audio/mpeg'}); return URL.createObjectURL(blob);
    }

    // â€”â€” ElevenLabs sentence TTS â€”â€”
    async function speakElevenFrom(start){
      const key=xiKeyEl.value.trim(); const vid=xiVoiceEl.value.trim();
      if(!key||!vid) throw new Error('è¯·å¡«å†™ ElevenLabs Key å’Œ Voice ID');
      for(let i=start;i<EN.length;i++){
        highlight(i); const url=await elevenTts(EN[i],key,vid); await play(url);
        setBar(((i-start+1)/(EN.length-start))*100);
        if(!isSpeaking) break;
      }
    }
    async function elevenTts(text,key,voiceId){
      const url=`https://api.elevenlabs.io/v1/text-to-speech/${encodeURIComponent(voiceId)}`;
      const res=await fetch(url,{method:'POST',headers:{'xi-api-key':key,'Content-Type':'application/json','accept':'audio/mpeg'},body:JSON.stringify({text,model_id:'eleven_turbo_v2',voice_settings:{stability:0.5,similarity_boost:0.8}})});
      if(!res.ok) throw new Error(await res.text());
      const buf=await res.arrayBuffer(); const blob=new Blob([buf],{type:'audio/mpeg'}); return URL.createObjectURL(blob);
    }

    // â€”â€” Player â€”â€”
    function play(url){
      return new Promise((resolve,reject)=>{
        player.src=url; player.playbackRate=clamp(parseFloat(rate.value),0.6,1.4);
        player.onended=()=>resolve(); player.onerror=(e)=>reject(e); player.play().catch(reject);
      });
    }

    // â€”â€” Stop & progress â€”â€”
    stopBtn.addEventListener('click',()=>{ isSpeaking=false; speechSynthesis?.cancel?.(); player.pause(); });
    function showProgress(v){ progressWrap.style.display=v?'block':'none'; if(!v) setBar(0); }
    function setBar(p){ bar.style.width=p+'%'; }

    // â€”â€” Start from current highlighted â€”â€”
    playFromCurrent.addEventListener('click',()=>{
      if(!EN.length){ alert('è¿˜æ²¡æœ‰æ‹†å¥ï¼Œè¯·å…ˆç‚¹å‡»â€œæ‹†å¥ & ç¿»è¯‘â€'); return; }
      speakFrom(currentIndex);
    });

    // â€”â€” Test speak â€”â€”
    $('testSpeak').addEventListener('click', async ()=>{
      try{
        await ensureVoicesLoaded();
        const u=new SpeechSynthesisUtterance('Hello from New York! Let\'s test your speakers.');
        u.lang='en-US';
        u.rate=clamp(parseFloat(rate.value),0.6,1.4);
        speechSynthesis.cancel(); speechSynthesis.speak(u);
      }catch(e){ alert('æµ‹è¯•æœ—è¯»å¤±è´¥ï¼š'+(e?.message||e)); }
    });

    // ç‚¹å‡»è‹±æ–‡å¥å­å¼€å§‹æœ—è¯»
    enCol.addEventListener('click',(e)=>{
      const d=e.target.closest('.sent'); if(!d) return; const i=Number(d.dataset.idx); if(Number.isFinite(i)) speakFrom(i);
    });('click',(e)=>{
      const d=e.target.closest('.sent'); if(!d) return; const i=Number(d.dataset.idx); if(Number.isFinite(i)) speakFrom(i);
    });
  </script>
</body>
</html>
