<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è‹±æ–‡æœ—è¯» + ä¸­è‹±åŒæ­¥ï¼ˆOpenAI / APIMart / æµè§ˆå™¨ï¼‰</title>
  <style>
    :root{
      --bg:#f8fafc;
      --txt:#0f172a;
      --muted:#64748b;
      --card:#ffffff;
      --border:#e5e7eb;
      --shadow:0 2px 4px rgba(15,23,42,.04);
      --primary:#2563eb;
      --primary-soft:#e0edff;
      --accent:#0ea5e9;
      --accent-soft:#e0f2fe;
      --row-hover:rgba(15,23,42,0.02);
      --row-active:#e0edff;
    }
    body.dark{
      --bg:#020617;
      --txt:#e5e7eb;
      --muted:#9ca3af;
      --card:#020617;
      --border:#1f2937;
      --shadow:0 2px 10px rgba(0,0,0,.45);
      --primary:#60a5fa;
      --primary-soft:#0b1120;
      --accent:#38bdf8;
      --accent-soft:#082f49;
      --row-hover:rgba(148,163,184,0.16);
      --row-active:#0b1120;
    }

    *{box-sizing:border-box;}
    html,body{margin:0;padding:0;height:100%;}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--txt);
    }
    a{color:var(--primary);}
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:18px 16px 40px;
    }

    h1{
      font-size:20px;
      margin:0 0 4px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    h1 span.emoji{font-size:22px;}
    .sub{
      font-size:12px;
      color:var(--muted);
      margin-bottom:12px;
    }

    .top-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:8px;
    }
    .top-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:var(--card);
      border:1px solid var(--border);
      font-size:12px;
      box-shadow:var(--shadow);
    }
    .btn{
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--txt);
      padding:6px 12px;
      font-size:12px;
      cursor:pointer;
    }
    .btn.primary{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
    }
    .btn.sm{padding:4px 10px;font-size:11px;}
    .btn:disabled{opacity:.5;cursor:not-allowed;}

    .card{
      background:var(--card);
      border-radius:16px;
      border:1px solid var(--border);
      padding:14px 16px;
      margin-top:10px;
      box-shadow:var(--shadow);
    }
    label{
      font-size:13px;
      font-weight:600;
      display:block;
      margin-bottom:6px;
    }
    input[type="text"],
    input[type="password"],
    select,
    textarea{
      width:100%;
      border-radius:10px;
      border:1px solid var(--border);
      background:transparent;
      color:inherit;
      padding:8px 10px;
      font-size:13px;
    }
    textarea{min-height:140px;resize:vertical;}
    small{font-size:12px;color:var(--muted);}
    .row-flex{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top:6px;
    }
    .row-flex > *{flex:1 1 auto;}
    .row-flex .right{flex:0 0 auto;}

    .badge{
      display:inline-block;
      font-size:11px;
      padding:1px 8px;
      border-radius:999px;
      background:var(--primary-soft);
      color:var(--primary);
      margin-left:6px;
    }

    .slider{width:220px;}
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
    }

    .sent-list-wrap{
      max-height:420px;
      overflow:auto;
      margin-top:10px;
      border-radius:12px;
      border:1px solid var(--border);
    }
    .sent-row{
      display:grid;
      grid-template-columns:1.5fr 1.5fr;
      gap:12px;
      padding:8px 12px;
      border-bottom:1px solid rgba(148,163,184,0.25);
      cursor:pointer;
      transition:background .12s;
    }
    .sent-row:last-child{border-bottom:none;}
    .sent-row:hover{background:var(--row-hover);}
    .sent-row.active{
      background:var(--row-active);
      box-shadow:inset 2px 0 0 var(--primary);
    }

    .sent-en-main{font-size:14px;margin-bottom:3px;}
    .sent-ipa{font-size:11px;color:var(--muted);}
    .sent-zh{font-size:14px;}

    .status{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      white-space:pre-wrap;
    }

    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:var(--primary-soft);
      color:var(--primary);
      font-size:11px;
    }

    .checkbox-row{
      display:flex;
      flex-wrap:wrap;
      gap:24px;
      margin-top:10px;
      font-size:13px;
      align-items:center;
    }
    .checkbox-row label{
      margin:0;
      font-weight:400;
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
    }

    /* å­¦ä¹ æ—¶é•¿è¯¦æƒ… */
    .study-detail{
      margin-top:8px;
      border-top:1px dashed var(--border);
      padding-top:8px;
      display:none;
    }
    .study-grid{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:8px;
    }
    .study-box{
      border-radius:10px;
      border:1px solid var(--border);
      padding:6px 8px;
      font-size:11px;
    }
    .study-label{color:var(--muted);margin-bottom:2px;font-size:11px;}
    .study-val{font-weight:600;font-size:12px;}

    @media (max-width:768px){
      .sent-row{grid-template-columns:1.6fr;}
      .study-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top-bar">
    <div>
      <h1><span class="emoji">ğŸ“–</span>è‹±æ–‡æœ—è¯» + ä¸­è‹±åŒæ­¥ï¼ˆOpenAI / APIMart / æµè§ˆå™¨ï¼‰</h1>
      <div class="sub">æ”¯æŒæŒ‰å¥ç²¾å‡†æœ—è¯»ã€æ‡’åŠ è½½ç¿»è¯‘å’ŒéŸ³æ ‡ã€å°½é‡èŠ‚çœ API é¢åº¦ã€‚</div>
    </div>
    <div class="top-right">
      <button id="themeToggle" class="btn sm">ğŸŒ™ æ·±è‰²</button>
      <div class="chip" id="sessionChip">æœ¬æ¬¡ï¼š<span id="sessionTime">00:00:00</span></div>
      <div class="chip">
        æ€»è®¡ï¼š<span id="totalTime">0å°æ—¶0åˆ†é’Ÿ</span>
        <button id="studyToggle" class="btn sm" style="margin-left:6px;">è¯¦æƒ…</button>
      </div>
    </div>
  </div>

  <!-- å­¦ä¹ æ—¶é•¿è¯¦æƒ… -->
  <div id="studyDetail" class="study-detail card" style="padding:10px 12px;">
    <div class="study-grid">
      <div class="study-box">
        <div class="study-label">ä»Šå¤©</div>
        <div class="study-val" id="kToday">0åˆ†é’Ÿ</div>
      </div>
      <div class="study-box">
        <div class="study-label">æœ¬å‘¨ï¼ˆå‘¨ä¸€-å‘¨æ—¥ï¼‰</div>
        <div class="study-val" id="kWeek">0åˆ†é’Ÿ</div>
      </div>
      <div class="study-box">
        <div class="study-label">æœ¬æœˆ</div>
        <div class="study-val" id="kMonth">0åˆ†é’Ÿ</div>
      </div>
      <div class="study-box">
        <div class="study-label">ä»Šå¹´</div>
        <div class="study-val" id="kYear">0åˆ†é’Ÿ</div>
      </div>
    </div>
    <div class="study-label" style="margin-top:6px;">
      è¯´æ˜ï¼šä»…åœ¨é¡µé¢å‰å°ã€è®¡æ—¶å™¨è¿è¡Œæ—¶ç´¯è®¡ï¼›æŒ‰è‡ªç„¶æ—¥ / å‘¨ / æœˆ / å¹´ç»Ÿè®¡ï¼Œæ•°æ®å­˜å‚¨åœ¨æµè§ˆå™¨ localStorageã€‚
    </div>
  </div>

  <!-- API Key & æœåŠ¡å•† -->
  <div class="card">
    <label>API Keyï¼ˆç”¨äºç¿»è¯‘ / éŸ³æ ‡ / OpenAI & APIMart TTSï¼‰</label>
    <input id="apiKeyInput" type="password" placeholder="åœ¨æ­¤ç²˜è´´ OpenAI å®˜æ–¹ Key æˆ– APIMart Keyï¼ˆsk-...ï¼‰ï¼Œä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨" />
    <div class="row-flex">
      <div>
        <small id="providerHint">è¯´æ˜ï¼šåªåœ¨éœ€è¦ç¿»è¯‘ã€éŸ³æ ‡æˆ–è°ƒç”¨ TTS æ—¶æ‰ä¼šç”¨åˆ°ã€‚</small>
      </div>
      <div class="right" style="display:flex;gap:8px;align-items:center;">
        <label style="font-size:12px;font-weight:500;">
          æœåŠ¡å•†ï¼š
          <select id="providerSelect" style="width:auto;min-width:130px;font-size:12px;">
            <option value="apimart">APIMart ä»£ç†ï¼ˆæ¨èçœé’±ï¼‰</option>
            <option value="openai">OpenAI å®˜æ–¹</option>
          </select>
        </label>
        <button id="saveKeyBtn" class="btn sm">ä¿å­˜åˆ°æœ¬åœ°</button>
      </div>
    </div>
    <div id="saveKeyStatus" class="status"></div>
  </div>

  <!-- è‹±æ–‡å†…å®¹è¾“å…¥ -->
  <div class="card">
    <label>è‹±æ–‡å†…å®¹ï¼ˆç²˜è´´æ–‡æœ¬æˆ–ä¸Šä¼  .docxï¼‰</label>
    <textarea id="inputText" placeholder="Paste your English text here..."></textarea>
    <div class="row-flex" style="margin-top:6px;">
      <div class="left" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <input type="file" id="fileInput" accept=".docx" />
        <span class="pill"><span id="charCount">0</span> chars</span>
      </div>
      <div class="right checkbox-row" style="margin-top:0;">
        <label><input type="checkbox" id="autoZhChk" /> è‡ªåŠ¨ç¿»è¯‘ä¸­æ–‡ï¼ˆæ‡’åŠ è½½ï¼Œæ¯å¥åªç¿»ä¸€æ¬¡ï¼‰</label>
        <label><input type="checkbox" id="autoIpaChk" /> æ˜¾ç¤ºç¾å¼éŸ³æ ‡ï¼ˆæ‡’åŠ è½½ï¼Œæ¯å¥åªç”Ÿæˆä¸€æ¬¡ï¼‰</label>
      </div>
    </div>

    <div class="row-flex" style="margin-top:10px;">
      <label class="left" style="flex:0 0 auto;font-weight:500;font-size:13px;">
        æœ—è¯»å¼•æ“ï¼š
        <select id="engineSelect" style="width:auto;min-width:220px;">
          <option value="apitts">OpenAI / APIMart TTSï¼ˆé€å¥æ‡’åŠ è½½ + ç¼“å­˜ï¼Œçœé’±ï¼‰</option>
          <option value="browser">æµè§ˆå™¨æœ—è¯»ï¼ˆå…è´¹ï¼Œä¸ç”¨ Keyï¼‰</option>
        </select>
      </label>
      <div class="right" style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:13px;">é€Ÿåº¦ï¼š<span id="speedLabel">1.00x</span></span>
        <input type="range" id="rateRange" min="0.6" max="1.4" step="0.05" value="1.0" class="slider" />
      </div>
    </div>

    <div class="controls">
      <button id="splitBtn" class="btn primary">æ‹†å¥ï¼ˆä¸ç«‹å³ç¿»è¯‘ï¼‰</button>
      <button id="playFromCurrentBtn" class="btn">ä»å½“å‰å¥å¼€å§‹æœ—è¯»</button>
      <button id="quickBrowserBtn" class="btn">ç›´æ¥æœ—è¯»æ•´æ®µï¼ˆæµè§ˆå™¨ï¼‰</button>
      <button id="testBtn" class="btn">æµ‹è¯•æœ—è¯»ï¼ˆHelloï¼‰</button>
      <button id="stopBtn" class="btn">åœæ­¢æœ—è¯»</button>
    </div>
    <div id="status" class="status"></div>
  </div>

  <!-- å¥å­åˆ—è¡¨ -->
  <div class="card">
    <div class="sent-list-wrap" id="sentList"></div>
  </div>
</div>

<audio id="audioPlayer"></audio>

<!-- è§£æ docx -->
<script src="https://unpkg.com/mammoth@1.7.0/mammoth.browser.min.js"></script>
<script>
(function(){
  const $ = id => document.getElementById(id);

  const apiKeyInput = $("apiKeyInput");
  const providerSelect = $("providerSelect");
  const saveKeyBtn = $("saveKeyBtn");
  const saveKeyStatus = $("saveKeyStatus");
  const inputText = $("inputText");
  const fileInput = $("fileInput");
  const charCountEl = $("charCount");
  const autoZhChk = $("autoZhChk");
  const autoIpaChk = $("autoIpaChk");
  const engineSelect = $("engineSelect");
  const rateRange = $("rateRange");
  const speedLabel = $("speedLabel");
  const splitBtn = $("splitBtn");
  const playFromCurrentBtn = $("playFromCurrentBtn");
  const quickBrowserBtn = $("quickBrowserBtn");
  const testBtn = $("testBtn");
  const stopBtn = $("stopBtn");
  const statusEl = $("status");
  const sentList = $("sentList");
  const audioPlayer = $("audioPlayer");

  const themeToggle = $("themeToggle");
  const sessionTimeEl = $("sessionTime");
  const totalTimeEl = $("totalTime");
  const studyToggle = $("studyToggle");
  const studyDetail = $("studyDetail");
  const kTodayEl = $("kToday");
  const kWeekEl = $("kWeek");
  const kMonthEl = $("kMonth");
  const kYearEl = $("kYear");

  const LS_KEYS = {
    API_KEY : "ttsReader:apiKey",
    PROVIDER: "ttsReader:provider",
    THEME   : "ttsReader:theme",
    STUDY   : "ttsReader:dailySeconds"
  };

  /* ---------- å·¥å…·å‡½æ•° ---------- */
  function setStatus(msg){
    statusEl.textContent = msg || "";
  }
  function showSaveStatus(msg){
    saveKeyStatus.textContent = msg;
    if(!msg) return;
    setTimeout(()=>{saveKeyStatus.textContent="";},1800);
  }
  function updateCharCount(){
    charCountEl.textContent = (inputText.value || "").length;
  }
  function clamp(v,min,max){return Math.min(max,Math.max(min,v));}

  /* ---------- ä¸»é¢˜ ---------- */
  function applyTheme(theme){
    document.body.classList.toggle("dark", theme==="dark");
    themeToggle.textContent = theme==="dark" ? "â˜€ï¸ æµ…è‰²" : "ğŸŒ™ æ·±è‰²";
    try{localStorage.setItem(LS_KEYS.THEME, theme);}catch(e){}
  }
  (function initTheme(){
    let theme;
    try{theme = localStorage.getItem(LS_KEYS.THEME);}catch(e){}
    if(!theme){
      const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      theme = prefersDark ? "dark" : "light";
    }
    applyTheme(theme);
  })();
  themeToggle.addEventListener("click",()=>{
    const current = document.body.classList.contains("dark") ? "dark" : "light";
    applyTheme(current==="dark" ? "light" : "dark");
  });

  /* ---------- å­¦ä¹ è®¡æ—¶ï¼ˆå¤šç»´åº¦ï¼‰ ---------- */
  function todayStr(d=new Date()){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const day=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function loadDaily(){
    try{
      const raw = localStorage.getItem(LS_KEYS.STUDY);
      if(!raw) return {};
      const obj = JSON.parse(raw);
      return obj && typeof obj==="object" ? obj : {};
    }catch(e){return {};}
  }
  function saveDaily(map){
    try{localStorage.setItem(LS_KEYS.STUDY, JSON.stringify(map));}catch(e){}
  }
  function fmtHMS(sec){
    sec = Math.max(0,Math.floor(sec));
    const h=Math.floor(sec/3600);
    const m=Math.floor((sec%3600)/60);
    const s=sec%60;
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }
  function fmtHM(sec){
    sec = Math.max(0,Math.floor(sec));
    const h=Math.floor(sec/3600);
    const m=Math.floor((sec%3600)/60);
    return `${h}å°æ—¶${m}åˆ†é’Ÿ`;
  }
  function minutesStr(sec){
    return `${Math.round(sec/60)}åˆ†é’Ÿ`;
  }
  function startOfWeek(d){
    const x=new Date(d);
    const day=(x.getDay()+6)%7; // å‘¨ä¸€=0
    x.setHours(0,0,0,0);
    x.setDate(x.getDate()-day);
    return x;
  }
  function endOfWeek(d){
    const s=startOfWeek(d);
    const e=new Date(s);
    e.setDate(s.getDate()+6);
    return e;
  }
  function startOfMonth(d){return new Date(d.getFullYear(), d.getMonth(), 1);}
  function endOfMonth(d){return new Date(d.getFullYear(), d.getMonth()+1, 0);}
  function startOfYear(d){return new Date(d.getFullYear(),0,1);}
  function endOfYear(d){return new Date(d.getFullYear(),11,31);}
  function sumRange(map, startDate, endDate){
    const s=new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
    const e=new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
    let cur=new Date(s), total=0;
    while(cur<=e){
      const key=todayStr(cur);
      total += map[key] || 0;
      cur.setDate(cur.getDate()+1);
    }
    return total;
  }
  function totalAll(map){
    return Object.values(map).reduce((a,b)=>a+(+b||0),0);
  }

  let sessionSeconds = 0;
  let studyTimer = null;
  let dailyMap = loadDaily();
  let visible = document.visibilityState === "visible";

  function renderStudy(){
    const now=new Date();
    sessionTimeEl.textContent = fmtHMS(sessionSeconds);
    totalTimeEl.textContent = fmtHM(totalAll(dailyMap));
    kTodayEl.textContent = minutesStr(dailyMap[todayStr(now)] || 0);
    kWeekEl.textContent = minutesStr(sumRange(dailyMap, startOfWeek(now), endOfWeek(now)));
    kMonthEl.textContent = minutesStr(sumRange(dailyMap, startOfMonth(now), endOfMonth(now)));
    kYearEl.textContent = minutesStr(sumRange(dailyMap, startOfYear(now), endOfYear(now)));
  }
  function tickStudy(){
    if(!visible) return;
    sessionSeconds += 1;
    const key=todayStr(new Date());
    dailyMap[key]=(dailyMap[key]||0)+1;
  }
  function startStudyTimer(){
    if(studyTimer) clearInterval(studyTimer);
    studyTimer = setInterval(()=>{
      tickStudy();
      if(sessionSeconds % 2 === 0) renderStudy();
      if(sessionSeconds % 10 === 0) saveDaily(dailyMap);
    },1000);
    renderStudy();
  }
  document.addEventListener("visibilitychange",()=>{
    visible = document.visibilityState === "visible";
  });
  window.addEventListener("beforeunload",()=>{saveDaily(dailyMap);});
  studyToggle.addEventListener("click",()=>{
    const open = studyDetail.style.display === "block";
    studyDetail.style.display = open ? "none" : "block";
  });
  startStudyTimer();

  /* ---------- è¯»å– Key & Provider ---------- */
  (function initKeys(){
    try{
      const k = localStorage.getItem(LS_KEYS.API_KEY);
      if(k) apiKeyInput.value = k;
      const p = localStorage.getItem(LS_KEYS.PROVIDER);
      if(p) providerSelect.value = p;
    }catch(e){}
  })();
  saveKeyBtn.addEventListener("click",()=>{
    try{
      const key = apiKeyInput.value.trim().replace(/^["']|["']$/g,"");
      localStorage.setItem(LS_KEYS.API_KEY, key);
      localStorage.setItem(LS_KEYS.PROVIDER, providerSelect.value);
      apiKeyInput.value = key;
      showSaveStatus("å·²ä¿å­˜åˆ°æœ¬åœ° âœ“");
    }catch(e){
      showSaveStatus("ä¿å­˜å¤±è´¥ï¼ˆå¯èƒ½æµè§ˆå™¨ç¦æ­¢ localStorageï¼‰");
    }
  });

  /* ---------- æ–‡æœ¬è¾“å…¥ & æ–‡ä»¶è¯»å– ---------- */
  inputText.addEventListener("input", updateCharCount);
  updateCharCount();
  fileInput.addEventListener("change", async (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    if(!file.name.endsWith(".docx")){
      alert("ç›®å‰ä»…æ”¯æŒ .docx æ–‡ä»¶");
      return;
    }
    try{
      const arrayBuffer = await file.arrayBuffer();
      const result = await window.mammoth.extractRawText({arrayBuffer});
      inputText.value = (result.value || "").trim();
      updateCharCount();
      setStatus("å·²ä» Word æ–‡æ¡£æå–çº¯æ–‡æœ¬ã€‚");
    }catch(err){
      console.error(err);
      setStatus("è¯»å– Word æ–‡æ¡£å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸåã€‚");
    }
  });

  rateRange.addEventListener("input",()=>{
    const v = parseFloat(rateRange.value);
    speedLabel.textContent = v.toFixed(2) + "x";
  });

  /* ---------- å¥å­æ•°æ®ç»“æ„ ---------- */
  /**
   * sentences: [{ en, zh, ipa, zhLoading, ipaLoading, audioUrl }]
   */
  let sentences = [];
  let currentIndex = 0;
  let isPlaying = false;

  function splitSentences(text){
    const cleaned = (text || "").replace(/\r\n/g,"\n").replace(/\s+$/g,"");
    if(!cleaned) return [];
    // ç”¨æ¢è¡Œæ‹†ç²—ç•¥æ®µè½ï¼Œå†ç”¨æ ‡ç‚¹ç»†åˆ†
    const parts = cleaned.split(/\n+/).flatMap(block=>{
      block = block.trim();
      if(!block) return [];
      return block
        .split(/(?<=[.!?])\s+(?=[A-Z0-9â€œ"']|\bI\b)/)
        .map(s=>s.trim())
        .filter(Boolean);
    });
    return parts;
  }

  function renderSentences(){
    sentList.innerHTML = "";
    if(!sentences.length){
      sentList.innerHTML = '<div style="padding:12px;font-size:13px;color:var(--muted);">è¿˜æ²¡æœ‰å¥å­ï¼Œè¯·å…ˆç²˜è´´è‹±æ–‡å¹¶ç‚¹å‡»â€œæ‹†å¥â€ã€‚</div>';
      return;
    }
    sentences.forEach((s,i)=>{
      const row = document.createElement("div");
      row.className = "sent-row" + (i===currentIndex ? " active" : "");
      row.dataset.idx = i;

      const left = document.createElement("div");
      const enDiv = document.createElement("div");
      enDiv.className = "sent-en-main";
      enDiv.textContent = s.en;

      const ipaDiv = document.createElement("div");
      ipaDiv.className = "sent-ipa";
      ipaDiv.textContent = s.ipa ? `/${s.ipa}/` : (autoIpaChk.checked ? (s.ipaLoading ? "éŸ³æ ‡ç”Ÿæˆä¸­â€¦" : "ï¼ˆç‚¹å‡»æœ—è¯»æˆ–è¯¥å¥æ—¶è‡ªåŠ¨ç”ŸæˆéŸ³æ ‡ï¼‰") : "");

      left.appendChild(enDiv);
      left.appendChild(ipaDiv);

      const right = document.createElement("div");
      right.className = "sent-zh";
      right.textContent = s.zh || (autoZhChk.checked ? (s.zhLoading ? "ç¿»è¯‘ä¸­â€¦" : "ï¼ˆç‚¹å‡»æœ—è¯»æˆ–è¯¥å¥æ—¶è‡ªåŠ¨ç¿»è¯‘ï¼‰") : "");

      row.appendChild(left);
      row.appendChild(right);

      row.addEventListener("click", async ()=>{
        highlightSentence(i);
        await lazyEnsureZhAndIpa(i);
        renderSentences();
      });

      sentList.appendChild(row);
    });
  }

  function highlightSentence(idx){
    currentIndex = idx;
    [...sentList.children].forEach((row, i)=>{
      if(!row.classList) return;
      row.classList.toggle("active", i===idx);
    });
    const row = sentList.children[idx];
    if(row) row.scrollIntoView({behavior:"smooth",block:"center"});
  }

  /* ---------- è°ƒç”¨æ¥å£ï¼ˆOpenAI / APIMartï¼‰ ---------- */
  function getBaseUrl(){
    return providerSelect.value === "apimart"
      ? "https://api.apimart.ai"
      : "https://api.openai.com";
  }
  function getApiKeyOrThrow(){
    const key = apiKeyInput.value.trim();
    if(!key){
      throw new Error("è¯·å…ˆåœ¨é¡¶éƒ¨è¾“å…¥ API Keyï¼ˆOpenAI æˆ– APIMartï¼‰");
    }
    return key;
  }

  async function callChatOnce(prompt, systemPrompt){
    const key = getApiKeyOrThrow();
    const base = getBaseUrl();
    const body = {
      model: "gpt-4o-mini",
      messages: [
        {role:"system", content: systemPrompt},
        {role:"user", content: prompt}
      ],
      temperature:0.2
    };
    const res = await fetch(base + "/v1/chat/completions",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${key}`
      },
      body:JSON.stringify(body)
    });
    if(!res.ok){
      const txt = await res.text().catch(()=>res.statusText);
      throw new Error("æ¥å£é”™è¯¯ï¼š" + txt);
    }
    const data = await res.json();
    const content = data.choices?.[0]?.message?.content || "";
    return content.trim();
  }

  async function ttsOnce(text){
    const key = getApiKeyOrThrow();
    const base = getBaseUrl();
    const body = {
      model: "gpt-4o-mini-tts",
      input: text,
      voice: "alloy",
      response_format: "mp3",
      speed: clamp(parseFloat(rateRange.value)||1.0,0.6,1.4)
    };
    const res = await fetch(base + "/v1/audio/speech",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${key}`,
        "Accept":"audio/mpeg"
      },
      body:JSON.stringify(body)
    });
    if(!res.ok){
      const txt = await res.text().catch(()=>res.statusText);
      throw new Error("TTS å‡ºé”™ï¼š" + txt);
    }
    const buf = await res.arrayBuffer();
    const blob = new Blob([buf],{type:"audio/mpeg"});
    return URL.createObjectURL(blob);
  }

  /* ---------- æ‡’åŠ è½½ç¿»è¯‘ & éŸ³æ ‡ï¼ˆæ¯å¥åªè°ƒç”¨ä¸€æ¬¡ï¼‰ ---------- */
  async function lazyEnsureZhAndIpa(idx){
    const s = sentences[idx];
    if(!s) return;
    const tasks = [];
    if(autoZhChk.checked && !s.zh && !s.zhLoading){
      s.zhLoading = true;
      tasks.push(
        (async ()=>{
          try{
            const zh = await callChatOnce(
              s.en,
              "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è‹±è¯‘ä¸­åŠ©æ‰‹ã€‚è¯·æŠŠç”¨æˆ·ç»™å‡ºçš„è‹±æ–‡å¥å­ç²¾å‡†ç¿»è¯‘æˆç®€ä½“ä¸­æ–‡ï¼Œè¿”å›çº¯ä¸­æ–‡ï¼Œä¸è¦åŠ è§£é‡Šã€‚"
            );
            s.zh = zh;
          }catch(e){
            console.error(e);
            s.zh = "ã€ç¿»è¯‘å¤±è´¥ï¼š" + e.message + "ã€‘";
          }finally{
            s.zhLoading = false;
          }
        })()
      );
    }
    if(autoIpaChk.checked && !s.ipa && !s.ipaLoading){
      s.ipaLoading = true;
      tasks.push(
        (async ()=>{
          try{
            const ipa = await callChatOnce(
              s.en,
              "You are a phonetics assistant. For the given English sentence, output ONLY its American English IPA transcription, without slashes or extra text."
            );
            s.ipa = ipa.replace(/^\/|\/$/g,"").trim();
          }catch(e){
            console.error(e);
            s.ipa = "IPA ç”Ÿæˆå¤±è´¥";
          }finally{
            s.ipaLoading = false;
          }
        })()
      );
    }
    if(tasks.length){
      renderSentences();
      try{await Promise.all(tasks);}catch(e){}
      renderSentences();
    }
  }

  /* ---------- æ‹†å¥ ---------- */
  splitBtn.addEventListener("click",()=>{
    const text = inputText.value.trim();
    if(!text){
      alert("è¯·å…ˆç²˜è´´è‹±æ–‡å†…å®¹æˆ–ä¸Šä¼  .docx æ–‡ä»¶ã€‚");
      return;
    }
    const arr = splitSentences(text);
    if(!arr.length){
      alert("æ²¡æœ‰æ£€æµ‹åˆ°å®Œæ•´å¥å­ï¼Œè¯·æ£€æŸ¥æ–‡æœ¬æ˜¯å¦åŒ…å«è‹±æ–‡å¥å· / é—®å· / æ„Ÿå¹å·ã€‚");
      return;
    }
    sentences = arr.map(en=>({en, zh:"", ipa:"", zhLoading:false, ipaLoading:false, audioUrl:null}));
    currentIndex = 0;
    renderSentences();
    highlightSentence(0);
    setStatus("å·²å®Œæˆæ‹†å¥ã€‚ç¿»è¯‘ & éŸ³æ ‡å°†åœ¨æœ—è¯»æˆ–ç‚¹å‡»å¯¹åº”å¥å­æ—¶æŒ‰éœ€ç”Ÿæˆã€‚");
  });

  /* ---------- æµè§ˆå™¨æœ—è¯» ---------- */
  async function ensureVoicesLoaded(timeout=2000){
    return new Promise(resolve=>{
      const have = ()=> speechSynthesis.getVoices().length>0;
      if(have()) return resolve(true);
      const id=setInterval(()=>{
        if(have()){clearInterval(id);resolve(true);}
      },150);
      setTimeout(()=>{clearInterval(id);resolve(true);},timeout);
    });
  }
  async function browserSpeakText(text){
    await ensureVoicesLoaded();
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.rate = clamp(parseFloat(rateRange.value)||1.0,0.6,1.4);
    return new Promise(res=>{
      u.onend=res;
      u.onerror=res;
      speechSynthesis.speak(u);
    });
  }

  quickBrowserBtn.addEventListener("click",async()=>{
    const text = inputText.value.trim();
    if(!text){
      alert("è¯·å…ˆç²˜è´´è‹±æ–‡å†…å®¹ã€‚");
      return;
    }
    try{
      setStatus("ä½¿ç”¨æµè§ˆå™¨æœ—è¯»æ•´æ®µä¸­â€¦");
      await browserSpeakText(text);
      setStatus("æœ—è¯»ç»“æŸã€‚");
    }catch(e){
      console.error(e);
      setStatus("æµè§ˆå™¨æœ—è¯»å¤±è´¥ï¼š" + (e.message||e));
    }
  });

  testBtn.addEventListener("click",async()=>{
    try{
      setStatus("æµ‹è¯•æµè§ˆå™¨æœ—è¯»ä¸­â€¦");
      await browserSpeakText("Hello! This is a test.");
      setStatus("æµ‹è¯•æœ—è¯»å®Œæˆã€‚");
    }catch(e){
      setStatus("æµ‹è¯•å¤±è´¥ï¼š" + (e.message||e));
    }
  });

  /* ---------- API TTS é€å¥æ’­æ”¾ + ç¼“å­˜ ---------- */
  async function playSentenceWithApi(idx){
    if(idx<0 || idx>=sentences.length) return;
    const s = sentences[idx];
    highlightSentence(idx);
    await lazyEnsureZhAndIpa(idx); // æ‡’åŠ è½½ç¿»è¯‘ & IPA

    try{
      if(!s.audioUrl){
        setStatus(`TTS ç”Ÿæˆä¸­ï¼ˆç¬¬ ${idx+1} å¥ï¼‰â€¦`);
        const url = await ttsOnce(s.en);
        s.audioUrl = url;
      }else{
        setStatus(`æ’­æ”¾ç¼“å­˜éŸ³é¢‘ï¼ˆç¬¬ ${idx+1} å¥ï¼‰ï¼Œä¸ä¼šå†æ¬¡æ¶ˆè€—é¢åº¦ã€‚`);
      }
      await playAudioUrl(s.audioUrl);
    }catch(e){
      console.error(e);
      setStatus(e.message || "TTS æ’­æ”¾å¤±è´¥");
    }
  }

  function playAudioUrl(url){
    return new Promise((resolve,reject)=>{
      audioPlayer.src = url;
      audioPlayer.playbackRate = clamp(parseFloat(rateRange.value)||1.0,0.6,1.4);
      audioPlayer.onended = ()=>resolve();
      audioPlayer.onerror = (e)=>reject(new Error("éŸ³é¢‘æ’­æ”¾å¤±è´¥"));
      audioPlayer.play().catch(reject);
    });
  }

  async function speakFrom(idx){
    if(!sentences.length){
      alert("è¿˜æ²¡æœ‰å¥å­ï¼Œè¯·å…ˆç‚¹å‡»â€œæ‹†å¥â€ã€‚");
      return;
    }
    if(idx<0 || idx>=sentences.length) idx=0;
    currentIndex = idx;
    isPlaying = true;

    if(engineSelect.value === "browser"){
      // é€å¥æµè§ˆå™¨æœ—è¯»
      for(let i=idx; i<sentences.length; i++){
        if(!isPlaying) break;
        highlightSentence(i);
        await lazyEnsureZhAndIpa(i); // æµè§ˆå™¨æœ—è¯»æ—¶ä¹Ÿæ‡’åŠ è½½ç¿»è¯‘ & IPA
        await browserSpeakText(sentences[i].en);
      }
      setStatus("æµè§ˆå™¨æœ—è¯»å®Œæˆã€‚");
      return;
    }

    // API TTS é€å¥ + ç¼“å­˜
    for(let i=idx; i<sentences.length; i++){
      if(!isPlaying) break;
      await playSentenceWithApi(i);
    }
    setStatus("æœ—è¯»å®Œæˆã€‚");
  }

  playFromCurrentBtn.addEventListener("click",()=>{
    speakFrom(currentIndex);
  });

  stopBtn.addEventListener("click",()=>{
    isPlaying = false;
    try{speechSynthesis.cancel();}catch(e){}
    try{audioPlayer.pause();}catch(e){}
    setStatus("å·²åœæ­¢æœ—è¯»ã€‚");
  });

  /* ---------- äº‹ä»¶ç»‘å®š ---------- */
  engineSelect.addEventListener("change",()=>{
    setStatus(engineSelect.value==="browser"
      ? "å½“å‰ä½¿ç”¨æµè§ˆå™¨è‡ªå¸¦è¯­éŸ³å¼•æ“ï¼ˆå®Œå…¨å…è´¹ï¼‰ã€‚"
      : "å½“å‰ä½¿ç”¨ OpenAI / APIMart TTSï¼ˆé€å¥æ‡’åŠ è½½ + ç¼“å­˜ï¼ŒåŒä¸€å¥é‡å¤æœ—è¯»ä¸ä¼šå†æ¬¡æ¶ˆè€—é¢åº¦ï¼‰ã€‚"
    );
  });

  // ç»™å¥å­åˆ—è¡¨ä¹Ÿç»‘å®šâ€œä»è¿™é‡Œå¼€å§‹æœ—è¯»â€
  sentList.addEventListener("dblclick",(e)=>{
    const row = e.target.closest(".sent-row");
    if(!row) return;
    const idx = Number(row.dataset.idx||0);
    speakFrom(idx);
  });

})();
</script>
</body>
</html>
