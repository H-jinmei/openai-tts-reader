<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>è‹±æ–‡æœ—è¯» + ä¸­è‹±åŒæ­¥ï¼ˆOpenAI / æµè§ˆå™¨ï¼‰</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --c:#2563eb;--b:#0ea5e9;
      --bg:#f8fafc;--txt:#0f172a;--muted:#64748b;
      --card:#ffffff;--border:#e5e7eb;--shadow:0 2px 6px rgba(15,23,42,.06);
      --chip-bg:#e0edff;--chip-txt:#1d4ed8;
      --accent-soft:#eef2ff;--accent-bd:#a5b4fc;--accent-txt:#4338ca;
      --green-soft:#ecfdf5;--green-bd:#6ee7b7;--green-txt:#065f46;
    }
    .dark{
      --bg:#020617;--txt:#e5e7eb;--muted:#9ca3af;
      --card:#020617;--border:#1f2937;--shadow:0 2px 14px rgba(0,0,0,.45);
      --chip-bg:#0b1120;--chip-txt:#93c5fd;
      --accent-soft:#0b1220;--accent-bd:#1d4ed8;--accent-txt:#93c5fd;
      --green-soft:#022c22;--green-bd:#0f766e;--green-txt:#a7f3d0;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--txt);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:20px 16px 40px}
    h1{
      font-size:22px;
      margin:0 0 8px;
      display:flex;
      align-items:center;
      gap:10px;
      color:var(--c);
    }
    .sub{font-size:13px;color:var(--muted);margin-bottom:16px}
    .card{
      background:var(--card);
      border-radius:16px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:14px 16px;
      margin-top:14px;
    }
    label{font-size:14px;font-weight:600}
    input,textarea,select{
      font-family:inherit;
      font-size:14px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      padding:8px 10px;
      width:100%;
      background:transparent;
      color:inherit;
    }
    textarea{min-height:150px;resize:vertical}
    small{color:var(--muted);font-size:12px}
    .flex{display:flex;align-items:center;gap:8px}
    .between{justify-content:space-between}
    .btn{
      border-radius:999px;
      border:none;
      padding:7px 14px;
      font-size:13px;
      cursor:pointer;
      background:var(--c);
      color:#fff;
      white-space:nowrap;
    }
    .btn.outline{
      background:transparent;
      color:var(--txt);
      border:1px solid #cbd5e1;
    }
    .btn.small{padding:4px 10px;font-size:11px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .toolbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:6px;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 10px;
      border-radius:999px;
      border:1px solid var(--chip-bg);
      background:var(--chip-bg);
      color:var(--chip-txt);
      font-size:12px;
    }
    .rows{
      margin-top:10px;
      max-height:60vh;
      overflow:auto;
      border-radius:12px;
      border:1px solid var(--border);
    }
    .row{
      display:grid;
      grid-template-columns:minmax(0,1.4fr) minmax(0,1.1fr);
      gap:8px;
      padding:10px 12px;
      border-bottom:1px solid rgba(148,163,184,.35);
      cursor:pointer;
    }
    .row:last-child{border-bottom:none}
    .row:hover{
      background:rgba(148,163,184,.06);
    }
    .row.active{
      background:var(--accent-soft);
      border-color:var(--accent-bd);
      color:var(--accent-txt);
    }
    .row .zh{
      display:flex;
      align-items:center;
      color:inherit;
    }
    .en-main{font-size:14px;margin-bottom:3px}
    .ipa{font-size:12px;color:var(--muted);}
    .zh-text{font-size:14px}
    .status{font-size:12px;color:var(--muted);margin-top:6px}
    .status.bad{color:#b91c1c}
    .status.good{color:#0f766e}
    .checks{
      display:flex;
      gap:20px;
      margin-top:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .checks label{
      font-weight:500;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .top-controls{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .top-controls .left,
    .top-controls .right{display:flex;gap:8px;flex-wrap:wrap}
    .chip-note{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    .api-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;align-items:center}
    .api-row select{width:auto}
    .api-row small{margin-top:0}
    @media (max-width:720px){
      .row{grid-template-columns:1fr}
    }

    /* å­¦ä¹ æ—¶é•¿ç»„ä»¶ */
    .study.card{
      margin-top:0;
      padding:8px 12px;
      max-width:480px;
    }
    .study .hdr{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:4px;
      gap:8px;
    }
    .study .title{font-weight:700;font-size:13px}
    .study .hdr-btns{
      display:flex;
      gap:6px;
      flex-shrink:0;
    }
    .study .compact{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .study .kpi{
      display:flex;
      gap:6px;
      align-items:baseline;
      background:var(--chip-bg);
      border:1px solid var(--chip-bg);
      color:var(--chip-txt);
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
    }
    .study .kpi .num{font-weight:800;font-variant-numeric:tabular-nums}
    .study .detail{display:none;margin-top:8px}
    .study.open .detail{display:block}
    .study .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .study .box{
      padding:8px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:12px;
    }
    .study .label{font-size:11px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <div>
      <h1>ğŸ§ è‹±æ–‡æœ—è¯» + ä¸­è‹±åŒæ­¥ï¼ˆOpenAI / æµè§ˆå™¨ï¼‰</h1>
      <div class="sub">æ”¯æŒæŒ‰å¥ç²¾å‡†æœ—è¯»ã€æ‡’åŠ è½½ç¿»è¯‘å’ŒéŸ³æ ‡ï¼Œå°½é‡èŠ‚çœ API é¢åº¦ã€‚</div>
    </div>
    <div class="flex" style="gap:10px;align-items:stretch">
      <button id="themeBtn" class="btn outline">ğŸŒ™ æ·±è‰²</button>
      <!-- å­¦ä¹ æ—¶é•¿ç»„ä»¶ -->
      <div id="studyWidget" class="card study">
        <div class="hdr">
          <div class="title">â± å­¦ä¹ æ—¶é•¿</div>
          <div class="hdr-btns">
            <button id="toggleTimer" class="btn outline small">æš‚åœ</button>
            <button id="toggleDetail" class="btn outline small">è¯¦æƒ…</button>
          </div>
        </div>
        <div class="compact">
          <div class="kpi"><span>æœ¬æ¬¡</span><span class="num" id="kThis">00:00:00</span></div>
          <div class="kpi"><span>æ€»è®¡</span><span class="num" id="kTotal">0å°æ—¶0åˆ†é’Ÿ</span></div>
        </div>
        <div class="detail">
          <div class="grid" style="margin-top:6px">
            <div class="box">
              <div class="label">ä»Šå¤©</div>
              <div id="kDay">0åˆ†é’Ÿ</div>
            </div>
            <div class="box">
              <div class="label">æœ¬å‘¨ï¼ˆå‘¨ä¸€-å‘¨æ—¥ï¼‰</div>
              <div id="kWeek">0åˆ†é’Ÿ</div>
            </div>
            <div class="box">
              <div class="label">æœ¬æœˆ</div>
              <div id="kMonth">0åˆ†é’Ÿ</div>
            </div>
            <div class="box">
              <div class="label">ä»Šå¹´</div>
              <div id="kYear">0åˆ†é’Ÿ</div>
            </div>
          </div>
          <div class="label">
            è¯´æ˜ï¼šåªæœ‰é¡µé¢åœ¨å‰å°ä¸”è®¡æ—¶ä¸ºâ€œå¼€å§‹â€æ—¶æ‰ä¼šç´¯ç§¯ï¼›æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨ localStorageï¼ŒæŒ‰è‡ªç„¶æ—¥è®°å½•ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- API & æœåŠ¡å•† -->
  <div class="card">
    <label for="apiKey">API Keyï¼ˆç”¨äºç¿»è¯‘ / éŸ³æ ‡ / OpenAI TTSï¼‰</label>
    <input id="apiKey" type="password" placeholder="sk-...  å¯å¡« OpenAI å®˜æ–¹ Key æˆ– APIMart ä»£ç† Keyï¼ˆä»…ä¿å­˜åœ¨æœ¬åœ°ï¼‰">
    <div class="api-row">
      <label style="font-weight:500;font-size:13px">æœåŠ¡å•†ï¼š</label>
      <select id="backend">
        <option value="openai">OpenAI å®˜æ–¹</option>
        <option value="apimart">APIMart ä»£ç†</option>
      </select>
      <small>å¦‚æœç”¨ APIMart çš„ Keyï¼Œè¯·é€‰â€œAPIMart ä»£ç†â€ï¼Œå¦åˆ™ä¼šæŠ¥ invalid_api_keyã€‚</small>
    </div>
    <button id="saveKey" class="btn outline" style="margin-top:6px">ä¿å­˜åˆ°æœ¬åœ°</button>
    <div id="saveHint" class="chip-note" style="display:none;color:#16a34a">å·²ä¿å­˜ âœ“</div>
  </div>

  <!-- è¾“å…¥åŒº -->
  <div class="card">
    <label for="inputEn">è‹±æ–‡å†…å®¹ï¼ˆç²˜è´´æˆ–ä¸Šä¼  .docxï¼‰</label>
    <textarea id="inputEn" placeholder="Paste your English text here..."></textarea>
    <div class="top-controls">
      <div class="left">
        <div class="flex">
          <input type="file" id="docx" accept=".docx">
          <span id="charCount" class="pill">0 chars</span>
        </div>
      </div>
      <div class="right checks">
        <label>
          <input type="checkbox" id="autoZh" checked>
          è‡ªåŠ¨ç¿»è¯‘ä¸­æ–‡ï¼ˆæ‡’åŠ è½½ï¼Œæ¯å¥åªç¿»ä¸€æ¬¡ï¼‰
        </label>
        <label>
          <input type="checkbox" id="autoIpa">
          æ˜¾ç¤ºç¾å¼éŸ³æ ‡ï¼ˆæ‡’åŠ è½½ï¼Œæ¯å¥åªç”Ÿæˆä¸€æ¬¡ï¼‰
        </label>
      </div>
    </div>

    <div class="top-controls" style="margin-top:10px">
      <div class="left flex">
        <label>æœ—è¯»å¼•æ“ï¼š</label>
        <select id="engine">
          <option value="browser">æµè§ˆå™¨ï¼ˆå…è´¹ï¼‰</option>
          <option value="openai">OpenAI / APIMart TTS</option>
        </select>
        <label>é€Ÿåº¦ï¼š<span id="rateVal">1.00x</span></label>
        <input id="rate" type="range" min="0.7" max="1.4" step="0.05" value="1.0">
      </div>
      <div class="right">
        <button id="splitBtn" class="btn">æ‹†å¥ï¼ˆä¸ç«‹å³ç¿»è¯‘ï¼‰</button>
        <button id="readFromCurrent" class="btn">ä»å½“å‰å¥å¼€å§‹æœ—è¯»</button>
        <button id="readAllBrowser" class="btn outline">ç›´æ¥æœ—è¯»æ•´æ®µï¼ˆæµè§ˆå™¨ï¼‰</button>
        <button id="testSpeak" class="btn outline">æµ‹è¯•æœ—è¯»ï¼ˆHelloï¼‰</button>
        <button id="stopBtn" class="btn outline">åœæ­¢</button>
      </div>
    </div>
    <div id="status" class="status"></div>
  </div>

  <!-- ä¸­è‹±å¹¶æ’åˆ—è¡¨ -->
  <div class="card">
    <div id="rowsBox" class="rows"></div>
  </div>
</div>

<script src="https://unpkg.com/mammoth@1.7.0/mammoth.browser.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function(){

  function $(id){return document.getElementById(id);}

  const apiKeyInput = $("apiKey");
  const backendSel = $("backend");
  const saveKeyBtn = $("saveKey");
  const saveHint = $("saveHint");
  const inputEn = $("inputEn");
  const docxInput = $("docx");
  const autoZhChk = $("autoZh");
  const autoIpaChk = $("autoIpa");
  const engineSel = $("engine");
  const rateRange = $("rate");
  const rateVal = $("rateVal");
  const splitBtn = $("splitBtn");
  const readFromCurrentBtn = $("readFromCurrent");
  const readAllBrowserBtn = $("readAllBrowser");
  const testSpeakBtn = $("testSpeak");
  const stopBtn = $("stopBtn");
  const rowsBox = $("rowsBox");
  const statusEl = $("status");
  const charCount = $("charCount");
  const themeBtn = $("themeBtn");

  // å­¦ä¹ æ—¶é•¿ç»„ä»¶å…ƒç´ 
  const studyCard = $("studyWidget");
  const btnDetail = $("toggleDetail");
  const btnTimer = $("toggleTimer");
  const kThis = $("kThis");
  const kTotal = $("kTotal");
  const kDay = $("kDay");
  const kWeek = $("kWeek");
  const kMonth = $("kMonth");
  const kYear = $("kYear");

  const LS_KEY = "openaitts.apiKey";
  const LS_BACKEND = "openaitts.backend";
  const LS_THEME = "openaitts.theme";
  const LS_DAILY = "openaitts.study.dailySeconds";

  // ====== æ¢å¤æœ¬åœ° Key & backend ======
  try{
    const stored = localStorage.getItem(LS_KEY);
    if(stored) apiKeyInput.value = stored;
    const b = localStorage.getItem(LS_BACKEND);
    if(b) backendSel.value = b;
  }catch(e){}

  saveKeyBtn.addEventListener("click", function(){
    try{
      localStorage.setItem(LS_KEY, apiKeyInput.value.trim());
      localStorage.setItem(LS_BACKEND, backendSel.value);
      saveHint.style.display = "block";
      setTimeout(function(){saveHint.style.display="none";},1500);
    }catch(e){
      alert("æµè§ˆå™¨ç¦æ­¢äº†æœ¬åœ°å­˜å‚¨ï¼Œæ— æ³•ä¿å­˜ Key");
    }
  });

  backendSel.addEventListener("change", function(){
    try{localStorage.setItem(LS_BACKEND, backendSel.value);}catch(e){}
  });

  // ====== ä¸»é¢˜åˆ‡æ¢ ======
  function applyTheme(t){
    if(t === "dark"){
      document.body.classList.add("dark");
      themeBtn.textContent = "â˜€ï¸ æµ…è‰²";
    }else{
      document.body.classList.remove("dark");
      themeBtn.textContent = "ğŸŒ™ æ·±è‰²";
    }
    try{localStorage.setItem(LS_THEME,t);}catch(e){}
  }
  (function initTheme(){
    let t = "light";
    try{
      const s = localStorage.getItem(LS_THEME);
      if(s) t = s;
      else if(window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches){
        t = "dark";
      }
    }catch(e){}
    applyTheme(t);
  })();
  themeBtn.addEventListener("click",function(){
    const now = document.body.classList.contains("dark") ? "dark":"light";
    applyTheme(now==="dark"?"light":"dark");
  });

  // ====== å­—æ•°ç»Ÿè®¡ ======
  function updateCharCount(){
    charCount.textContent = (inputEn.value || "").length + " chars";
  }
  ["input","change","keyup","paste"].forEach(function(ev){
    inputEn.addEventListener(ev,updateCharCount);
  });
  updateCharCount();

  // ====== å­¦ä¹ æ—¶é•¿ç»Ÿè®¡ ======
  function todayStr(d){
    d = d || new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return y+"-"+m+"-"+dd;
  }
  function getMonday(d){
    const x = new Date(d);
    const day = (x.getDay()+6)%7; // å‘¨ä¸€=0
    x.setHours(0,0,0,0);
    x.setDate(x.getDate()-day);
    return x;
  }
  function endOfWeek(d){
    const m = getMonday(d);
    const e = new Date(m);
    e.setDate(m.getDate()+6);
    return e;
  }
  function startOfMonth(d){return new Date(d.getFullYear(), d.getMonth(),1);}
  function endOfMonth(d){return new Date(d.getFullYear(), d.getMonth()+1,0);}
  function startOfYear(d){return new Date(d.getFullYear(),0,1);}
  function endOfYear(d){return new Date(d.getFullYear(),11,31);}

  function loadDaily(){
    try{
      const raw = localStorage.getItem(LS_DAILY);
      if(!raw) return {};
      const obj = JSON.parse(raw);
      return obj && typeof obj==="object" ? obj : {};
    }catch(e){return {};}
  }
  function saveDaily(map){
    try{localStorage.setItem(LS_DAILY, JSON.stringify(map));}catch(e){}
  }

  function fmtHMS(sec){
    sec = Math.max(0,Math.floor(sec));
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s = sec%60;
    const pad = n => (n<10?"0":"")+n;
    return pad(h)+":"+pad(m)+":"+pad(s);
  }
  function fmtHM(sec){
    sec = Math.max(0,Math.floor(sec));
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    return h+"å°æ—¶"+m+"åˆ†é’Ÿ";
  }
  function minutesStr(sec){
    const m = Math.round(Math.max(0,sec)/60);
    return m+"åˆ†é’Ÿ";
  }
  function sumRange(map,startDate,endDate){
    const s = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
    const e = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
    let cur = new Date(s);
    let total = 0;
    while(cur <= e){
      total += map[todayStr(cur)] || 0;
      cur.setDate(cur.getDate()+1);
    }
    return total;
  }
  function totalAll(map){
    return Object.values(map).reduce((a,b)=>a+(+b||0),0);
  }

  let daily = loadDaily();
  let sessionSeconds = 0;
  let tickTimer = null;
  let visible = document.visibilityState === "visible";
  let running = true; // è¿›å…¥é¡µé¢é»˜è®¤è®¡æ—¶

  function renderStats(){
    const now = new Date();
    kThis.textContent = fmtHMS(sessionSeconds);
    kTotal.textContent = fmtHM(totalAll(daily));
    kDay.textContent = minutesStr(daily[todayStr(now)] || 0);
    kWeek.textContent = minutesStr(sumRange(daily, getMonday(now), endOfWeek(now)));
    kMonth.textContent = minutesStr(sumRange(daily, startOfMonth(now), endOfMonth(now)));
    kYear.textContent = minutesStr(sumRange(daily, startOfYear(now), endOfYear(now)));
  }

  function tickStudy(){
    if(!visible || !running) return;
    sessionSeconds += 1;
    const key = todayStr(new Date());
    daily[key] = (daily[key] || 0) + 1;
    renderStats();
    if(sessionSeconds % 10 === 0) saveDaily(daily);
  }

  tickTimer = setInterval(tickStudy,1000);
  renderStats();

  document.addEventListener("visibilitychange",function(){
    visible = document.visibilityState === "visible";
  });
  window.addEventListener("focus",function(){visible=true;});
  window.addEventListener("blur",function(){visible=false;});
  window.addEventListener("beforeunload",function(){saveDaily(daily);});

  btnDetail.addEventListener("click",function(){
    studyCard.classList.toggle("open");
    btnDetail.textContent = studyCard.classList.contains("open") ? "æ”¶èµ·" : "è¯¦æƒ…";
  });
  btnTimer.addEventListener("click",function(){
    running = !running;
    btnTimer.textContent = running ? "æš‚åœ" : "å¼€å§‹";
  });

  // ====== æ‹†å¥ / åˆ—è¡¨ ======
  let EN = [];
  let currentIndex = 0;
  let cacheZH = {};   // sentence -> zh
  let cacheIPA = {};  // sentence -> ipa
  let cacheTTS = {};  // sentence -> objectURL
  let isSpeaking = false;
  const audio = new Audio();

  function splitSentences(txt){
    const cleaned = (txt || "").replace(/\s+/g," ").trim();
    if(!cleaned) return [];
    const arr = cleaned.split(/(?<=[.!?])\s+/);
    return arr.filter(s => s.trim().length>0);
  }

  function renderRows(){
    rowsBox.innerHTML = "";
    if(!EN.length) return;
    EN.forEach(function(sent,i){
      const row = document.createElement("div");
      row.className = "row"+(i===currentIndex?" active":"");
      row.dataset.index = i;

      const enDiv = document.createElement("div");
      const enMain = document.createElement("div");
      enMain.className = "en-main";
      enMain.textContent = sent;
      const ipaDiv = document.createElement("div");
      ipaDiv.className = "ipa";
      ipaDiv.textContent = cacheIPA[sent] ? "/"+cacheIPA[sent]+"/" : "";
      enDiv.appendChild(enMain);
      enDiv.appendChild(ipaDiv);

      const zhDiv = document.createElement("div");
      zhDiv.className = "zh";
      const zhText = document.createElement("div");
      zhText.className = "zh-text";
      zhText.textContent = cacheZH[sent] || "";
      zhDiv.appendChild(zhText);

      row.appendChild(enDiv);
      row.appendChild(zhDiv);

      row.addEventListener("click",function(){
        setActive(i);
        ensureZHAndIPA(i);
      });

      rowsBox.appendChild(row);
    });
  }

  function refreshRow(i){
    const rows = rowsBox.querySelectorAll(".row");
    if(!rows[i]) return;
    const sent = EN[i];
    const ipa = cacheIPA[sent] || "";
    const zh = cacheZH[sent] || "";
    const ipaDiv = rows[i].querySelector(".ipa");
    const zhDiv = rows[i].querySelector(".zh-text");
    ipaDiv.textContent = ipa ? "/"+ipa+"/" : "";
    zhDiv.textContent = zh;
  }

  function setActive(i){
    currentIndex = i;
    const rows = rowsBox.querySelectorAll(".row");
    rows.forEach((row,idx)=> row.classList.toggle("active",idx===i));
    const row = rows[i];
    if(row) row.scrollIntoView({behavior:"smooth",block:"center"});
  }

  splitBtn.addEventListener("click",function(){
    const txt = inputEn.value.trim();
    if(!txt){
      alert("è¯·å…ˆç²˜è´´è‹±æ–‡å†…å®¹");
      return;
    }
    EN = splitSentences(txt);
    if(!EN.length){
      alert("æœªæ£€æµ‹åˆ°å®Œæ•´å¥å­ï¼ˆè¯·æ£€æŸ¥æ˜¯å¦æœ‰å¥å·/é—®å·ç­‰ç»“æŸç¬¦ï¼‰");
      return;
    }
    currentIndex = 0;
    cacheZH = {};
    cacheIPA = {};
    cacheTTS = {};
    statusEl.classList.remove("bad","good");
    statusEl.textContent = "å·²æ‹†åˆ† "+EN.length+" å¥ã€‚ç‚¹æŸä¸€å¥æ—¶å†æ‡’åŠ è½½ç¿»è¯‘å’ŒéŸ³æ ‡ã€‚";
    renderRows();
    setActive(0);
  });

  // ====== è¯»å– .docx ======
  docxInput.addEventListener("change", function(ev){
    const f = ev.target.files && ev.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = function(e){
      const arrayBuffer = e.target.result;
      window.mammoth.extractRawText({arrayBuffer})
      .then(function(res){
        inputEn.value = res.value || "";
        updateCharCount();
      })
      .catch(function(err){
        alert("è§£æ docx å‡ºé”™ï¼š"+err);
      });
    };
    reader.readAsArrayBuffer(f);
  });

  // ====== OpenAI / APIMart é€šç”¨è°ƒç”¨ ======
  function getBaseURL(){
    return backendSel.value === "apimart"
      ? "https://api.apimart.com"
      : "https://api.openai.com";
  }
  function getHeaders(){
    const key = apiKeyInput.value.trim();
    return {
      "Content-Type":"application/json",
      "Authorization":"Bearer "+key
    };
  }
  function needAPI(){
    if(!apiKeyInput.value.trim()){
      alert("æ­¤æ“ä½œéœ€è¦ API Keyï¼Œè¯·å…ˆåœ¨é¡¶éƒ¨è¾“å…¥å¹¶ä¿å­˜ã€‚");
      return false;
    }
    return true;
  }

  async function callChat(messages){
    const base = getBaseURL();
    const res = await fetch(base+"/v1/chat/completions",{
      method:"POST",
      headers:getHeaders(),
      body:JSON.stringify({
        model:"gpt-4o-mini",
        messages:messages,
        temperature:0.2
      })
    });
    if(!res.ok){
      const t = await res.text();
      throw new Error(t);
    }
    const data = await res.json();
    const content = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content;
    return content || "";
  }

  async function ensureZHAndIPA(index){
    const text = EN[index];
    if(!text) return;
    const needZh = autoZhChk.checked && !cacheZH[text];
    const needIpa = autoIpaChk.checked && !cacheIPA[text];
    if(!needZh && !needIpa) return;
    if(!needAPI()) return;

    statusEl.classList.remove("bad","good");
    statusEl.textContent = "æ­£åœ¨ä¸ºå½“å‰å¥ç”Ÿæˆ "+(needZh?"ä¸­æ–‡ ":"")+(needIpa?"éŸ³æ ‡":"")+" â€¦";
    try{
      if(needZh){
        const zhPrompt = [
          {role:"system",content:"ä½ æ˜¯è‹±æ–‡ç¿»è¯‘åŠ©æ‰‹ã€‚åªè¾“å‡ºå¯¹åº”çš„ç®€ä½“ä¸­æ–‡ï¼Œä¸è¦ä»»ä½•è§£é‡Šã€‚"},
          {role:"user",content:text}
        ];
        const zh = await callChat(zhPrompt);
        cacheZH[text] = zh.trim();
      }
      if(needIpa){
        const ipaPrompt = [
          {role:"system",content:"ä½ æ˜¯éŸ³æ ‡åŠ©æ‰‹ã€‚è¯·ç»™å‡ºè¾“å…¥å¥å­çš„ç¾å¼ IPA éŸ³æ ‡ã€‚åªè¾“å‡ºéŸ³æ ‡ï¼Œä¸è¦å…¶å®ƒè¯´æ˜ï¼Œä¸è¦åŠ æ–œæ ã€‚"},
          {role:"user",content:text}
        ];
        const ipa = await callChat(ipaPrompt);
        cacheIPA[text] = ipa.replace(/\//g,"").trim();
      }
      refreshRow(index);
      statusEl.classList.remove("bad");
      statusEl.classList.add("good");
      statusEl.textContent = "å·²æ›´æ–°å½“å‰å¥ã€‚";
    }catch(err){
      console.error(err);
      statusEl.classList.remove("good");
      statusEl.classList.add("bad");
      statusEl.textContent = "ç”Ÿæˆå¤±è´¥ï¼š"+err.message;
    }
  }

  // ====== æµè§ˆå™¨æœ—è¯» ======
  function clamp(v,min,max){return Math.min(max,Math.max(min,v));}
  function ensureVoicesLoaded(timeout){
    timeout = timeout || 2000;
    return new Promise(function(resolve){
      function ready(){
        const voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
        return voices && voices.length>0;
      }
      if(ready()) return resolve(true);
      const id = setInterval(function(){
        if(ready()){clearInterval(id);resolve(true);}
      },150);
      setTimeout(function(){clearInterval(id);resolve(true);},timeout);
    });
  }

  async function speakBrowserFrom(start){
    if(!EN.length){
      alert("è¯·å…ˆæ‹†å¥");
      return;
    }
    await ensureVoicesLoaded();
    window.speechSynthesis.cancel();
    isSpeaking = true;
    for(let i=start;i<EN.length;i++){
      if(!isSpeaking) break;
      setActive(i);
      const utt = new SpeechSynthesisUtterance(EN[i]);
      utt.lang = "en-US";
      utt.rate = clamp(parseFloat(rateRange.value)||1,0.7,1.4);
      await new Promise(function(res){
        utt.onend = res;
        utt.onerror = res;
        speechSynthesis.speak(utt);
      });
    }
  }

  // ====== OpenAI / APIMart TTS ======
  async function ttsOnce(text){
    if(cacheTTS[text]) return cacheTTS[text];
    if(!needAPI()) throw new Error("éœ€è¦ API Key");

    const base = getBaseURL();
    const res = await fetch(base+"/v1/audio/speech",{
      method:"POST",
      headers:getHeaders(),
      body:JSON.stringify({
        model:"gpt-4o-mini-tts",
        voice:"alloy",
        input:text,
        format:"mp3"
      })
    });
    if(!res.ok){
      const t = await res.text();
      throw new Error(t);
    }
    const buf = await res.arrayBuffer();
    const url = URL.createObjectURL(new Blob([buf],{type:"audio/mpeg"}));
    cacheTTS[text] = url;
    return url;
  }

  async function speakOpenAIFrom(start){
    if(!EN.length){
      alert("è¯·å…ˆæ‹†å¥");
      return;
    }
    isSpeaking = true;
    statusEl.classList.remove("bad","good");
    for(let i=start;i<EN.length;i++){
      if(!isSpeaking) break;
      setActive(i);
      try{
        const url = await ttsOnce(EN[i]);
        audio.src = url;
        audio.playbackRate = clamp(parseFloat(rateRange.value)||1,0.7,1.4);
        await new Promise(function(res){
          audio.onended = res;
          audio.onerror = res;
          audio.play().catch(res);
        });
      }catch(err){
        console.error(err);
        statusEl.classList.add("bad");
        statusEl.textContent = "TTS å‡ºé”™ï¼š"+err.message;
        break;
      }
    }
  }

  // ====== æœ—è¯»æŒ‰é’® ======
  readFromCurrentBtn.addEventListener("click",function(){
    if(engineSel.value === "browser"){
      speakBrowserFrom(currentIndex);
    }else{
      speakOpenAIFrom(currentIndex);
    }
  });

  readAllBrowserBtn.addEventListener("click",function(){
    speakBrowserFrom(0);
  });

  testSpeakBtn.addEventListener("click",async function(){
    try{
      await ensureVoicesLoaded();
      const u = new SpeechSynthesisUtterance("Hello from your browser text to speech.");
      u.lang = "en-US";
      u.rate = clamp(parseFloat(rateRange.value)||1,0.7,1.4);
      speechSynthesis.speak(u);
    }catch(e){
      alert("æµè§ˆå™¨æœ—è¯»ä¸å¯ç”¨ï¼š"+e.message);
    }
  });

  stopBtn.addEventListener("click",function(){
    isSpeaking = false;
    if(window.speechSynthesis) speechSynthesis.cancel();
    audio.pause();
  });

  rateRange.addEventListener("input",function(){
    rateVal.textContent = (parseFloat(rateRange.value)||1).toFixed(2)+"x";
  });
  rateVal.textContent = (parseFloat(rateRange.value)||1).toFixed(2)+"x";

});
</script>
</body>
</html>
