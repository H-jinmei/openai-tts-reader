<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è‹±æ–‡æœ—è¯» + ä¸­è‹±åŒæ­¥ï¼ˆä¸‰å¼•æ“ + ç¾å¼éŸ³æ ‡ï¼‰</title>
  <style>
    :root{
      --c:#2563eb;--g:#10b981;--b:#0ea5e9;
      --bg:#f8fafc;--txt:#0f172a;--muted:#64748b;
      --card:#ffffff;--border:#e5e7eb;--shadow:0 2px 4px rgba(0,0,0,.05);
      --chip-bg:#eef2ff;--chip-txt:#3730a3;--chip-bd:#c7d2fe;
      --accent-soft:#eef2ff;--accent-bd:#a5b4fc;--accent-txt:#4338ca;
      --green-soft:#ecfdf5;--green-bd:#a7f3d0;--green-txt:#065f46;
    }
    /* æ·±è‰²æ¨¡å¼å˜é‡ */
    .dark{
      --bg:#020617;--txt:#e5e7eb;--muted:#9ca3af;
      --card:#020617;--border:#1f2937;--shadow:0 2px 10px rgba(0,0,0,.35);
      --chip-bg:#0b1120;--chip-txt:#93c5fd;--chip-bd:#1d4ed8;
      --accent-soft:#0b1220;--accent-bd:#1d4ed8;--accent-txt:#93c5fd;
      --green-soft:#022c22;--green-bd:#0d9488;--green-txt:#99f6e4;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--txt);
      margin:0;
    }
    .wrap{max-width:1100px;margin:auto;padding:24px}
    h1{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:22px;
      color:var(--c);
      margin:0 0 12px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      margin:12px 0;
      box-shadow:var(--shadow);
    }
    .row{display:grid;gap:12px}
    @media(min-width:800px){.grid-2{grid-template-columns:1fr 1fr}}
    label{font-weight:600}
    input,textarea,select{
      width:100%;
      padding:10px;
      border:1px solid #cbd5e1;
      border-radius:10px;
      font-size:14px;
      background:transparent;
      color:inherit;
    }
    textarea{min-height:140px}
    small{color:var(--muted)}
    .btn{
      background:var(--c);
      color:#fff;
      border:none;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-size:12px;
      white-space:nowrap;
    }
    .btn.outline{
      background:transparent;
      color:var(--txt);
      border:1px solid #cbd5e1;
    }
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .flex{display:flex;align-items:center;gap:10px}
    .between{justify-content:space-between}
    .pill{
      display:inline-block;
      background:var(--chip-bg);
      color:var(--chip-txt);
      border:1px solid var(--chip-bd);
      border-radius:999px;
      padding:3px 10px;
      font-size:12px;
    }
    .cols{display:grid;gap:10px}
    @media(min-width:900px){.cols{grid-template-columns:1fr 1fr}}
    .sent{
      padding:10px;
      border:1px solid transparent;
      border-radius:10px;
      cursor:pointer;
      transition:.15s;
    }
    .sent:hover{
      background:rgba(15,23,42,0.03);
      border-color:#e2e8f0;
    }
    .dark .sent:hover{
      background:rgba(148,163,184,0.1);
      border-color:#334155;
    }
    .sent.active{
      background:var(--accent-soft);
      border-color:var(--accent-bd);
      font-weight:600;
      color:var(--accent-txt);
    }
    .sent-zh.active{
      background:var(--green-soft);
      border-color:var(--green-bd);
      color:var(--green-txt);
    }
    .ipa{font-size:12px;color:#475569;margin-top:4px}
    .progress{
      height:8px;
      background:#e5e7eb;
      border-radius:999px;
      overflow:hidden;
    }
    .bar{height:100%;background:var(--b);width:0}
    .slider{width:220px}
    .note{font-size:12px;color:#0f766e}

    /* é¡¶éƒ¨å·¥å…·æ ï¼šä¸»é¢˜ + è®¡æ—¶å™¨ */
    .toolbar{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .toggle-theme{
      background:transparent;
      border:1px solid var(--border);
      color:var(--txt);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
    }

    /* å­¦ä¹ æ—¶é•¿å°ç»„ä»¶ */
    .study.card{
      margin:0;
      padding:8px 12px;
    }
    .study{
      max-width:460px;
    }
    .study .hdr{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:4px;
      gap:8px;
    }
    .study .title{font-weight:700;font-size:13px}
    .study .hdr-btns{
      display:flex;
      gap:6px;
      flex-shrink:0;
    }
    .study .hdr-btns .btn{
      padding:4px 8px;
      font-size:11px;
    }
    .study .compact{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .study .kpi{
      display:flex;
      gap:6px;
      align-items:baseline;
      background:var(--chip-bg);
      border:1px solid var(--chip-bd);
      color:var(--chip-txt);
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
    }
    .study .kpi .num{font-weight:800}
    .study .detail{display:none;margin-top:8px}
    .study.open .detail{display:block}
    .study .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .study .box{
      padding:8px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:12px;
    }
    .study .label{font-size:11px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- é¡¶éƒ¨å·¥å…·æ ï¼šä¸»é¢˜ + è®¡æ—¶å™¨ -->
    <div class="toolbar">
      <button id="themeBtn" class="toggle-theme" title="åˆ‡æ¢é»‘/ç™½æ¨¡å¼">ğŸŒ™ æ·±è‰²</button>

      <!-- å­¦ä¹ æ—¶é•¿ç»„ä»¶ -->
      <div id="studyWidget" class="card study">
        <div class="hdr">
          <div class="title">â± å­¦ä¹ æ—¶é•¿</div>
          <div class="hdr-btns">
            <button id="toggleTimer" class="btn outline">æš‚åœ</button>
            <button id="toggleDetail" class="btn outline">è¯¦æƒ…</button>
          </div>
        </div>
        <div class="compact">
          <div class="kpi"><span>æœ¬æ¬¡</span><span class="num" id="kThis">00:00:00</span></div>
          <div class="kpi"><span>æ€»è®¡</span><span class="num" id="kTotal">0å°æ—¶0åˆ†é’Ÿ</span></div>
        </div>
        <div class="detail">
          <div class="grid" style="margin-top:8px">
            <div class="box">
              <div class="label">ä»Šå¤©</div>
              <div id="kDay">0åˆ†é’Ÿ</div>
            </div>
            <div class="box">
              <div class="label">æœ¬å‘¨ï¼ˆå‘¨ä¸€-å‘¨æ—¥ï¼‰</div>
              <div id="kWeek">0åˆ†é’Ÿ</div>
            </div>
            <div class="box">
              <div class="label">æœ¬æœˆ</div>
              <div id="kMonth">0åˆ†é’Ÿ</div>
            </div>
            <div class="box">
              <div class="label">ä»Šå¹´</div>
              <div id="kYear">0åˆ†é’Ÿ</div>
            </div>
          </div>
          <div style="margin-top:8px" class="label">
            ä»…åœ¨é¡µé¢å‰å°ä¸”è®¡æ—¶ä¸ºâ€œå¼€å§‹â€æ—¶ç´¯ç§¯ï¼›æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨ localStorageï¼ˆæŒ‰è‡ªç„¶æ—¥ç´¯è®¡ï¼‰ã€‚
          </div>
        </div>
      </div>
    </div>

    <h1>ğŸ§ è‹±æ–‡æœ—è¯» + ä¸­è‹±åŒæ­¥ï¼ˆOpenAI / ElevenLabs / æµè§ˆå™¨ï¼‰</h1>

    <!-- Keys -->
    <div class="card">
      <label>OpenAI API Keyï¼ˆç”¨äºç¿»è¯‘ & ç”Ÿæˆç¾å¼éŸ³æ ‡ï¼›ä¹Ÿå¯ç”¨äº OpenAI TTSï¼‰</label>
      <div class="row">
        <input id="openaiKey" type="password" placeholder="sk-...ï¼ˆä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼‰" />
        <div class="flex between">
          <small>ä¸å¼€å¯ç¿»è¯‘/éŸ³æ ‡æˆ– OpenAI TTS æ—¶ï¼Œå¯ä»¥ä¸å¡«ã€‚æµè§ˆå™¨æœ—è¯»ä¸æ¶ˆè€—é¢åº¦ã€‚</small>
          <button id="saveKeys" class="btn outline">ä¿å­˜è®¾ç½®</button>
        </div>
        <div id="saveHint" style="display:none;color:#16a34a;font-size:12px">å·²ä¿å­˜åˆ°æœ¬åœ° âœ“</div>
      </div>
    </div>

    <div class="card">
      <div class="row grid-2">
        <div>
          <label>ElevenLabs API Keyï¼ˆå¯ç”¨ ElevenLabs æ¨¡å¼æ—¶å¿…å¡«ï¼‰</label>
          <input id="xiKey" type="password" placeholder="xi-...ï¼ˆä»…æœ¬åœ°ä¿å­˜ï¼‰" />
        </div>
        <div>
          <label>ElevenLabs Voice IDï¼ˆç¤ºä¾‹ï¼šRachel â†’ 21m00Tcm4TlvDq8ikWAMï¼‰</label>
          <input id="xiVoice" placeholder="21m00Tcm4TlvDq8ikWAM" value="21m00Tcm4TlvDq8ikWAM" />
        </div>
      </div>
      <div class="flex between">
        <small>æç¤ºï¼šè¯·ç¡®ä¿ Key ä»¥ xi- å¼€å¤´ï¼ŒVoice ID ä¸è¦åŠ å¼•å·ã€‚</small>
        <button id="clearKeys" class="btn outline">æ¸…é™¤æœ¬åœ°å¯†é’¥</button>
      </div>
    </div>

    <!-- Input & engine -->
    <div class="card">
      <label>è‹±æ–‡å†…å®¹ï¼ˆç²˜è´´æˆ–ä¸Šä¼  .docxï¼‰</label>
      <textarea id="inputEn" placeholder="Paste your English text here..."></textarea>
      <div class="flex between">
        <div class="flex">
          <input type="file" id="docx" accept=".docx" />
          <span id="charCount" class="pill">0 chars</span>
        </div>
        <div class="flex" style="gap:16px">
          <label class="flex" style="gap:6px;align-items:center">
            <span>è‡ªåŠ¨ç¿»è¯‘ä¸­æ–‡</span>
            <input id="translateChk" type="checkbox" checked />
          </label>
          <label class="flex" style="gap:6px;align-items:center">
            <span>æ˜¾ç¤ºç¾å¼éŸ³æ ‡</span>
            <input id="ipaChk" type="checkbox" />
          </label>
        </div>
      </div>
      <div class="flex between" style="margin-top:10px">
        <div class="flex">
          <label>æœ—è¯»å¼•æ“ï¼š</label>
          <select id="engine">
            <option value="browser">æµè§ˆå™¨ï¼ˆå…è´¹ï¼‰</option>
            <option value="openai">OpenAI TTS</option>
            <option value="eleven">ElevenLabs</option>
          </select>
        </div>
        <div class="flex">
          <label>é€Ÿåº¦ï¼š<span id="rateVal">1.00x</span></label>
          <input id="rate" class="slider" type="range" min="0.6" max="1.4" step="0.05" value="1.0" />
        </div>
      </div>
      <div class="flex" style="margin-top:10px;flex-wrap:wrap;gap:10px">
        <button id="prep" class="btn">æ‹†å¥ & ç¿»è¯‘éŸ³æ ‡</button>
        <button id="playFromCurrent" class="btn">ä»å½“å‰å¥å¼€å§‹æœ—è¯»</button>
        <button id="quickSpeak" class="btn outline">ç›´æ¥æœ—è¯»æ•´æ®µï¼ˆæµè§ˆå™¨ï¼‰</button>
        <button id="testSpeak" class="btn outline">æµ‹è¯•æœ—è¯»ï¼ˆHelloï¼‰</button>
        <button id="stop" class="btn outline">åœæ­¢</button>
      </div>
      <div id="status" style="margin-top:8px;color:#334155"></div>
      <div class="progress" style="margin-top:8px;display:none">
        <div class="bar" id="bar"></div>
      </div>
      <div id="diag" class="note" style="display:none;margin-top:8px"></div>
    </div>

    <!-- Parallel view -->
    <div class="card">
      <div class="cols" style="max-height:60vh;overflow:auto">
        <div id="enCol"></div>
        <div id="zhCol"></div>
      </div>
    </div>
  </div>

  <audio id="player"></audio>

  <script src="https://unpkg.com/mammoth@1.7.0/mammoth.browser.min.js"></script>
  <script>
    const $ = id => document.getElementById(id);
    const openaiKeyEl=$("openaiKey");
    const xiKeyEl=$("xiKey");
    const xiVoiceEl=$("xiVoice");
    const inputEn=$("inputEn");
    const docx=$("docx");
    const translateChk=$("translateChk");
    const ipaChk=$("ipaChk");
    const engine=$("engine");
    const rate=$("rate");
    const rateVal=$("rateVal");
    const prep=$("prep");
    const playFromCurrent=$("playFromCurrent");
    const quickSpeak=$("quickSpeak");
    const testSpeak=$("testSpeak");
    const stopBtn=$("stop");
    const statusEl=$("status");
    const enCol=$("enCol");
    const zhCol=$("zhCol");
    const player=$("player");
    const bar=$("bar");
    const progressWrap=document.querySelector(".progress");
    const charCount=$("charCount");
    const diag=$("diag");

    const themeBtn = $("themeBtn");

    const studyCard = $("studyWidget");
    const btnDetail = $("toggleDetail");
    const btnTimer = $("toggleTimer");
    const kThis = $("kThis");
    const kTotal = $("kTotal");
    const kDay = $("kDay");
    const kWeek = $("kWeek");
    const kMonth = $("kMonth");
    const kYear = $("kYear");

    const LS_KEYS = {
      OPENAI:"openaiKey",
      XI:"xiKey",
      XIVOICE:"xiVoice",
      THEME:"study:theme",
      DAILY:"study:dailySeconds"   // { "YYYY-MM-DD": seconds }
    };

    // è¯»å–å¯†é’¥
    try{
      openaiKeyEl.value=localStorage.getItem(LS_KEYS.OPENAI)||"";
      xiKeyEl.value=localStorage.getItem(LS_KEYS.XI)||"";
      xiVoiceEl.value=localStorage.getItem(LS_KEYS.XIVOICE)||xiVoiceEl.value;
    }catch(e){console.warn("localStorage ä¸å¯ç”¨ï¼š",e);}

    $("saveKeys").addEventListener("click",()=>{
      try{
        const ok=openaiKeyEl.value.trim().replace(/^["']|["']$/g,"");
        const xk=xiKeyEl.value.trim().replace(/^["']|["']$/g,"");
        const xv=xiVoiceEl.value.trim().replace(/^["']|["']$/g,"");
        localStorage.setItem(LS_KEYS.OPENAI,ok);
        localStorage.setItem(LS_KEYS.XI,xk);
        localStorage.setItem(LS_KEYS.XIVOICE,xv);
        openaiKeyEl.value=ok; xiKeyEl.value=xk; xiVoiceEl.value=xv;
        const hint=$("saveHint");
        hint.style.display="block";
        setTimeout(()=>hint.style.display="none",1600);
      }catch(e){ alert("æ— æ³•ä¿å­˜ï¼šæµè§ˆå™¨ç¦æ­¢äº†æœ¬åœ°å­˜å‚¨æˆ–å¤„äºéšç§æ¨¡å¼"); }
    });
    $("clearKeys").addEventListener("click",()=>{
      try{
        localStorage.removeItem(LS_KEYS.OPENAI);
        localStorage.removeItem(LS_KEYS.XI);
        localStorage.removeItem(LS_KEYS.XIVOICE);
        openaiKeyEl.value=""; xiKeyEl.value="";
        const hint=$("saveHint");
        hint.textContent="å·²æ¸…é™¤æœ¬åœ°å¯†é’¥";
        hint.style.display="block";
        setTimeout(()=>{
          hint.textContent="å·²ä¿å­˜åˆ°æœ¬åœ° âœ“";
          hint.style.display="none";
        },1600);
      }catch(e){ alert("æ¸…é™¤å¤±è´¥ï¼š"+e); }
    });

    // ä¸»é¢˜åˆ‡æ¢
    function applyTheme(theme){
      document.body.classList.toggle("dark", theme==="dark");
      themeBtn.textContent = theme==="dark" ? "â˜€ï¸ æµ…è‰²" : "ğŸŒ™ æ·±è‰²";
      localStorage.setItem(LS_KEYS.THEME, theme);
    }
    (function initTheme(){
      const saved = localStorage.getItem(LS_KEYS.THEME);
      const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
      const theme = saved || (prefersDark ? "dark" : "light");
      applyTheme(theme);
    })();
    themeBtn.addEventListener("click",()=>{
      const current = document.body.classList.contains("dark") ? "dark" : "light";
      applyTheme(current==="dark" ? "light" : "dark");
    });

    // å·¥å…·å‡½æ•°
    const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
    function updateCount(){ charCount.textContent=(inputEn.value||"").length+" chars"; }
    ["input","change","keyup","paste"].forEach(ev=> inputEn.addEventListener(ev,updateCount));
    updateCount();
    rate.addEventListener("input",()=>{rateVal.textContent=Number(rate.value).toFixed(2)+"x";});

    function showDiag(msg){ diag.textContent=msg; diag.style.display="block"; }
    function hideDiag(){ diag.style.display="none"; diag.textContent=""; }

    function ensureVoicesLoaded(timeout=2000){
      return new Promise((resolve)=>{
        const have=()=> speechSynthesis.getVoices().length>0;
        if(have()) return resolve(true);
        const id=setInterval(()=>{
          if(have()){clearInterval(id); resolve(true);}
        },150);
        setTimeout(()=>{clearInterval(id); resolve(true);},timeout);
      });
    }

    // æ‹†å¥ & æ¸²æŸ“
    let EN=[], ZH=[], PH=[], currentIndex=0, isSpeaking=false;

    function splitSentences(txt){
      const cleaned=(txt||"").replace(/\s+/g," ").trim();
      if(!cleaned) return [];
      return cleaned.split(/(?<=[.!?])\s+/).filter(Boolean);
    }

    // è¡Œé«˜å¯¹é½ï¼šä¸­è‹±æ¯ä¸€è¡ŒåŒé«˜
    function syncRowHeights() {
      const ens = enCol.children;
      const zhs = zhCol.children;
      const n = Math.min(ens.length, zhs.length);
      for (let i = 0; i < n; i++) {
        ens[i].style.minHeight = "";
        zhs[i].style.minHeight = "";
      }
      for (let i = 0; i < n; i++) {
        const h = Math.max(ens[i].offsetHeight, zhs[i].offsetHeight);
        ens[i].style.minHeight = h + "px";
        zhs[i].style.minHeight = h + "px";
      }
    }

    function renderCols(){
      enCol.innerHTML=""; zhCol.innerHTML="";
      EN.forEach((s,i)=>{
        const d=document.createElement("div");
        d.className="sent"+(i===currentIndex?" active":"");
        const ipa = PH[i] ? `<div class="ipa">/${PH[i]}/</div>` : "";
        d.innerHTML = `<div>${s}</div>${ipa}`;
        d.dataset.idx=i;
        d.onclick=()=>{highlight(i); speakFrom(i);};
        enCol.appendChild(d);

        const z=document.createElement("div");
        z.className="sent sent-zh"+(i===currentIndex?" active":"");
        z.textContent=ZH[i]||"";
        zhCol.appendChild(z);
      });

      requestAnimationFrame(syncRowHeights);
    }

    function highlight(i){
      currentIndex=i;
      [...enCol.children].forEach((el,idx)=> el.classList.toggle("active",idx===i));
      [...zhCol.children].forEach((el,idx)=> el.classList.toggle("active",idx===i));
      enCol.children[i]?.scrollIntoView({behavior:"smooth",block:"center"});
      zhCol.children[i]?.scrollIntoView({behavior:"smooth",block:"center"});
      // æ¯æ¬¡é«˜äº®æ”¹å˜åé‡æ–°åŒæ­¥è¡Œé«˜ï¼Œé˜²æ­¢åé¢é”™ä½
      requestAnimationFrame(syncRowHeights);
    }

    // è¯»å– docx
    docx.addEventListener("change",async(e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      const buf=await f.arrayBuffer();
      const {value}=await window.mammoth.extractRawText({arrayBuffer:buf});
      inputEn.value=value.trim(); updateCount();
    });

    // === ç¿»è¯‘ï¼ˆå¸¦ id æ˜ å°„ï¼Œé˜²æ­¢é”™ä½ï¼‰ ===
    async function translateBySentence(arr){
      const n = arr.length;
      if(!translateChk.checked) return new Array(n).fill("");
      const key=openaiKeyEl.value.trim();
      if(!key){
        alert("å¼€å¯äº†è‡ªåŠ¨ç¿»è¯‘ï¼Œè¯·å…ˆå¡«å†™ OpenAI Keyï¼Œæˆ–å…ˆå…³æ‰è‡ªåŠ¨ç¿»è¯‘");
        return new Array(n).fill("");
      }
      statusEl.textContent="æ­£åœ¨é€å¥ç¿»è¯‘â€¦"; hideDiag();

      const items = arr.map((text,id)=>({id,text}));
      const payload = {
        model:"gpt-4o-mini",
        messages:[
          {
            role:"system",
            content:
              "You are a translation engine. Input is JSON {\"items\":[{\"id\":number,\"text\":string}...]}. " +
              "You MUST reply ONLY with JSON of the form {\"items\":[{\"id\":number,\"zh\":string}...]}. " +
              "For each input item, keep the same id and translate text into Simplified Chinese. " +
              "Do not merge, split, drop or reorder ids. No commentary."
          },
          { role:"user", content: JSON.stringify({items}) }
        ],
        temperature:0,
        response_format:{ type:"json_object" }
      };

      try{
        const res = await fetch("https://api.openai.com/v1/chat/completions",{
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":`Bearer ${key}`
          },
          body:JSON.stringify(payload)
        });
        if(!res.ok){
          statusEl.textContent="ç¿»è¯‘å¤±è´¥";
          const txt = await res.text();
          showDiag("ç¿»è¯‘é”™è¯¯ï¼š"+txt);
          return new Array(n).fill("");
        }
        const data = await res.json();
        const raw = data.choices?.[0]?.message?.content || "{}";
        let obj={};
        try{ obj = JSON.parse(raw); }catch(e){}
        const list = Array.isArray(obj.items) ? obj.items : [];
        const map = {};
        list.forEach(it=>{
          if(typeof it.id==="number"){
            const zh = it.zh ?? it.translation ?? it.cn ?? "";
            map[it.id] = String(zh);
          }
        });
        return arr.map((_,i)=> map[i] || "");
      }catch(e){
        statusEl.textContent="ç¿»è¯‘å¤±è´¥";
        showDiag("ç¿»è¯‘å¼‚å¸¸ï¼š"+(e?.message||e));
        return new Array(n).fill("");
      }finally{
        statusEl.textContent="";
      }
    }

    // === IPAï¼ˆå¸¦ id æ˜ å°„ï¼Œé˜²æ­¢é”™ä½ï¼‰ ===
    async function ipaBySentence(arr){
      const n = arr.length;
      if(!ipaChk.checked) return new Array(n).fill("");
      const key=openaiKeyEl.value.trim();
      if(!key){
        alert("æ˜¾ç¤ºç¾å¼éŸ³æ ‡éœ€è¦ OpenAI Keyï¼ˆæˆ–å…ˆå…³é—­â€œæ˜¾ç¤ºç¾å¼éŸ³æ ‡â€ï¼‰");
        return new Array(n).fill("");
      }
      statusEl.textContent="æ­£åœ¨ç”Ÿæˆç¾å¼éŸ³æ ‡â€¦"; hideDiag();

      const items = arr.map((text,id)=>({id,text}));
      const payload = {
        model:"gpt-4o-mini",
        messages:[
          {
            role:"system",
            content:
              "You are an American English phonetics assistant. Input is JSON {\"items\":[{\"id\":number,\"text\":string}...]}. " +
              "You MUST reply ONLY with JSON {\"items\":[{\"id\":number,\"ipa\":string}...]}. " +
              "For each input item, keep the same id and output the American IPA transcription of text. " +
              "Do not merge, split, drop or reorder ids. Do NOT include slashes around the transcription. No commentary."
          },
          { role:"user", content: JSON.stringify({items}) }
        ],
        temperature:0,
        response_format:{ type:"json_object" }
      };

      try{
        const res = await fetch("https://api.openai.com/v1/chat/completions",{
          method:"POST",
          headers:{
            "Content-Type":"application/json",
            "Authorization":`Bearer ${key}`
          },
          body:JSON.stringify(payload)
        });
        if(!res.ok){
          statusEl.textContent="éŸ³æ ‡ç”Ÿæˆå¤±è´¥";
          const txt = await res.text();
          showDiag("éŸ³æ ‡é”™è¯¯ï¼š"+txt);
          return new Array(n).fill("");
        }
        const data = await res.json();
        const raw = data.choices?.[0]?.message?.content || "{}";
        let obj={};
        try{ obj = JSON.parse(raw); }catch(e){}
        const list = Array.isArray(obj.items) ? obj.items : [];
        const map = {};
        list.forEach(it=>{
          if(typeof it.id==="number"){
            const ipa = it.ipa ?? "";
            map[it.id] = String(ipa);
          }
        });
        return arr.map((_,i)=> map[i] || "");
      }catch(e){
        statusEl.textContent="éŸ³æ ‡ç”Ÿæˆå¤±è´¥";
        showDiag("éŸ³æ ‡å¼‚å¸¸ï¼š"+(e?.message||e));
        return new Array(n).fill("");
      }finally{
        statusEl.textContent="";
      }
    }

    // é¢„å¤„ç†
    prep.addEventListener("click",async()=>{
      const txt=inputEn.value.trim();
      if(!txt){ alert("è¯·å…ˆç²˜è´´è‹±æ–‡å†…å®¹"); return; }
      EN=splitSentences(txt);
      if(EN.length===0){
        alert("æ²¡æœ‰æ£€æµ‹åˆ°å®Œæ•´å¥å­ï¼ˆè¯·æ£€æŸ¥è‹±æ–‡å¥å°¾æ˜¯å¦æœ‰ . ? !ï¼‰");
        return;
      }
      ZH=new Array(EN.length).fill("");
      PH=new Array(EN.length).fill("");
      currentIndex=0;
      renderCols(); highlight(0);
      try{
        ZH=await translateBySentence(EN);
        PH=await ipaBySentence(EN);
        renderCols(); highlight(0);
      }catch(e){console.error(e);}
    });

    // æœ—è¯»ç›¸å…³
    async function speakFrom(start){
      const eng=engine.value;
      if(eng==="browser" && EN.length===0){
        const text=inputEn.value.trim();
        if(!text){ alert("è¯·å…ˆç²˜è´´è‹±æ–‡å†…å®¹"); return; }
        await ensureVoicesLoaded();
        speechSynthesis.cancel();
        const u=new SpeechSynthesisUtterance(text);
        u.lang="en-US"; u.rate=clamp(parseFloat(rate.value),0.6,1.4);
        u.onerror=e=>console.warn("æµè§ˆå™¨æœ—è¯»é”™è¯¯",e);
        speechSynthesis.speak(u);
        return;
      }
      if(!EN.length){
        alert("è¿˜æ²¡æœ‰å¥å­å¯è¯»ï¼Œè¯·å…ˆâ€œæ‹†å¥ & ç¿»è¯‘éŸ³æ ‡â€");
        return;
      }
      if(eng!=="browser"){
        if(eng==="openai" && !openaiKeyEl.value.trim()) return alert("OpenAI æ¨¡å¼éœ€è¦ OpenAI Key");
        if(eng==="eleven" && !xiKeyEl.value.trim()) return alert("ElevenLabs æ¨¡å¼éœ€è¦ ElevenLabs Key");
      }
      isSpeaking=true;
      showProgress(eng!=="browser");
      try{
        if(eng==="browser") await speakBrowserFrom(start);
        else if(eng==="openai") await speakOpenAIFrom(start);
        else await speakElevenFrom(start);
      }catch(err){
        alert("æœ—è¯»å‡ºé”™ï¼š"+(err?.message||err));
      }finally{
        isSpeaking=false;
        showProgress(false);
      }
    }

    async function speakBrowserFrom(start){
      await ensureVoicesLoaded();
      speechSynthesis.cancel();
      for(let i=start;i<EN.length;i++){
        highlight(i);
        const u=new SpeechSynthesisUtterance(EN[i]);
        u.lang="en-US"; u.rate=clamp(parseFloat(rate.value),0.6,1.4);
        await new Promise(res=>{
          u.onend=res; u.onerror=res;
          speechSynthesis.speak(u);
        });
        if(!isSpeaking) break;
      }
    }

    async function speakOpenAIFrom(start){
      const key=openaiKeyEl.value.trim();
      for(let i=start;i<EN.length;i++){
        highlight(i);
        const url=await openaiTts(EN[i],key);
        await play(url);
        setBar(((i-start+1)/(EN.length-start))*100);
        if(!isSpeaking) break;
      }
    }
    async function openaiTts(text,key){
      const res=await fetch("https://api.openai.com/v1/audio/speech",{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":`Bearer ${key}`
        },
        body:JSON.stringify({
          model:"gpt-4o-mini-tts",
          voice:"alloy",
          input:text,
          format:"mp3"
        })
      });
      if(!res.ok) throw new Error(await res.text());
      const buf=await res.arrayBuffer();
      return URL.createObjectURL(new Blob([buf],{type:"audio/mpeg"}));
    }

    async function speakElevenFrom(start){
      const key=xiKeyEl.value.trim();
      const vid=xiVoiceEl.value.trim();
      for(let i=start;i<EN.length;i++){
        highlight(i);
        const url=await elevenTts(EN[i],key,vid);
        await play(url);
        setBar(((i-start+1)/(EN.length-start))*100);
        if(!isSpeaking) break;
      }
    }
    async function elevenTts(text,key,voiceId){
      const url=`https://api.elevenlabs.io/v1/text-to-speech/${encodeURIComponent(voiceId)}`;
      const res=await fetch(url,{
        method:"POST",
        headers:{
          "xi-api-key":key,
          "Content-Type":"application/json",
          "accept":"audio/mpeg"
        },
        body:JSON.stringify({
          text,
          model_id:"eleven_turbo_v2",
          voice_settings:{stability:0.5,similarity_boost:0.8}
        })
      });
      if(!res.ok) throw new Error(await res.text());
      const buf=await res.arrayBuffer();
      return URL.createObjectURL(new Blob([buf],{type:"audio/mpeg"}));
    }

    function play(url){
      return new Promise((resolve,reject)=>{
        player.src=url;
        player.playbackRate=clamp(parseFloat(rate.value),0.6,1.4);
        player.onended=()=>resolve();
        player.onerror=e=>reject(e);
        player.play().catch(reject);
      });
    }

    stopBtn.addEventListener("click",()=>{
      isSpeaking=false;
      speechSynthesis?.cancel?.();
      player.pause();
    });
    function showProgress(v){
      progressWrap.style.display=v?"block":"none";
      if(!v) setBar(0);
    }
    function setBar(p){ bar.style.width=p+"%"; }

    playFromCurrent.addEventListener("click",()=> speakFrom(currentIndex));
    quickSpeak.addEventListener("click",()=>{
      engine.value="browser";
      speakFrom(0);
    });
    testSpeak.addEventListener("click", async ()=>{
      try{
        await ensureVoicesLoaded();
        speechSynthesis.cancel();
        const u=new SpeechSynthesisUtterance("Hello from your browser! Testing testing.");
        u.lang="en-US"; u.rate=clamp(parseFloat(rate.value),0.6,1.4);
        speechSynthesis.speak(u);
      }catch(e){
        alert("æµ‹è¯•æœ—è¯»å¤±è´¥ï¼š"+(e?.message||e));
      }
    });

    // ==== å­¦ä¹ æ—¶é•¿ç»Ÿè®¡ ====
    function todayStr(d=new Date()){
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,"0");
      const dd=String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    }
    function getMonday(d){
      const x=new Date(d);
      const day=(x.getDay()+6)%7; // å‘¨ä¸€=0
      x.setHours(0,0,0,0);
      x.setDate(x.getDate()-day);
      return x;
    }
    function endOfWeek(d){
      const m=getMonday(d);
      const e=new Date(m);
      e.setDate(m.getDate()+6);
      return e;
    }
    function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
    function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
    function startOfYear(d){ return new Date(d.getFullYear(),0,1); }
    function endOfYear(d){ return new Date(d.getFullYear(),11,31); }

    function loadDaily(){
      try{
        const raw=localStorage.getItem(LS_KEYS.DAILY);
        if(!raw) return {};
        const obj=JSON.parse(raw);
        return obj && typeof obj==="object" ? obj : {};
      }catch{ return {}; }
    }
    function saveDaily(map){
      try{ localStorage.setItem(LS_KEYS.DAILY, JSON.stringify(map)); }
      catch(e){ console.warn("ä¿å­˜ç»Ÿè®¡å¤±è´¥",e); }
    }

    function fmtHMS(sec){
      sec=Math.max(0,Math.floor(sec));
      const h=Math.floor(sec/3600);
      const m=Math.floor((sec%3600)/60);
      const s=sec%60;
      return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }
    function fmtHMfromSec(sec){
      sec=Math.max(0,Math.floor(sec));
      const h=Math.floor(sec/3600);
      const m=Math.floor((sec%3600)/60);
      return `${h}å°æ—¶${m}åˆ†é’Ÿ`;
    }
    function minutesStr(sec){
      const m=Math.round(sec/60);
      return `${m}åˆ†é’Ÿ`;
    }

    let daily = loadDaily();
    let sessionSeconds = 0;
    let tickTimer = null;
    let visible = document.visibilityState === "visible";
    let running = true;

    function sumRange(startDate,endDate){
      const s=new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
      const e=new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
      let cur=new Date(s);
      let total=0;
      while(cur<=e){
        total += (daily[todayStr(cur)]||0);
        cur.setDate(cur.getDate()+1);
      }
      return total;
    }
    function totalAll(){
      return Object.values(daily).reduce((a,b)=>a+(+b||0),0);
    }

    function renderStats(){
      const now=new Date();
      kThis.textContent = fmtHMS(sessionSeconds);
      kTotal.textContent = fmtHMfromSec(totalAll());
      kDay.textContent = minutesStr(daily[todayStr(now)]||0);
      kWeek.textContent = minutesStr(sumRange(getMonday(now), endOfWeek(now)));
      kMonth.textContent = minutesStr(sumRange(startOfMonth(now), endOfMonth(now)));
      kYear.textContent = minutesStr(sumRange(startOfYear(now), endOfYear(now)));
    }

    function tick(){
      if(!visible || !running) return;
      sessionSeconds += 1;
      const key=todayStr(new Date());
      daily[key]=(daily[key]||0)+1;
    }

    function setRunning(on){
      running = on;
      btnTimer.textContent = on ? "æš‚åœ" : "å¼€å§‹";
    }

    function startCounting(){
      if(tickTimer) clearInterval(tickTimer);
      tickTimer=setInterval(()=>{
        tick();
        if(sessionSeconds % 2 === 0) renderStats();
        if(sessionSeconds % 10 === 0) saveDaily(daily);
      },1000);
      renderStats();
    }

    document.addEventListener("visibilitychange",()=>{
      visible = document.visibilityState === "visible";
    });
    window.addEventListener("focus",()=>{ visible=true; });
    window.addEventListener("blur",()=>{ visible=false; });
    window.addEventListener("beforeunload",()=>{ saveDaily(daily); });

    btnDetail.addEventListener("click",()=>{
      studyCard.classList.toggle("open");
      btnDetail.textContent = studyCard.classList.contains("open") ? "æ”¶èµ·" : "è¯¦æƒ…";
    });

    btnTimer.addEventListener("click",()=>{
      setRunning(!running);
    });

    // çª—å£å°ºå¯¸å˜åŒ–æ—¶ï¼Œé‡æ–°å¯¹é½ä¸­è‹±æ–‡è¡Œé«˜
    window.addEventListener("resize", () => {
      requestAnimationFrame(syncRowHeights);
    });

    // é»˜è®¤è¿›å…¥é¡µé¢å°±å¼€å§‹è®¡æ—¶
    setRunning(true);
    startCounting();
  </script>
</body>
</html>
