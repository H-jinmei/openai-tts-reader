import React, { useEffect, useMemo, useRef, useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Switch } from "@/components/ui/switch";
import { Progress } from "@/components/ui/progress";
import { Upload, Mic, Play, Square, Volume2, FileText, Wand2, Languages } from "lucide-react";
import mammoth from "mammoth"; // docx -> text

/**
 * ğŸ”Š OpenAI æ–‡æ¡£æœ—è¯» + è‡ªåŠ¨ç¿»è¯‘ï¼ˆå‰ç«¯ç½‘é¡µå°ç¨‹åºï¼‰
 * - ç²˜è´´è‹±æ–‡æ–‡æœ¬æˆ–ä¸Šä¼  .docx è‹±æ–‡æ–‡æ¡£
 * - ä¸€é”®è°ƒç”¨ OpenAI TTSï¼ˆgpt-4o-mini-ttsï¼‰ç”Ÿæˆè¯­éŸ³å¹¶æ’­æ”¾
 * - å¯é€‰ï¼šè‡ªåŠ¨ç¿»è¯‘æˆä¸­æ–‡ï¼Œå±•ç¤ºåœ¨ä¸‹æ–¹
 * - çº¯å‰ç«¯æ¼”ç¤ºç‰ˆï¼šå¯åœ¨æœ¬åœ°æˆ–é™æ€ç«™ç‚¹éƒ¨ç½²ï¼ˆæ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒè¯·èµ°åç«¯ä»£ç†ï¼Œå‹¿æš´éœ² API Keyï¼‰
 */

// â€”â€” å¯æ ¹æ®éœ€è¦è°ƒæ•´ â€”â€”
const TTS_MODEL = "gpt-4o-mini-tts"; // è¯­éŸ³åˆæˆæ¨¡å‹
const CHAT_MODEL = "gpt-4o-mini";    // æ–‡æœ¬ç¿»è¯‘/æ¶¦è‰²æ¨¡å‹
const DEFAULT_VOICE = "alloy";        // å¯é€‰ï¼šalloy | verse | luna | shimmer | coral
const MAX_CHARS = 4000;               // å•æ¬¡åˆæˆå»ºè®®å­—ç¬¦ä¸Šé™ï¼ˆé¿å…è¶…é•¿å¯¼è‡´å¤±è´¥ï¼‰               // å•æ¬¡åˆæˆå»ºè®®å­—ç¬¦ä¸Šé™ï¼ˆé¿å…è¶…é•¿å¯¼è‡´å¤±è´¥ï¼‰

export default function OpenAITTSApp() {
  const [apiKey, setApiKey] = useState("");
  const [mode, setMode] = useState<"paste" | "file">("paste");
  const [text, setText] = useState("");
  const [voice, setVoice] = useState<string>(DEFAULT_VOICE);
  const [autoTranslate, setAutoTranslate] = useState<boolean>(true);
  const [translation, setTranslation] = useState<string>("");
  const [isGenerating, setIsGenerating] = useState(false);
  const [progress, setProgress] = useState(0);
  const [audioUrls, setAudioUrls] = useState<string[]>([]); // å¤šæ®µéŸ³é¢‘çš„ URL åˆ—è¡¨
  const audioRef = useRef<HTMLAudioElement | null>(null);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [statusText, setStatusText] = useState("");
  const [useFreeTTS, setUseFreeTTS] = useState(false); // ä¸èµ°é¢åº¦ï¼šä½¿ç”¨æµè§ˆå™¨å†…ç½®æœ—è¯»

  useEffect(() => {
    const saved = localStorage.getItem("openai_api_key");
    if (saved) setApiKey(saved);
  }, []);

  useEffect(() => {
    if (apiKey) localStorage.setItem("openai_api_key", apiKey);
  }, [apiKey]);

  useEffect(() => {
    // è‡ªåŠ¨è¿æ’­ï¼šå½“å‰éŸ³é¢‘ç»“æŸåæ’­æ”¾ä¸‹ä¸€æ®µ
    const el = audioRef.current;
    if (!el) return;
    const onEnded = () => {
      if (currentIndex < audioUrls.length - 1) {
        setCurrentIndex((i) => i + 1);
      }
    };
    el.addEventListener("ended", onEnded);
    return () => el.removeEventListener("ended", onEnded);
  }, [audioUrls, currentIndex]);

  useEffect(() => {
    // åˆ‡æ¢éŸ³é¢‘æºåè‡ªåŠ¨æ’­æ”¾
    if (audioRef.current && audioUrls[currentIndex]) {
      audioRef.current.src = audioUrls[currentIndex];
      audioRef.current.play().catch(() => {});
    }
  }, [currentIndex, audioUrls]);

  const chunks = useMemo(() => chunkText(text, MAX_CHARS), [text]);

  async function handleFile(e: React.ChangeEvent<HTMLInputElement>) {
    const file = e.target.files?.[0];
    if (!file) return;
    if (!file.name.toLowerCase().endsWith(".docx")) {
      alert("è¯·ä¸Šä¼  .docx è‹±æ–‡æ–‡ä»¶");
      return;
    }
    const arrayBuffer = await file.arrayBuffer();
    const { value } = await mammoth.extractRawText({ arrayBuffer });
    setText(value.trim());
    setMode("paste");
  }

  async function translateToChinese(src: string): Promise<string> {
    try {
      setStatusText("æ­£åœ¨ç¿»è¯‘æˆä¸­æ–‡â€¦");
      const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
          model: CHAT_MODEL,
          messages: [
            {
              role: "system",
              content:
                "You are a professional translator. Translate the user\'s English text into natural, fluent Simplified Chinese. Keep meaning accurate. Preserve numbers and names. Do not add commentary.",
            },
            { role: "user", content: src },
          ],
          temperature: 0.2,
        }),
      });
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      return data.choices?.[0]?.message?.content?.trim?.() ?? "";
    } catch (e: any) {
      console.error(e);
      alert("ç¿»è¯‘å¤±è´¥ï¼š" + (e?.message || e));
      return "";
    } finally {
      setStatusText("");
    }
  }

  async function ttsOneChunk(chunk: string): Promise<Blob> {
    const body = {
      model: TTS_MODEL,
      voice,
      input: chunk,
      format: "mp3",
    } as const;

    const res = await fetch("https://api.openai.com/v1/audio/speech", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${apiKey}`,
      },
      body: JSON.stringify(body),
    });
    if (!res.ok) {
      const t = await res.text();
      // é¢åº¦ä¸è¶³ç­‰é”™è¯¯æ—¶ï¼ŒæŠŠä¿¡æ¯æŠ›å‡ºå»ï¼Œå¤–å±‚å¯å›é€€åˆ°å…è´¹æœ—è¯»
      try {
        const j = JSON.parse(t);
        if (j?.error?.code === "insufficient_quota" || j?.error?.type === "insufficient_quota") {
          throw new Error("é¢åº¦ä¸è¶³ï¼ˆinsufficient_quotaï¼‰ï¼šè¯·åœ¨ Billing é‡Œæ·»åŠ ä»˜æ¬¾æ–¹å¼æˆ–æé«˜ Monthly budgetï¼Œæˆ–åˆ‡æ¢â€œä½¿ç”¨æµè§ˆå™¨å…è´¹æœ—è¯»â€ã€‚");
        }
        throw new Error(j?.error?.message || t);
      } catch (_) {
        throw new Error(t);
      }
    }
    const arrayBuffer = await res.arrayBuffer();
    return new Blob([arrayBuffer], { type: "audio/mpeg" });
  }
  // å…è´¹æœ—è¯»ï¼ˆä¸æ¶ˆè€— OpenAI é¢åº¦ï¼‰ï¼ŒéŸ³è´¨ä¸€èˆ¬ä½†å¤Ÿç”¨
  function freeSpeak(text: string) {
    if (!("speechSynthesis" in window)) {
      throw new Error("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå†…ç½®æœ—è¯»ï¼ˆspeechSynthesisï¼‰ã€‚è¯·ä½¿ç”¨ Chrome/Edge/Safari è¯•è¯•ã€‚");
    }
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "en-US";
    u.rate = 1.0; // è¯­é€Ÿï¼š0.1~10
    u.pitch = 1.0; // éŸ³é«˜ï¼š0~2
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }

  async function handleGenerate() {
    if (!useFreeTTS && !apiKey) {
      alert("è¯·å…ˆå¡«å…¥ OpenAI API Keyï¼ˆæˆ–å¼€å¯â€˜ä½¿ç”¨æµè§ˆå™¨å…è´¹æœ—è¯»â€™ï¼‰");
      return;
    }
    if (!text.trim()) {
      alert("è¯·å…ˆç²˜è´´è‹±æ–‡å†…å®¹æˆ–ä¸Šä¼ æ–‡æ¡£");
      return;
    }

    setIsGenerating(true);
    setAudioUrls([]);
    setCurrentIndex(0);
    setProgress(0);
    setTranslation("");

    try {
      // 1) å¯é€‰ï¼šè‡ªåŠ¨ç¿»è¯‘
      if (autoTranslate) {
        const zh = await translateToChinese(text);
        setTranslation(zh);
      }

      // å¦‚æœé€‰æ‹©å…è´¹æœ—è¯»ï¼Œç›´æ¥ç”¨æµè§ˆå™¨æ’­æ”¾å¹¶ç»“æŸ
      if (useFreeTTS) {
        setStatusText("ä½¿ç”¨æµè§ˆå™¨å†…ç½®æœ—è¯»ä¸­ï¼ˆä¸æ¶ˆè€—é¢åº¦ï¼‰â€¦");
        freeSpeak(text);
        setIsGenerating(false);
        return;
      }

      // 2) æ–‡æœ¬åˆ†æ®µå¹¶é€æ®µåˆæˆ
      const blobs: Blob[] = [];
      for (let i = 0; i < chunks.length; i++) {
        setStatusText(`æ­£åœ¨åˆæˆè¯­éŸ³ï¼ˆ${i + 1}/${chunks.length}ï¼‰â€¦`);
        const b = await ttsOneChunk(chunks[i]);
        blobs.push(b);
        setProgress(Math.round(((i + 1) / chunks.length) * 100));
      }

      // 3) ç”Ÿæˆå¯æ’­æ”¾é“¾æ¥ï¼ˆæ¯æ®µä¸€ä¸ªï¼‰
      const urls = blobs.map((b) => URL.createObjectURL(b));
      setAudioUrls(urls);
      setStatusText("åˆæˆå®Œæˆï¼Œå¯ä»¥æ’­æ”¾æˆ–é€æ®µä¸‹è½½");
    } catch (e: any) {
      console.error(e);
      alert("ç”Ÿæˆå¤±è´¥ï¼š" + (e?.message || e));
    } finally {
      setIsGenerating(false);
    }
  }

  function handleStop() {
    audioRef.current?.pause();
  }

  function handlePlayAll() {
    if (audioUrls.length === 0) return;
    setCurrentIndex(0);
    if (audioRef.current) {
      audioRef.current.src = audioUrls[0];
      audioRef.current.play().catch(() => {});
    }
  }

  function handleDownload(index: number) {
    const url = audioUrls[index];
    const a = document.createElement("a");
    a.href = url;
    a.download = `tts_part_${index + 1}.mp3`;
    a.click();
  }

  return (
    <div className="min-h-screen w-full bg-gradient-to-b from-slate-50 to-white text-slate-800">
      <div className="mx-auto max-w-5xl p-6 space-y-6">
        <header className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <Volume2 className="h-8 w-8 text-indigo-600" />
            <h1 className="text-2xl md:text-3xl font-semibold">OpenAI æ–‡æ¡£æœ—è¯» + è‡ªåŠ¨ç¿»è¯‘</h1>
          </div>
        </header>

        <Card className="shadow-sm border-slate-200">
          <CardHeader>
            <CardTitle className="text-xl">1) å¡«å†™ OpenAI API Key</CardTitle>
          </CardHeader>
          <CardContent className="space-y-3">
            <div className="grid gap-2">
              <Label htmlFor="api">OpenAI API Key</Label>
              <Input
                id="api"
                type="password"
                placeholder="sk-...ï¼ˆä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼‰"
                value={apiKey}
                onChange={(e) => setApiKey(e.target.value.trim())}
              />
              <p className="text-xs text-slate-500">æç¤ºï¼šæ¼”ç¤ºç”¨é€”å¯ç›´æ¥åœ¨æ­¤ç²˜è´´ Keyï¼›ç”Ÿäº§ç¯å¢ƒè¯·é€šè¿‡åç«¯ä»£ç†ï¼Œé¿å…åœ¨å‰ç«¯æš´éœ²å¯†é’¥ã€‚</p>
            </div>
          </CardContent>
        </Card>

        <Card className="shadow-sm border-slate-200">
          <CardHeader>
            <CardTitle className="text-xl">2) å¯¼å…¥æˆ–ç²˜è´´è‹±æ–‡å†…å®¹</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <Tabs value={mode} onValueChange={(v) => setMode(v as any)}>
              <TabsList className="grid grid-cols-2 w-full">
                <TabsTrigger value="paste">ç²˜è´´æ–‡æœ¬</TabsTrigger>
                <TabsTrigger value="file">ä¸Šä¼  .docx æ–‡ä»¶</TabsTrigger>
              </TabsList>
              <TabsContent value="paste" className="space-y-3">
                <Textarea
                  value={text}
                  onChange={(e) => setText(e.target.value)}
                  placeholder="æŠŠä½ çš„è‹±æ–‡å†…å®¹ç²˜è´´åˆ°è¿™é‡Œâ€¦"
                  className="min-h-[200px]"
                />
                <div className="text-xs text-slate-500 flex items-center gap-2">
                  <FileText className="w-4 h-4" /> å½“å‰å­—æ•°ï¼š{text.length}ï¼ˆå°†è‡ªåŠ¨æŒ‰ ~{MAX_CHARS} å­—åˆ†æ®µï¼‰
                </div>
              </TabsContent>
              <TabsContent value="file" className="space-y-3">
                <Label htmlFor="docx" className="flex items-center gap-2 cursor-pointer w-full p-6 border-2 border-dashed rounded-2xl hover:bg-slate-50">
                  <Upload className="w-5 h-5" /> ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  .docxï¼ˆè‹±æ–‡æ–‡ä»¶ï¼‰
                </Label>
                <Input id="docx" type="file" accept=".docx" className="hidden" onChange={handleFile} />
              </TabsContent>
            </Tabs>
          </CardContent>
        </Card>

        <Card className="shadow-sm border-slate-200">
          <CardHeader>
            <CardTitle className="text-xl">3) æœ—è¯»è®¾ç½®</CardTitle>
          </CardHeader>
          <CardContent className="grid md:grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label>é€‰æ‹©å£°éŸ³</Label>
              <Select value={voice} onValueChange={setVoice}>
                <SelectTrigger>
                  <SelectValue placeholder="é€‰æ‹©ä¸€ä¸ªå£°éŸ³" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="alloy">Alloyï¼ˆæ¸©æš–è‡ªç„¶ï¼‰</SelectItem>
                  <SelectItem value="luna">Lunaï¼ˆæŸ”å’Œå¥³å£°ï¼‰</SelectItem>
                  <SelectItem value="verse">Verseï¼ˆèŠ‚å¥é²œæ˜ï¼‰</SelectItem>
                  <SelectItem value="shimmer">Shimmerï¼ˆè½»å¿«å¹´è½»ï¼‰</SelectItem>
                  <SelectItem value="coral">Coralï¼ˆä½æ²‰ç¨³é‡ï¼‰</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div className=\"flex items-center justify-between rounded-xl border p-4\">
              <div className=\"flex items-center gap-3\">
                <Languages className=\"w-5 h-5 text-indigo-600\" />
                <div>
                  <div className=\"font-medium\">è‡ªåŠ¨ç¿»è¯‘æˆä¸­æ–‡</div>
                  <div className=\"text-xs text-slate-500\">ç”Ÿæˆè¯­éŸ³å‰ï¼Œå…ˆæŠŠè‹±æ–‡å…¨æ–‡ç¿»æˆç®€ä½“ä¸­æ–‡å¹¶å±•ç¤º</div>
                </div>
              </div>
              <Switch checked={autoTranslate} onCheckedChange={setAutoTranslate} />
            </div>

            <div className=\"flex items-center justify-between rounded-xl border p-4\">
              <div className=\"flex items-center gap-3\">
                <Volume2 className=\"w-5 h-5 text-green-600\" />
                <div>
                  <div className=\"font-medium\">ä½¿ç”¨æµè§ˆå™¨å…è´¹æœ—è¯»ï¼ˆä¸æ¶ˆè€—é¢åº¦ï¼‰</div>
                  <div className=\"text-xs text-slate-500\">ä¸å¼€å¯ OpenAI TTS æ—¶ï¼Œæ”¹ç”¨æµè§ˆå™¨å†…ç½®è¯­éŸ³ï¼ŒéŸ³è´¨ä¸€èˆ¬ä½†è¶³å¤Ÿé¢„å¬</div>
                </div>
              </div>
              <Switch checked={useFreeTTS} onCheckedChange={setUseFreeTTS} />
            </div>
          </CardContent>
        </Card>

        <Card className="shadow-sm border-slate-200">
          <CardHeader>
            <CardTitle className="text-xl">4) ä¸€é”®æœ—è¯» & ç¿»è¯‘</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="flex flex-wrap gap-3">
              <Button onClick={handleGenerate} disabled={isGenerating || !text.trim() || !apiKey}>
                <Mic className="w-4 h-4 mr-2" /> {isGenerating ? "åˆæˆä¸­â€¦" : "ç”Ÿæˆè¯­éŸ³"}
              </Button>
              <Button variant="secondary" onClick={handlePlayAll} disabled={audioUrls.length === 0}>
                <Play className="w-4 h-4 mr-2" /> ä»å¤´æ’­æ”¾
              </Button>
              <Button variant="outline" onClick={handleStop} disabled={!audioRef.current}>
                <Square className="w-4 h-4 mr-2" /> åœæ­¢æ’­æ”¾
              </Button>
            </div>

            {isGenerating && (
              <div className="space-y-2">
                <Progress value={progress} />
                <div className="text-sm text-slate-600">{statusText}</div>
              </div>
            )}

            {audioUrls.length > 0 && (
              <div className="space-y-4">
                <audio ref={audioRef} controls className="w-full" />
                <div className="space-y-2">
                  <div className="text-sm font-medium text-slate-600">åˆ†æ®µéŸ³é¢‘ï¼ˆè‡ªåŠ¨è¿æ’­ï¼‰ï¼š</div>
                  <div className="grid gap-2">
                    {audioUrls.map((u, i) => (
                      <div key={i} className={`flex items-center justify-between rounded-lg border p-3 ${i === currentIndex ? "border-indigo-500 bg-indigo-50" : "border-slate-200"}`}>
                        <div className="text-sm">ç¬¬ {i + 1} æ®µ</div>
                        <div className="flex items-center gap-2">
                          <Button size="sm" variant={i === currentIndex ? "default" : "secondary"} onClick={() => setCurrentIndex(i)}>
                            <Play className="w-4 h-4 mr-1" /> æ’­æ”¾
                          </Button>
                          <Button size="sm" variant="outline" onClick={() => handleDownload(i)}>ä¸‹è½½ MP3</Button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {autoTranslate && (
              <div className="space-y-2">
                <div className="flex items-center gap-2 text-slate-700">
                  <Wand2 className="w-4 h-4" /> <span className="font-medium">ä¸­æ–‡è¯‘æ–‡</span>
                </div>
                <Textarea readOnly value={translation} className="min-h-[160px] bg-slate-50" />
              </div>
            )}

            <div className="text-xs text-slate-500 leading-5">
              ğŸ“Œ æç¤ºï¼šä¸ºä¿è¯æˆåŠŸç‡ï¼Œæœ¬å·¥å…·ä¼šæŠŠè¶…é•¿æ–‡æœ¬æŒ‰çº¦ {MAX_CHARS} å­—åˆ†æ®µé€æ®µåˆæˆå¹¶è‡ªåŠ¨è¿æ’­ï¼›å¦‚éœ€å¯¼å‡ºä¸º**å•ä¸ªæ–‡ä»¶**ï¼Œå»ºè®®åœ¨ç”µè„‘ç«¯ä½¿ç”¨éŸ³é¢‘ç¼–è¾‘å™¨ï¼ˆå¦‚ Audacityï¼‰å°†å¤šæ®µ MP3 åˆå¹¶ã€‚
            </div>
          </CardContent>
        </Card>

        <footer className="text-center text-xs text-slate-400 py-6">
          Made for ğŸ“£ NY Speak Easy Â· æœ¬é¡µä»…ä½œæœ¬åœ°/æ¼”ç¤ºç”¨é€”ã€‚å¦‚éœ€ä¸Šçº¿ï¼Œè¯·ä½¿ç”¨æœåŠ¡å™¨ä»£ç† OpenAI API å¹¶å¦¥å–„ä¿ç®¡å¯†é’¥ã€‚
        </footer>
      </div>
    </div>
  );
}

// â€”â€” å·¥å…·å‡½æ•° â€”â€”
function chunkText(input: string, maxChars: number): string[] {
  const text = input.trim();
  if (!text) return [];
  if (text.length <= maxChars) return [text];

  const sentences = text
    .replace(/\n+/g, " ")
    .split(/(?<=[.!?])\s+/);

  const chunks: string[] = [];
  let current = "";

  for (const s of sentences) {
    if ((current + (current ? " " : "") + s).length <= maxChars) {
      current = current ? current + " " + s : s;
    } else {
      if (current) chunks.push(current);
      if (s.length > maxChars) {
        // å¼ºæ‹†é•¿å¥
        for (let i = 0; i < s.length; i += maxChars) {
          chunks.push(s.slice(i, i + maxChars));
        }
        current = "";
      } else {
        current = s;
      }
    }
  }
  if (current) chunks.push(current);
  return chunks;
}
